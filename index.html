<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0f766e">
    <link rel="manifest" href="./manifest.webmanifest">
    <link rel="icon" href="./icon.svg" type="image/svg+xml">
    <title>FuelMate</title>
    <link rel="stylesheet" href="./app.css">
    <link rel="stylesheet" href="./material-icons/material-icons.css">
    <style>
        :root {
            --safe-top: env(safe-area-inset-top, 20px);
            --safe-bottom: env(safe-area-inset-bottom, 20px);
            --bg-main: #f8fafc;
            --bg-card: #ffffff;
            --text-heading: #0f172a;
            --text-sub: #64748b;
            --border-color: #e2e8f0;
        }
        @media (prefers-color-scheme: dark) {
            :root {
                --bg-main: #0f172a;
                --bg-card: #1e293b;
                --text-heading: #f1f5f9;
                --text-sub: #94a3b8;
                --border-color: #334155;
            }
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-main);
            color: var(--text-heading);
            -webkit-tap-highlight-color: transparent;
            padding-bottom: calc(100px + var(--safe-bottom));
            overscroll-behavior-y: none; 
        }
        .pt-safe { padding-top: calc(var(--safe-top) + 20px); } 
        .pb-safe { padding-bottom: calc(100px + var(--safe-bottom)); }
        .nav-safe { padding-bottom: calc(var(--safe-bottom) + 12px); }
        
        /* Dynamic Gradients based on Car Color */
        .grad-teal { background: linear-gradient(135deg, #0f766e 0%, #0d9488 100%); }
        .grad-blue { background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%); }
        .grad-red { background: linear-gradient(135deg, #991b1b 0%, #ef4444 100%); }
        .grad-black { background: linear-gradient(135deg, #000000 0%, #374151 100%); }
        .grad-white { background: linear-gradient(135deg, #94a3b8 0%, #cbd5e1 100%); color: #0f172a; }
        .grad-yellow { background: linear-gradient(135deg, #ca8a04 0%, #eab308 100%); }
        .grad-purple { background: linear-gradient(135deg, #6b21a8 0%, #a855f7 100%); }
        .grad-green { background: linear-gradient(135deg, #166534 0%, #22c55e 100%); }
        .grad-orange { background: linear-gradient(135deg, #c2410c 0%, #f97316 100%); }
        .grad-brown { background: linear-gradient(135deg, #451a03 0%, #78350f 100%); }
        .grad-grey { background: linear-gradient(135deg, #374151 0%, #6b7280 100%); }
        .grad-pink { background: linear-gradient(135deg, #be185d 0%, #ec4899 100%); }
        .grad-cyan { background: linear-gradient(135deg, #0e7490 0%, #06b6d4 100%); }

        .card-shadow { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03); }
        .glass-nav { 
            background: rgba(255, 255, 255, 0.9); 
            backdrop-filter: blur(10px); 
            border-top: 1px solid var(--border-color);
        }
        @media (prefers-color-scheme: dark) {
            .glass-nav { background: rgba(30, 41, 59, 0.9); border-top: 1px solid #334155; }
        }
        /* Hide scrollbar but allow scroll */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .theme-bg-card { background-color: var(--bg-card); }
        .theme-text-heading { color: var(--text-heading); }
        .theme-text-sub { color: var(--text-sub); }
        .theme-border { border-color: var(--border-color); }
        
        input, select, textarea {
            background-color: var(--bg-main);
            color: var(--text-heading);
            border: 1px solid var(--border-color);
        }
        /* Color Picker Radio */
        .color-radio:checked + div { ring: 2px solid white; box-shadow: 0 0 0 4px currentColor; }
    </style>
    <!-- Dynamic Icon Generator -->
    <script>
        (function() {
            const canvas = document.createElement('canvas');
            canvas.width = 1024;
            canvas.height = 1024;
            const ctx = canvas.getContext('2d');
            
            // Background
            const grad = ctx.createLinearGradient(0, 0, 1024, 1024);
            grad.addColorStop(0, '#0ea5e9'); // Sky Blue
            grad.addColorStop(1, '#0284c7'); // Darker Blue
            ctx.fillStyle = grad;
            ctx.fillRect(0, 0, 1024, 1024);

            // Icon - Material Design Local Gas Station Path
            ctx.fillStyle = '#FFFFFF';
            ctx.save();
            ctx.translate(150, 150); // Center slightly
            ctx.scale(30, 30); // Scale up the 24px path
            const p = new Path2D("M19.77 7.23l.01-.01-3.72-3.72L15 4.56l2.11 2.11c-.94.36-1.61 1.26-1.61 2.33 0 1.38 1.12 2.5 2.5 2.5.36 0 .69-.08 1-.21v7.21c0 .55-.45 1-1 1s-1-.45-1-1V14c0-1.1-.9-2-2-2h-1V5c0-1.1-.9-2-2-2H6c-1.1 0-2 .9-2 2v16h10v-7.5h1.5v5c0 1.38 1.12 2.5 2.5 2.5s2.5-1.12 2.5-2.5V9c0-.69-.28-1.32-.73-1.77zM12 10H6V5h6v5zm6 0c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1z");
            ctx.fill(p);
            ctx.restore();

            const url = canvas.toDataURL('image/png');
            const link = document.createElement('link');
            link.rel = 'apple-touch-icon';
            link.href = url;
            document.head.appendChild(link);
        })();
    </script>
</head>
<body>
    <div id="app" class="pb-safe min-h-screen"></div>

    <!-- Modals Overlay -->
    <div id="modal-overlay" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden z-50 flex items-end sm:items-center justify-center p-0 sm:p-4 opacity-0 transition-opacity duration-200" onclick="ui.closeModal()">
        <div id="modal-content" class="bg-white dark:bg-slate-900 w-full max-w-lg rounded-t-3xl sm:rounded-3xl p-6 transform translate-y-full sm:translate-y-0 transition-transform duration-300 shadow-2xl max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
            <!-- Dynamic Content -->
        </div>
    </div>

    <script>
        // --- TRANSLATIONS ---
        const translations = {
            en: {
                dashboard: 'Dashboard', fuel: 'Fuel', maintenance: 'Maintenance', analytics: 'Analytics', settings: 'Settings', parking: 'Park',
                welcome: 'Welcome', add_vehicle: 'Add Vehicle', select_vehicle: 'Select Vehicle',
                range_month: 'This Month', range_year: 'This Year', range_all: 'All Time',
                efficiency: 'Efficiency', cost_km: 'Cost/km', total_cost: 'Total Cost', total_dist: 'Total Distance',
                add_fuel: 'Add Fuel', add_service: 'Add Service', edit_vehicle: 'Edit Vehicle',
                date: 'Date', odometer: 'Odometer', liters: 'Liters', gallons: 'Gallons', cost: 'Cost', price_unit: 'Price/Unit', location: 'Location', notes: 'Notes',
                detect_loc: 'Detect Location', save: 'Save', cancel: 'Cancel', delete: 'Delete',
                service_type: 'Service Type', service: 'Service', repair: 'Repair', parking_fee: 'Parking Fee', traffic_fine: 'Traffic Fine',
                tire_replace: 'Tire Replacement',
                tire_rotation: 'Tire Rotation',
                license: 'License Renewal', insurance: 'Insurance Renewal', registration: 'Vehicle Registration',
                periodic_maintenance: 'Periodic Maintenance', car_wash: 'Car Wash', car_accessories: 'Accessories',
                tire_positions: 'Tire Positions',
                tire_pos: 'Position',
                tire_front_left: 'Front Left', tire_front_right: 'Front Right', tire_rear_left: 'Rear Left', tire_rear_right: 'Rear Right',
                tire_brand: 'Brand/Model',
                tire_swap: 'Swap Positions',
                tire_swap_a: 'From',
                tire_swap_b: 'To',
                next_tire_change: 'Next Tire Change',
                tire_not_set: 'Not set',
                due_in: 'Due in',
                overdue: 'Overdue',
                tire_interval_dist: 'Tire Interval (Distance)',
                tire_interval_time: 'Tire Interval (Years)',
                license_expiry: 'License Expiry', insurance_expiry: 'Insurance Expiry', expiring_soon: 'Expiring in', expired: 'Expired',
                reminders: 'Reminders', reminder_settings: 'Reminder Settings',
                reminder_center: 'Reminder Center',
                view_all: 'View All',
                snooze_7d: 'Snooze 7d',
                mark_done: 'Done',
                export_json: 'Backup Data (JSON)', import_json: 'Restore Data (JSON)', export_csv: 'Export Excel (CSV)',
                clear_history: 'Clear Vehicle History', delete_vehicle: 'Delete Vehicle',
                confirm_delete: 'Are you sure you want to delete this record?',
                confirm_clear: 'WARNING: This will delete ALL logs for this vehicle. Are you sure?',
                confirm_clear_2: 'Double Check: This cannot be undone. Delete everything?',
                import_warn: 'WARNING: This will overwrite your current data. Continue?',
                units: 'Units', currency: 'Currency', language: 'Language',
                metric: 'Metric (L, km)', imperial: 'Imperial (Gal, mi)',
                success_import: 'Data imported successfully!', err_file: 'Invalid file format',
                partial_tank: 'Partial Tank / Missed Fill-up',
                partial: 'Partial',
                full: 'Full',
                common_services: 'Common Services', oil_change: 'Oil Change', tire_change: 'Tire Change', tire_rotation: 'Tire Rotation', alignment: 'Wheel Alignment', air_filter: 'Air Filter', cabin_filter: 'Cabin Filter', spark_plugs: 'Spark Plugs', brake_fluid: 'Brake Fluid', transmission_fluid: 'Transmission Fluid', coolant: 'Coolant', wiper_blades: 'Wiper Blades', battery: 'Battery', brake: 'Brakes', inspection: 'Inspection',
                fine_types: 'Fine Types', parking_ticket: 'Parking Ticket', no_parking: 'No Parking', speeding: 'Speeding', red_light: 'Red Light', illegal_turn: 'Illegal Turn', bus_lane: 'Bus Lane', seatbelt: 'Seat Belt', phone_use: 'Phone Use', toll: 'Toll / Fee',
                service_interval: 'Service Interval', int_none: 'None', int_5k: '5,000 km', int_10k: '10,000 km', int_6m: '6 Months', int_1yr: '1 Year',
                service_interval_dist: 'Interval (Distance)', service_interval_time: 'Interval (Time)',
                due_service: 'Service Due', due_in: 'Due in',
                export_calendar: 'Add to Calendar', select_export: 'Select Item to Export',
                reminder_time: 'Reminder Time', rem_none: 'None', rem_day: 'On Day', rem_1w: '1 Week Before', rem_1m: '1 Month Before',
                color: 'Color', type: 'Type',
                col_teal: 'Teal', col_blue: 'Blue', col_red: 'Red', col_black: 'Black', col_white: 'White', col_yellow: 'Yellow', col_purple: 'Purple', col_green: 'Green', col_orange: 'Orange', col_brown: 'Brown', col_grey: 'Grey', col_pink: 'Pink', col_cyan: 'Cyan',
                type_sedan: 'Sedan', type_suv: 'SUV', type_bike: 'Motorcycle', type_truck: 'Truck', type_sports: 'Sports Car', type_van: 'Van', type_bus: 'Bus',
                about: 'About FuelMate', app_desc: 'A complete PWA for vehicle tracking.',
                backup_needed: 'Backup Needed', backup_desc: 'You haven\'t backed up in 30 days.', backup_now: 'Backup Now', backup_later: 'Later',
                trip_dist: 'Trip Distance', total_odo: 'Total Odometer', input_mode: 'Input Mode',
                monthly_spend: 'Monthly Spending',
                kwh: 'kWh'
            },
            zh: {
                dashboard: '首頁', fuel: '加油', maintenance: '維修', analytics: '統計', settings: '設定', parking: '停車',
                welcome: '歡迎使用', add_vehicle: '新增車輛', select_vehicle: '切換車輛',
                range_month: '本月', range_year: '今年', range_all: '全部',
                efficiency: '油耗表現', cost_km: '每公里成本', total_cost: '總支出', total_dist: '總里程',
                add_fuel: '新增加油', add_service: '新增維修', edit_vehicle: '編輯車輛',
                date: '日期', odometer: '里程', liters: '升數', gallons: '加侖', cost: '金額', price_unit: '單價', location: '地點', notes: '備註',
                detect_loc: '定位', save: '保存', cancel: '取消', delete: '刪除',
                service_type: '維修類型', service: '一般維修', repair: '故障維修', parking_fee: '停車費', traffic_fine: '罰單/告票',
                tire_replace: '更換輪胎',
                tire_rotation: '輪胎換位',
                license: '車牌續期', insurance: '保險續期', registration: '車輛登記',
                periodic_maintenance: '定期保養', car_wash: '洗車', car_accessories: '汽車用品',
                tire_positions: '輪胎位置',
                tire_pos: '位置',
                tire_front_left: '左前', tire_front_right: '右前', tire_rear_left: '左後', tire_rear_right: '右後',
                tire_brand: '品牌/型號',
                tire_swap: '交換位置',
                tire_swap_a: '由',
                tire_swap_b: '到',
                next_tire_change: '下次換胎',
                tire_not_set: '未設定',
                due_in: '剩餘',
                overdue: '已到期',
                tire_interval_dist: '換胎間隔（里程）',
                tire_interval_time: '換胎間隔（年）',
                license_expiry: '車牌到期', insurance_expiry: '保險到期', expiring_soon: '剩餘', expired: '已過期',
                reminders: '提醒通知', reminder_settings: '提醒設定',
                reminder_center: '提醒中心',
                view_all: '查看全部',
                snooze_7d: '延後 7 天',
                mark_done: '完成',
                export_json: '匯出資料 (JSON)', import_json: '匯入資料 (JSON)', export_csv: '匯出 Excel (CSV)',
                clear_history: '清除所有紀錄', delete_vehicle: '刪除車輛',
                confirm_delete: '確定要刪除此記錄嗎？',
                confirm_clear: '警告：這將刪除此車輛的所有記錄。確定嗎？',
                confirm_clear_2: '再次確認：刪除後無法恢復。確定要清空嗎？',
                import_warn: '警告：這將覆蓋您當前的所有資料。是否繼續？',
                units: '單位', currency: '貨幣', language: '語言',
                metric: '公制 (L, km)', imperial: '英制 (Gal, mi)',
                success_import: '資料匯入成功！', err_file: '文件格式錯誤',
                partial_tank: '未加滿 / 漏記 (不計算油耗)',
                partial: '未加滿',
                full: '加滿',
                common_services: '常用項目', oil_change: '換機油', tire_change: '換輪胎', tire_rotation: '輪胎換位', alignment: '四輪定位', air_filter: '更換空氣濾芯', cabin_filter: '更換冷氣濾芯', spark_plugs: '更換火咀', brake_fluid: '更換煞車油', transmission_fluid: '更換波箱油', coolant: '更換冷卻液', wiper_blades: '更換雨刷', battery: '換電池', brake: '煞車皮', inspection: '年檢',
                fine_types: '罰單類型', parking_ticket: '違例泊車', no_parking: '禁止停車', speeding: '超速', red_light: '衝紅燈', illegal_turn: '違規轉彎', bus_lane: '巴士線', seatbelt: '安全帶', phone_use: '使用手機', toll: '道路收費/費用',
                service_interval: '保養間隔', int_none: '關閉', int_5k: '5,000 km', int_10k: '10,000 km', int_6m: '6 個月', int_1yr: '1 年',
                service_interval_dist: '保養間隔 (里程)', service_interval_time: '保養間隔 (時間)',
                due_service: '即將保養', due_in: '剩餘',
                export_calendar: '加入日曆', select_export: '選擇導出項目',
                reminder_time: '提醒時間', rem_none: '無', rem_day: '當天', rem_1w: '1 週前', rem_1m: '1 個月前',
                color: '顏色', type: '車型',
                col_teal: '青色', col_blue: '藍色', col_red: '紅色', col_black: '黑色', col_white: '白色', col_yellow: '黃色', col_purple: '紫色', col_green: '綠色', col_orange: '橘色', col_brown: '棕色', col_grey: '灰色', col_pink: '粉紅', col_cyan: '湖水綠',
                type_sedan: '房車', type_suv: '休旅車', type_bike: '機車', type_truck: '貨車', type_sports: '跑車', type_van: '廂型車', type_bus: '巴士',
                about: '關於 FuelMate', app_desc: '全功能車輛開支追蹤 PWA。',
                backup_needed: '備份提醒', backup_desc: '您已經超過 30 天沒有備份資料了。', backup_now: '立即備份', backup_later: '稍後',
                trip_dist: '行駛距離', total_odo: '總里程', input_mode: '輸入模式',
                monthly_spend: '每月支出',
                kwh: '度電 (kWh)'
            }
        };

        // --- INDEXEDDB STORE ---
        const store = {
            db: null,
            dbName: 'FuelMateDB',
            defaultSettings: { currency: '$', units: 'metric', language: 'en', maintenanceDist: 'none', maintenanceTime: 'none', tireReplaceDist: 40000, tireReplaceYears: 4, reminders: {}, reminderCenter: { snoozedUntil: {}, done: {} }, lastBackupDate: null, activeVehicleId: null },
            data: { vehicles: [], logs: [], settings: { currency: '$', units: 'metric', language: 'en', maintenanceDist: 'none', maintenanceTime: 'none', tireReplaceDist: 40000, tireReplaceYears: 4, reminders: {}, reminderCenter: { snoozedUntil: {}, done: {} }, lastBackupDate: null, activeVehicleId: null } },
            pageFilters: { 
                dashboard: { mode: 'month', value: new Date().toISOString().slice(0, 7) }, 
                fuel: { mode: 'year', value: new Date().getFullYear().toString() }, 
                maintenance: { mode: 'year', value: new Date().getFullYear().toString() }, 
                parking: { mode: 'year', value: new Date().getFullYear().toString() }, 
                analytics: { mode: 'year', value: new Date().getFullYear().toString() },
                maintenanceSearch: '',
                maintenanceTypes: [],
                maintenanceView: 'all',
                fuelSearch: '',
                parkingSearch: ''
            },

            async init() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(this.dbName, 1);
                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;
                        if (!db.objectStoreNames.contains('vehicles')) db.createObjectStore('vehicles', { keyPath: 'id' });
                        if (!db.objectStoreNames.contains('logs')) {
                            const logsStore = db.createObjectStore('logs', { keyPath: 'id' });
                            logsStore.createIndex('vehicleId', 'vehicleId', { unique: false });
                            logsStore.createIndex('type', 'type', { unique: false });
                        }
                        if (!db.objectStoreNames.contains('settings')) db.createObjectStore('settings', { keyPath: 'id' });
                    };
                    request.onsuccess = async (event) => {
                        this.db = event.target.result;
                        await this.migrateFromLocalStorage(); 
                        await this.loadAllData();
                        resolve();
                    };
                    request.onerror = (e) => reject(e);
                });
            },

            async runTransaction(storeName, mode, callback) {
                return new Promise((resolve, reject) => {
                    const tx = this.db.transaction(storeName, mode);
                    const store = tx.objectStore(storeName);
                    let request;
                    let result;
                    try {
                        request = callback(store, tx);
                    } catch (err) {
                        reject(err);
                        return;
                    }
                    if (request) {
                        request.onsuccess = () => { result = request.result; };
                        request.onerror = () => reject(request.error);
                    }
                    tx.oncomplete = () => resolve(result);
                    tx.onerror = () => reject(tx.error || new Error('Transaction failed'));
                    tx.onabort = () => reject(tx.error || new Error('Transaction aborted'));
                });
            },

            async clearAllData() {
                return new Promise((resolve, reject) => {
                    const tx = this.db.transaction(['vehicles', 'logs', 'settings'], 'readwrite');
                    tx.objectStore('vehicles').clear();
                    tx.objectStore('logs').clear();
                    tx.objectStore('settings').clear();
                    tx.oncomplete = () => resolve();
                    tx.onerror = () => reject(tx.error || new Error('Clear failed'));
                    tx.onabort = () => reject(tx.error || new Error('Clear aborted'));
                });
            },

            async migrateFromLocalStorage() {
                const oldData = localStorage.getItem('fuelmate_data');
                if (oldData) {
                    try {
                        const parsed = JSON.parse(oldData);
                        await this.importData(parsed);
                        localStorage.removeItem('fuelmate_data'); 
                        console.log('Migrated from LocalStorage to IndexedDB');
                    } catch(e) { console.error('Migration failed', e); }
                }
            },

            async loadAllData() {
                this.data.vehicles = await this.runTransaction('vehicles', 'readonly', s => s.getAll());
                this.data.logs = await this.runTransaction('logs', 'readonly', s => s.getAll());
                const settings = await this.runTransaction('settings', 'readonly', s => s.get('global'));
                if (settings) this.data.settings = { ...this.data.settings, ...settings };
                
                // Ensure default settings
                if (!this.data.settings.activeVehicleId && this.data.vehicles.length > 0) {
                    this.data.settings.activeVehicleId = this.data.vehicles[0].id;
                }
            },

            async saveData() {
                await this.runTransaction('settings', 'readwrite', s => s.put({ id: 'global', ...this.data.settings }));
            },

            async addVehicle(vehicle) {
                this.data.vehicles.push(vehicle);
                if (!this.data.settings.activeVehicleId) {
                    this.data.settings.activeVehicleId = vehicle.id;
                    await this.saveData();
                }
                await this.runTransaction('vehicles', 'readwrite', s => s.put(vehicle));
            },

            async updateVehicle(vehicle) {
                const idx = this.data.vehicles.findIndex(v => v.id === vehicle.id);
                if (idx !== -1) {
                    this.data.vehicles[idx] = vehicle;
                    await this.runTransaction('vehicles', 'readwrite', s => s.put(vehicle));
                }
            },

            async deleteVehicle(id) {
                this.data.vehicles = this.data.vehicles.filter(v => v.id !== id);
                this.data.logs = this.data.logs.filter(l => l.vehicleId !== id);
                if (this.data.settings.activeVehicleId === id) {
                    this.data.settings.activeVehicleId = this.data.vehicles.length ? this.data.vehicles[0].id : null;
                    await this.saveData();
                }
                await this.runTransaction('vehicles', 'readwrite', s => s.delete(id));
                const tx = this.db.transaction('logs', 'readwrite');
                const logStore = tx.objectStore('logs');
                const idx = logStore.index('vehicleId');
                const keyRange = IDBKeyRange.only(id);
                const req = idx.openCursor(keyRange);
                req.onsuccess = (e) => {
                    const cursor = e.target.result;
                    if (cursor) { cursor.delete(); cursor.continue(); }
                };
            },

            async addLog(log) {
                this.data.logs.push(log);
                await this.runTransaction('logs', 'readwrite', s => s.put(log));
                
                // Auto-update vehicle odometer
                const vehicle = this.data.vehicles.find(v => v.id === log.vehicleId);
                if (vehicle && log.odometer > vehicle.currentOdometer) {
                    vehicle.currentOdometer = log.odometer;
                    await this.updateVehicle(vehicle);
                }
            },

            async updateLog(log) {
                const idx = this.data.logs.findIndex(l => l.id === log.id);
                if (idx !== -1) {
                    this.data.logs[idx] = log;
                    await this.runTransaction('logs', 'readwrite', s => s.put(log));
                    
                    const vehicle = this.data.vehicles.find(v => v.id === log.vehicleId);
                    const maxOdo = Math.max(...this.data.logs.filter(l => l.vehicleId === log.vehicleId).map(l => parseFloat(l.odometer) || 0));
                    if (vehicle && maxOdo > vehicle.currentOdometer) {
                        vehicle.currentOdometer = maxOdo;
                        await this.updateVehicle(vehicle);
                    }
                }
            },

            async deleteLog(id) {
                this.data.logs = this.data.logs.filter(l => l.id !== id);
                await this.runTransaction('logs', 'readwrite', s => s.delete(id));
            },

            async clearVehicleLogs(vehicleId) {
                this.data.logs = this.data.logs.filter(l => l.vehicleId !== vehicleId);
                const tx = this.db.transaction('logs', 'readwrite');
                const idx = tx.objectStore('logs').index('vehicleId');
                const req = idx.openCursor(IDBKeyRange.only(vehicleId));
                req.onsuccess = (e) => {
                    const cursor = e.target.result;
                    if (cursor) { cursor.delete(); cursor.continue(); }
                };
            },

            async importData(importedData, options = {}) {
                const { overwrite = false } = options;
                if (overwrite) {
                    this.data.vehicles = [];
                    this.data.logs = [];
                    this.data.settings = { ...this.defaultSettings };
                    await this.clearAllData();
                }
                if (importedData.vehicles) {
                    for (const v of importedData.vehicles) await this.addVehicle(v);
                }
                if (importedData.logs) {
                    for (const l of importedData.logs) await this.addLog(l);
                }
                if (importedData.settings) {
                    this.data.settings = { ...this.data.settings, ...importedData.settings };
                    await this.saveData();
                }

                if (!this.data.settings.activeVehicleId && this.data.vehicles.length > 0) {
                    this.data.settings.activeVehicleId = this.data.vehicles[0].id;
                    await this.saveData();
                }
            },

            getActiveVehicle() {
                return this.data.vehicles.find(v => v.id === this.data.settings.activeVehicleId);
            },
            
            getVehicleLogs(type = null) {
                let logs = this.data.logs.filter(l => l.vehicleId === this.data.settings.activeVehicleId);
                if (type) logs = logs.filter(l => l.type === type);
                return logs.sort((a, b) => new Date(b.date) - new Date(a.date)); // Newest first
            }
        };

        // --- UTILS ---
        const utils = {
            t(key) {
                const lang = store.data.settings.language || 'en';
                return translations[lang][key] || key;
            },
            newId() {
                if (globalThis.crypto && typeof globalThis.crypto.randomUUID === 'function') {
                    return globalThis.crypto.randomUUID();
                }
                return `${Date.now().toString(36)}-${Math.random().toString(36).slice(2, 10)}`;
            },
            csvEscape(value) {
                const s = value === undefined || value === null ? '' : String(value);
                if (/[",\n\r]/.test(s)) return `"${s.replace(/"/g, '""')}"`;
                return s;
            },
            formatDate(isoString) {
                if (!isoString) return '';
                const date = new Date(isoString);
                const lang = store.data.settings.language;
                if (lang === 'zh') return `${date.getFullYear()}年${date.getMonth()+1}月${date.getDate()}日`;
                return date.toLocaleDateString('en-GB'); // DD/MM/YYYY
            },
            formatCurrency(amount) {
                if (amount === undefined || amount === null || amount === '--' || isNaN(parseFloat(amount))) return '--';
                return `${store.data.settings.currency}${parseFloat(amount).toFixed(2)}`;
            },
            getCostPerDistLabel() {
                const lang = store.data.settings.language || 'en';
                const unit = store.data.settings.units === 'imperial' ? 'mi' : 'km';
                if (lang === 'zh') return unit === 'mi' ? '每英里成本' : '每公里成本';
                return `Cost/${unit}`;
            },
            getDistUnit() { return store.data.settings.units === 'imperial' ? 'mi' : 'km'; },
            getFuelUnit() { 
                const v = store.getActiveVehicle();
                return v && v.fuelUnit ? v.fuelUnit : (store.data.settings.units === 'imperial' ? 'Gal' : 'L'); 
            },
            getEfficiencyLabel() {
                 const v = store.getActiveVehicle();
                 if (v && v.fuelUnit === 'kWh') return `kWh/100${utils.getDistUnit()}`;
                 return store.data.settings.units === 'imperial' ? 'MPG' : 'L/100km'; 
            },
            getTirePositions() { return ['front_left','front_right','rear_left','rear_right']; },
            formatDaysShort(days) {
                const d = Math.max(0, Math.ceil(days));
                return (store.data.settings.language === 'zh') ? `${d}天` : `${d}d`;
            },
            getTireReplacementStatus(vehicle) {
                const distInt = parseInt(store.data.settings.tireReplaceDist) || 0;
                const yearsInt = parseInt(store.data.settings.tireReplaceYears) || 0;
                const now = new Date();
                const currentOdo = parseFloat(vehicle?.currentOdometer) || 0;
                const events = store.data.logs
                    .filter(l => l.vehicleId === vehicle?.id && (l.type === 'tire_replace' || l.type === 'tire_rotation'))
                    .map(l => ({
                        log: l,
                        odo: parseFloat(l.odometer) || 0,
                        dateMs: l.date ? new Date(l.date).getTime() : 0
                    }))
                    .sort((a, b) => (a.odo - b.odo) || (a.dateMs - b.dateMs));

                const posToTireId = new Map(utils.getTirePositions().map(p => [p, `init:${vehicle?.id}:${p}`]));
                const tireLastReplace = new Map(); // tireId -> { odo, dateMs, logId }

                for (const { log, odo, dateMs } of events) {
                    if (log.type === 'tire_replace') {
                        const pos = log.tirePosition;
                        if (!pos) continue;
                        const tireId = log.tireId || `rep:${log.id}`;
                        posToTireId.set(pos, tireId);
                        tireLastReplace.set(tireId, { odo, dateMs, logId: log.id });
                    } else if (log.type === 'tire_rotation') {
                        const swaps = Array.isArray(log.tireSwaps) && log.tireSwaps.length
                            ? log.tireSwaps
                            : (log.tireSwapA && log.tireSwapB ? [{ a: log.tireSwapA, b: log.tireSwapB }] : []);
                        for (const s of swaps) {
                            const a = s?.a;
                            const b = s?.b;
                            if (!a || !b || a === b) continue;
                            const idA = posToTireId.get(a);
                            const idB = posToTireId.get(b);
                            posToTireId.set(a, idB);
                            posToTireId.set(b, idA);
                        }
                    }
                }

                const yearDays = 365;
                return utils.getTirePositions().map((pos) => {
                    const tireId = posToTireId.get(pos);
                    const latest = tireId ? tireLastReplace.get(tireId) : null;
                    if (!latest) {
                        return { pos, editLogId: null, isOverdue: false, primary: utils.t('tire_not_set'), secondary: '', remainingKm: null, remainingDays: null, dueDateIso: null, dueOdo: null };
                    }

                    const lastOdo = latest.odo;
                    const lastDate = latest.dateMs ? new Date(latest.dateMs) : null;
                    const dueOdo = distInt > 0 ? (lastOdo + distInt) : null;
                    const remainingKm = dueOdo === null ? null : (dueOdo - currentOdo);

                    let dueDate = null;
                    let remainingDays = null;
                    if (yearsInt > 0 && lastDate) {
                        dueDate = new Date(lastDate);
                        dueDate.setFullYear(dueDate.getFullYear() + yearsInt);
                        remainingDays = Math.ceil((dueDate - now) / 86400000);
                    }

                    const overdueDist = remainingKm !== null && remainingKm <= 0;
                    const overdueTime = remainingDays !== null && remainingDays <= 0;
                    const isOverdue = overdueDist || overdueTime;

                    const distText = remainingKm === null ? '' : `${Math.max(0, Math.round(remainingKm)).toLocaleString()} ${utils.getDistUnit()}`;
                    const timeText = remainingDays === null ? '' : utils.formatDaysShort(remainingDays);

                    const distFrac = remainingKm === null ? Number.POSITIVE_INFINITY : (remainingKm / Math.max(1, distInt));
                    const timeFrac = remainingDays === null ? Number.POSITIVE_INFINITY : (remainingDays / Math.max(1, yearsInt * yearDays));
                    const primaryIsDist = distFrac <= timeFrac;

                    const primary = isOverdue ? utils.t('overdue') : (primaryIsDist ? (distText || timeText) : (timeText || distText));
                    const secondaryParts = [];
                    if (!isOverdue && distText && !primaryIsDist) secondaryParts.push(distText);
                    if (!isOverdue && timeText && primaryIsDist) secondaryParts.push(timeText);
                    const secondary = secondaryParts.length ? `${utils.t('due_in')} ${secondaryParts.join(' / ')}` : '';

                    return { pos, editLogId: latest.logId || null, isOverdue, primary, secondary, remainingKm, remainingDays, dueDateIso: dueDate ? dueDate.toISOString() : null, dueOdo };
                });
            },

            getTireTimeline(vehicle) {
                const events = store.data.logs
                    .filter(l => l.vehicleId === vehicle?.id && (l.type === 'tire_replace' || l.type === 'tire_rotation'))
                    .map(l => ({
                        log: l,
                        odo: parseFloat(l.odometer) || 0,
                        dateMs: l.date ? new Date(l.date).getTime() : 0
                    }))
                    .sort((a, b) => (a.odo - b.odo) || (a.dateMs - b.dateMs));

                const posToTireId = new Map(utils.getTirePositions().map(p => [p, `init:${vehicle?.id}:${p}`]));
                const tires = new Map(); // tireId -> { tireId, currentPos, lastReplace, events: [] }

                const ensure = (tireId) => {
                    if (!tires.has(tireId)) tires.set(tireId, { tireId, currentPos: null, lastReplace: null, events: [] });
                    return tires.get(tireId);
                };

                for (const { log, odo } of events) {
                    if (log.type === 'tire_replace') {
                        const pos = log.tirePosition;
                        if (!pos) continue;
                        const tireId = log.tireId || `rep:${log.id}`;
                        posToTireId.set(pos, tireId);
                        const t = ensure(tireId);
                        t.lastReplace = { logId: log.id, date: log.date, odometer: odo, brand: log.tireBrand || '' };
                        t.events.push({ kind: 'replace', logId: log.id, date: log.date, odometer: odo, pos, brand: log.tireBrand || '' });
                    } else if (log.type === 'tire_rotation') {
                        const swaps = Array.isArray(log.tireSwaps) && log.tireSwaps.length
                            ? log.tireSwaps
                            : (log.tireSwapA && log.tireSwapB ? [{ a: log.tireSwapA, b: log.tireSwapB }] : []);
                        for (const s of swaps) {
                            const a = s?.a;
                            const b = s?.b;
                            if (!a || !b || a === b) continue;
                            const idA = posToTireId.get(a);
                            const idB = posToTireId.get(b);
                            if (idA) ensure(idA).events.push({ kind: 'rotate', logId: log.id, date: log.date, odometer: odo, from: a, to: b });
                            if (idB) ensure(idB).events.push({ kind: 'rotate', logId: log.id, date: log.date, odometer: odo, from: b, to: a });
                            posToTireId.set(a, idB);
                            posToTireId.set(b, idA);
                        }
                    }
                }

                for (const [pos, tireId] of posToTireId.entries()) {
                    ensure(tireId).currentPos = pos;
                }

                const posRank = new Map(utils.getTirePositions().map((p, i) => [p, i]));
                return Array.from(tires.values()).sort((a, b) => {
                    const ar = a.currentPos ? posRank.get(a.currentPos) ?? 999 : 999;
                    const br = b.currentPos ? posRank.get(b.currentPos) ?? 999 : 999;
                    if (ar !== br) return ar - br;
                    const ad = a.lastReplace?.date ? new Date(a.lastReplace.date).getTime() : 0;
                    const bd = b.lastReplace?.date ? new Date(b.lastReplace.date).getTime() : 0;
                    return bd - ad;
                });
            },
            
            getAvailableYears() {
                const logs = store.getVehicleLogs();
                const years = new Set(logs.map(l => new Date(l.date).getFullYear()));
                years.add(new Date().getFullYear());
                return Array.from(years).sort((a,b) => b-a);
            },
            filterLogs(logs, filter) {
                if (!filter) return logs;
                return logs.filter(l => {
                    const d = new Date(l.date);
                    if (filter.mode === 'month') {
                        const [y, m] = filter.value.split('-');
                        return d.getFullYear() == y && (d.getMonth() + 1) == m;
                    } else if (filter.mode === 'year') {
                         return d.getFullYear() == filter.value;
                    }
                    return true; 
                });
            },

            calculateStats(logs, category = 'all') {
                if (!logs.length) return { efficiency: '--', costKm: '--', totalCost: 0, totalDist: 0 };
                
                // 1. Total Cost
                const totalCost = logs.reduce((sum, l) => {
                    const c = parseFloat(l.cost);
                    return sum + (Number.isFinite(c) ? c : 0);
                }, 0);
                
                // 2. Total Distance
                const sorted = [...logs].sort((a, b) => parseFloat(a.odometer) - parseFloat(b.odometer));
                const totalDist = sorted.length > 1 ? sorted[sorted.length-1].odometer - sorted[0].odometer : 0;

                // 3. Fuel Efficiency (Always calc if fuel data exists)
                let efficiency = '--';
                let costKm = '--';
                
                if (category === 'fuel' || category === 'all') {
                    // Filter specifically for fuel logs to calculate efficiency
                    const fuelLogs = logs.filter(l => l.type === 'fuel').sort((a, b) => parseFloat(a.odometer) - parseFloat(b.odometer));
                    const v = store.getActiveVehicle();
                    const isImperial = store.data.settings.units === 'imperial';
                    const isEV = v && v.fuelUnit === 'kWh';
                    
                    if (fuelLogs.length > 1) {
                        let totalFuel = 0;
                        let validDist = 0;
                        
                        for (let i = 0; i < fuelLogs.length - 1; i++) {
                            const curr = fuelLogs[i];
                            const next = fuelLogs[i+1];
                            
                            // Simple efficiency calculation: if segments are consecutive full tanks
                            if (!curr.isPartial && !next.isPartial) {
                                const dist = next.odometer - curr.odometer;
                                if (dist > 0) {
                                    validDist += dist;
                                    totalFuel += parseFloat(next.liters) || 0; 
                                }
                            }
                        }
                        
                        if (validDist > 0 && totalFuel > 0) {
                            if (isEV) efficiency = (totalFuel / validDist * 100).toFixed(1);
                            else if (isImperial) efficiency = (validDist / totalFuel).toFixed(1);
                            else efficiency = (totalFuel / validDist * 100).toFixed(1);
                        }
                    }
                }
                
                // 4. Cost per KM (Total)
                if (totalDist > 0 && totalCost > 0) {
                    costKm = (totalCost / totalDist).toFixed(2);
                }

                return { efficiency, costKm, totalCost, totalDist };
            },
            
            detectLocation(callback) {
                if (!navigator.geolocation) return callback('');
                navigator.geolocation.getCurrentPosition(async (pos) => {
                    try {
                        const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${pos.coords.latitude}&lon=${pos.coords.longitude}`);
                        const data = await res.json();
                        const parts = [data.address.amenity, data.address.road, data.address.suburb].filter(Boolean);
                        callback(parts.join(', ') || `${pos.coords.latitude.toFixed(3)}, ${pos.coords.longitude.toFixed(3)}`);
                    } catch {
                        callback(`${pos.coords.latitude.toFixed(3)}, ${pos.coords.longitude.toFixed(3)}`);
                    }
                }, () => callback(''));
            },

            generateTrendChart(logs) {
                const fuelLogs = logs.filter(l => l.type === 'fuel' && !l.isPartial).sort((a,b) => new Date(a.date) - new Date(b.date));
                if (fuelLogs.length < 2) return '';
                const v = store.getActiveVehicle();
                const isImperial = store.data.settings.units === 'imperial';
                const isEV = v && v.fuelUnit === 'kWh';
                
                const dataPoints = [];
                for (let i = 0; i < fuelLogs.length - 1; i++) {
                     const dist = fuelLogs[i+1].odometer - fuelLogs[i].odometer;
                     if (dist > 0) {
                         const fuel = parseFloat(fuelLogs[i+1].liters) || 0;
                         if (fuel > 0) {
                             const eff = isEV ? (fuel / dist * 100) : (isImperial ? (dist / fuel) : (fuel / dist * 100));
                             dataPoints.push(eff);
                         }
                     }
                }
                if (dataPoints.length < 2) return '';
                const recentPoints = dataPoints.slice(-10); 

                const w = 300, h = 120; 
                const max = Math.max(...recentPoints) * 1.1;
                const min = Math.min(...recentPoints) * 0.9;
                const range = max - min || 1;
                const avg = recentPoints.reduce((a,b)=>a+b,0) / recentPoints.length;
                const avgY = h - ((avg - min) / range) * h;
                
                const points = recentPoints.map((val, i) => {
                    const x = (i / (recentPoints.length - 1)) * w;
                    const y = h - ((val - min) / range) * h;
                    return {x, y, val};
                });
                
                const pathD = points.map((p, i) => (i===0 ? 'M' : 'L') + `${p.x},${p.y}`).join(' ');
                const fillD = `M0,${h} ${pathD} L${w},${h}`;

                return `
                    <svg viewBox="-10 -20 ${w+20} ${h+40}" class="w-full h-full overflow-visible">
                        <defs>
                            <linearGradient id="chartGrad" x1="0" x2="0" y1="0" y2="1">
                                <stop offset="0%" stop-color="currentColor" stop-opacity="0.3"/>
                                <stop offset="100%" stop-color="currentColor" stop-opacity="0"/>
                            </linearGradient>
                        </defs>
                        <!-- Grid -->
                        <line x1="0" y1="${avgY}" x2="${w}" y2="${avgY}" stroke="currentColor" stroke-width="1" stroke-dasharray="5,5" opacity="0.3" />
                        <text x="0" y="${avgY-5}" font-size="8" fill="currentColor" opacity="0.5">AVG: ${avg.toFixed(1)}</text>

                        <!-- Area & Line -->
                        <path d="${fillD}" fill="url(#chartGrad)" class="text-teal-500"/>
                        <path d="${pathD}" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-teal-600"/>
                        
                        <!-- Points & Labels -->
                        ${points.map(p => `
                            <circle cx="${p.x}" cy="${p.y}" r="3" fill="white" stroke="currentColor" stroke-width="2" class="text-teal-600"/>
                            <text x="${p.x}" y="${p.y - 8}" text-anchor="middle" font-size="8" font-weight="bold" fill="currentColor">${p.val.toFixed(1)}</text>
                        `).join('')}
                    </svg>
                `;
            },
            
            generateMonthlyBarChart(logs) {
                const months = [];
                const now = new Date();
                for (let i=5; i>=0; i--) {
                    const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
                    months.push(d.toISOString().slice(0, 7)); 
                }
                
                const data = months.map(m => {
                    const monthLogs = logs.filter(l => l.date.startsWith(m));
                    const fuel = monthLogs.filter(l => l.type === 'fuel').reduce((sum, l) => sum + (Number.isFinite(parseFloat(l.cost)) ? parseFloat(l.cost) : 0), 0);
                    const service = monthLogs.filter(l => l.type !== 'fuel').reduce((sum, l) => sum + (Number.isFinite(parseFloat(l.cost)) ? parseFloat(l.cost) : 0), 0);
                    return { month: m, fuel, service };
                });
                
                const maxVal = Math.max(...data.map(d => d.fuel + d.service)) || 100;
                const w = 300, h = 150;
                const barW = (w / 6) * 0.5;
                const chartBottom = h - 20;
                
                return `
                    <svg viewBox="0 0 ${w} ${h}" class="w-full h-full overflow-visible">
                        <!-- Grid Lines -->
                        ${[0.25, 0.5, 0.75, 1].map(p => {
                            const y = chartBottom - (chartBottom * p);
                            return `<line x1="0" y1="${y}" x2="${w}" y2="${y}" stroke="currentColor" stroke-opacity="0.05" stroke-dasharray="4,4" />`;
                        }).join('')}

                        ${data.map((d, i) => {
                            const x = (w/6) * i + (w/6 - barW)/2;
                            const hFuel = (d.fuel / maxVal) * chartBottom;
                            const hService = (d.service / maxVal) * chartBottom;
                            const yFuel = chartBottom - hFuel;
                            const yService = yFuel - hService;
                            const total = d.fuel + d.service;
                            
                            return `
                                <rect x="${x}" y="${yFuel}" width="${barW}" height="${hFuel}" class="fill-teal-500" rx="2" />
                                <rect x="${x}" y="${yService}" width="${barW}" height="${hService}" class="fill-orange-400" rx="2" />
                                ${total > 0 ? `<text x="${x + barW/2}" y="${yService - 4}" text-anchor="middle" font-size="9" font-weight="bold" fill="currentColor" opacity="0.7">${Math.round(total)}</text>` : ''}
                                <text x="${x + barW/2}" y="${h}" text-anchor="middle" font-size="10" fill="currentColor" opacity="0.6">${d.month.split('-')[1]}</text>
                            `;
                        }).join('')}
                    </svg>
                `;
            },

            exportCSV() {
                const logs = store.getVehicleLogs();
                const fuelUnit = utils.getFuelUnit();
                const rows = [['Date', 'Type', `Odometer (${utils.getDistUnit()})`, `Cost (${store.data.settings.currency})`, 'Details']];
                logs.forEach(l => {
                    let details = l.notes || '';
                    if (l.type === 'fuel') {
                        const tank = l.isPartial ? utils.t('partial') : utils.t('full');
                        details = `${l.liters}${fuelUnit}, ${tank}`;
                    }
                    rows.push([l.date, l.type, l.odometer ?? '', l.cost ?? '', details]);
                });
                const csv = rows.map(r => r.map(utils.csvEscape).join(',')).join('\n') + '\n';
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `fuelmate_export_${new Date().toISOString().slice(0,10)}.csv`;
                a.click();
            },
            
            exportCalendar(type, alarmDays) {
                const v = store.getActiveVehicle();
                if (!v) return;
                const logs = store.getVehicleLogs(type);
                if (!logs.length || !logs[0].expiryDate) return alert('No expiry date found for this item.');
                
                const log = logs[0];
                const expDate = log.expiryDate.replace(/-/g, ''); 
                const title = `${utils.t(type)}: ${v.make} ${v.model}`;
                
                let alarmBlock = '';
                if (alarmDays !== null) {
                    const trigger = `-P${alarmDays}D`; 
                    alarmBlock = `BEGIN:VALARM\nTRIGGER:${trigger}\nDESCRIPTION:${title}\nACTION:DISPLAY\nEND:VALARM\n`;
                }

                const ics = `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//FuelMate//EN
BEGIN:VEVENT
UID:${utils.newId()}@fuelmate
DTSTAMP:${new Date().toISOString().replace(/[-:]/g, '').split('.')[0]}Z
DTSTART;VALUE=DATE:${expDate}
SUMMARY:${title}
DESCRIPTION:Renew ${utils.t(type)} for ${v.make} ${v.model}
${alarmBlock}END:VEVENT
END:VCALENDAR`;

                const blob = new Blob([ics], { type: 'text/calendar' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `fuelmate_${type}.ics`;
                a.click();
            },

            exportDateCalendar(title, isoDate, alarmDays = null) {
                if (!isoDate) return;
                const dateStr = isoDate.slice(0, 10).replace(/-/g, '');
                let alarmBlock = '';
                if (alarmDays !== null) {
                    const trigger = `-P${alarmDays}D`;
                    alarmBlock = `BEGIN:VALARM\nTRIGGER:${trigger}\nDESCRIPTION:${title}\nACTION:DISPLAY\nEND:VALARM\n`;
                }
                const ics = `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//FuelMate//EN
BEGIN:VEVENT
UID:${utils.newId()}@fuelmate
DTSTAMP:${new Date().toISOString().replace(/[-:]/g, '').split('.')[0]}Z
DTSTART;VALUE=DATE:${dateStr}
SUMMARY:${title}
${alarmBlock}END:VEVENT
END:VCALENDAR`;
                const blob = new Blob([ics], { type: 'text/calendar' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `fuelmate_reminder_${dateStr}.ics`;
                a.click();
            },

            getCarColorClass(color) {
                const map = {
                    teal: 'grad-teal text-white', blue: 'grad-blue text-white', red: 'grad-red text-white',
                    black: 'grad-black text-white', white: 'grad-white', yellow: 'grad-yellow text-white',
                    purple: 'grad-purple text-white', green: 'grad-green text-white', orange: 'grad-orange text-white',
                    brown: 'grad-brown text-white', grey: 'grad-grey text-white', pink: 'grad-pink text-white', cyan: 'grad-cyan text-white'
                };
                return map[color] || map.teal;
            },
            getCarIcon(type) {
                const map = { sedan: 'directions_car', suv: 'airport_shuttle', bike: 'two_wheeler', truck: 'local_shipping', sports: 'sports_motorsports', van: 'airport_shuttle', bus: 'directions_bus' };
                return map[type] || 'directions_car';
            }
        };

        // --- UI RENDERER ---
        const ui = {
            init() {
                store.init().then(() => {
                    this.render();
                    if (!store.data.vehicles.length) this.openAddVehicle();
                }).catch(err => console.error("DB Init Failed", err));
            },

            render() {
                const app = document.getElementById('app');
                const page = router.currentPage;
                const vehicle = store.getActiveVehicle();
                const scrollY = window.scrollY;

                if (!vehicle && store.data.vehicles.length > 0) {
                     store.data.settings.activeVehicleId = store.data.vehicles[0].id;
                     store.saveData().then(() => this.render());
                     return;
                }

                let content = '';
                if (!vehicle) {
                    content = this.renderNoVehicleState();
                } else {
                    if (page === 'dashboard') content = this.renderDashboard(vehicle);
                    else if (page === 'fuel') content = this.renderFuel(vehicle);
                    else if (page === 'maintenance') content = this.renderMaintenance(vehicle);
                    else if (page === 'parking') content = this.renderParking(vehicle);
                    else if (page === 'analytics') content = this.renderAnalytics(vehicle);
                    else if (page === 'reminders') content = this.renderReminders(vehicle);
                    else if (page === 'settings') content = this.renderSettings(vehicle);
                }

                app.innerHTML = `
                    ${content}
                    ${this.renderBottomNav(page)}
                `;
                window.scrollTo(0, scrollY);
            },
            
            renderNoVehicleState() {
                return `
                    <div class="flex flex-col items-center justify-center min-h-[80vh] p-8 text-center">
                        <div class="w-24 h-24 bg-teal-100 rounded-full flex items-center justify-center mb-6">
                            <span class="material-icons text-4xl text-teal-600">no_crash</span>
                        </div>
                        <h2 class="text-2xl font-bold mb-2 theme-text-heading">${utils.t('welcome')}</h2>
                        <p class="theme-text-sub mb-8">Add your first vehicle to start tracking fuel, costs, and maintenance.</p>
                        <button onclick="ui.openAddVehicle()" class="grad-teal text-white px-8 py-3 rounded-xl font-bold shadow-lg shadow-teal-500/30 active:scale-95 transition-transform flex items-center gap-2">
                            <span class="material-icons">add</span> ${utils.t('add_vehicle')}
                        </button>
                    </div>
                `;
            },
            
            renderFilterHeader(page, filter, isColorBg = false) {
                const isYear = filter.mode === 'year';
                const isMonth = filter.mode === 'month';
                const availableYears = utils.getAvailableYears();
                
                const inputClass = isColorBg 
                    ? 'bg-white/20 backdrop-blur-md text-white placeholder-white/70' 
                    : 'bg-slate-100 dark:bg-slate-800 text-slate-700 dark:text-slate-200 border theme-border';
                
                const containerClass = isColorBg 
                    ? 'bg-black/10 backdrop-blur-md' 
                    : 'bg-slate-100 dark:bg-slate-800 border theme-border';

                const activeBtnClass = isColorBg
                    ? 'bg-white text-teal-700 shadow-sm'
                    : 'bg-white dark:bg-slate-600 text-teal-600 shadow-sm border theme-border';
                
                const inactiveBtnClass = isColorBg
                    ? 'text-white/80 hover:bg-white/10'
                    : 'text-slate-500 dark:text-slate-400 hover:bg-slate-200 dark:hover:bg-slate-700';

                return `
                    <div class="flex items-center justify-end gap-2 mb-4 w-full">
                        <div class="flex-1 flex items-center gap-2">
                             ${isMonth ? `<input type="month" value="${filter.value}" onchange="ui.setFilter('${page}', 'month', this.value)" class="text-sm p-1 rounded font-medium outline-none ${inputClass}">` : ''}
                             ${isYear ? `
                                <select onchange="ui.setFilter('${page}', 'year', this.value)" class="text-sm p-1 rounded font-medium outline-none appearance-none pl-2 pr-6 relative ${inputClass}">
                                    ${availableYears.map(y => `<option value="${y}" ${y == filter.value ? 'selected' : ''} class="text-black">${y}</option>`).join('')}
                                </select>
                            ` : ''}
                        </div>
                        
                        <div class="flex rounded-lg p-1 shrink-0 ${containerClass}">
                            <button onclick="ui.setFilter('${page}', 'month')" class="px-3 py-1 rounded-md text-xs font-medium transition-all ${filter.mode === 'month' ? activeBtnClass : inactiveBtnClass}">${utils.t('range_month')}</button>
                            <button onclick="ui.setFilter('${page}', 'year')" class="px-3 py-1 rounded-md text-xs font-medium transition-all ${filter.mode === 'year' ? activeBtnClass : inactiveBtnClass}">${utils.t('range_year')}</button>
                            <button onclick="ui.setFilter('${page}', 'all')" class="px-3 py-1 rounded-md text-xs font-medium transition-all ${filter.mode === 'all' ? activeBtnClass : inactiveBtnClass}">${utils.t('range_all')}</button>
                        </div>
                    </div>
                `;
            },

            setFilter(page, mode, value) {
                if (mode === 'month' && !value) value = new Date().toISOString().slice(0, 7);
                if (mode === 'year' && !value) value = new Date().getFullYear().toString();
                store.pageFilters[page] = { mode, value };
                this.render();
            },

            renderDashboard(vehicle) {
                const logs = store.getVehicleLogs();
                const filter = store.pageFilters.dashboard;
                const filteredLogs = utils.filterLogs(logs, filter);
                const stats = utils.calculateStats(filteredLogs, 'all');
                const tireStatuses = utils.getTireReplacementStatus(vehicle);
                
                let remindersHtml = '';
                const reminders = [];
                // 1. Doc Expiry
                ['license', 'insurance', 'registration'].forEach(type => {
                    const setting = store.data.settings.reminders?.[type];
                    if (setting && !setting.enabled) return; 
                    
                    const latest = store.getVehicleLogs(type)[0];
                    if (latest && latest.expiryDate) {
                        const days = Math.ceil((new Date(latest.expiryDate) - new Date()) / (1000 * 60 * 60 * 24));
                        if (days <= (setting?.days || 30)) { 
                            reminders.push({ type, days, cost: latest.cost, date: latest.expiryDate });
                        }
                    }
                });
                // 2. Periodic Service (Combined Logic)
                const lastService = logs.find(l => l.type === 'periodic_maintenance');
                const lastOdo = lastService ? parseFloat(lastService.odometer) : 0;
                const lastDate = lastService ? new Date(lastService.date) : null;
                
                const distInt = parseInt(store.data.settings.maintenanceDist) || 0;
                const timeInt = parseInt(store.data.settings.maintenanceTime) || 0; 
                
                if (distInt > 0) {
                     const nextOdo = lastOdo + distInt;
                     const remaining = nextOdo - vehicle.currentOdometer;
                     if (remaining <= 500) {
                         reminders.push({ type: 'due_service', days: remaining, isDist: true });
                     }
                }
                if (timeInt > 0 && lastDate) {
                    const nextDate = new Date(lastDate.setMonth(lastDate.getMonth() + timeInt));
                    const remainingDays = Math.ceil((nextDate - new Date()) / (86400000));
                    if (remainingDays <= 30) {
                         reminders.push({ type: 'due_service', days: remainingDays, isDist: false });
                    }
                }
                
                if (!store.data.settings.lastBackupDate) {
                     if (logs.length > 5) reminders.push({ type: 'backup_needed' });
                } else {
                     const daysSince = (new Date() - new Date(store.data.settings.lastBackupDate)) / (86400000);
                     if (daysSince > 30) reminders.push({ type: 'backup_needed' });
                }

                if (reminders.length > 0) {
                    remindersHtml = `
                        <div class="px-6 mb-4 space-y-3">
                            <div class="flex items-center justify-between">
                                <div class="text-xs font-bold text-slate-400 uppercase tracking-wider flex items-center gap-1"><span class="material-icons text-sm">notifications</span> ${utils.t('reminders')}</div>
                                <button onclick="router.navigate('reminders')" class="text-[10px] font-bold text-slate-400 underline">${utils.t('view_all')}</button>
                            </div>
                            ${reminders.map(r => {
                                if (r.type === 'backup_needed') {
                                    return `
                                        <div class="bg-blue-50 dark:bg-blue-900/30 p-3 rounded-xl border border-blue-100 dark:border-blue-800 flex items-center justify-between">
                                            <div class="flex items-center gap-3">
                                                <div class="w-8 h-8 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center"><span class="material-icons text-sm">cloud_upload</span></div>
                                                <div>
                                                    <div class="text-sm font-bold theme-text-heading">${utils.t('backup_needed')}</div>
                                                    <div class="text-xs theme-text-sub">${utils.t('backup_desc')}</div>
                                                </div>
                                            </div>
                                            <div class="flex flex-col gap-1">
                                                <button onclick="ui.exportData();ui.render()" class="text-xs bg-blue-600 text-white px-2 py-1 rounded font-bold">${utils.t('backup_now')}</button>
                                                <button onclick="store.data.settings.lastBackupDate=new Date().toISOString();store.saveData();ui.render()" class="text-[10px] text-blue-500 underline">${utils.t('backup_later')}</button>
                                            </div>
                                        </div>
                                    `;
                                }
                                const isDist = r.isDist;
                                const isExpired = !isDist && r.days < 0;
                                const color = isExpired || (isDist && r.days<0) ? 'red' : 'amber';
                                const label = isDist ? `${utils.t('due_in')} ${r.days} ${utils.getDistUnit()}` : (isExpired ? utils.t('expired') : `${utils.t('expiring_soon')} ${r.days} Days`);
                                return `
                                <div class="bg-${color}-50 dark:bg-${color}-900/20 p-3 rounded-xl border border-${color}-100 dark:border-${color}-800 flex items-center justify-between">
                                    <div class="flex items-center gap-3">
                                        <div class="w-8 h-8 rounded-full bg-${color}-100 text-${color}-600 flex items-center justify-center"><span class="material-icons text-sm">warning</span></div>
                                        <div>
                                            <div class="text-sm font-bold theme-text-heading">${utils.t(r.type)}</div>
                                            ${!isDist && r.date ? `<div class="text-xs theme-text-sub">${r.date}</div>` : ''}
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <div class="text-xs font-bold text-${color}-600 bg-white dark:bg-slate-800 px-2 py-1 rounded-md shadow-sm">${label}</div>
                                        ${r.cost ? `<div class="text-xs theme-text-sub mt-1">${utils.formatCurrency(r.cost)}</div>` : ''}
                                    </div>
                                </div>`;
                            }).join('')}
                        </div>
                    `;
                }

                const bgClass = utils.getCarColorClass(vehicle.color || 'teal');
                return `
                    <div class="relative pb-20">
                        <div class="${bgClass} pt-safe pb-20 rounded-b-[2.5rem] shadow-xl px-6 relative overflow-hidden transition-all duration-500 z-10">
                             <div class="absolute top-0 right-0 w-64 h-64 bg-white opacity-5 rounded-full -translate-y-1/2 translate-x-1/2 blur-3xl"></div>
                             
                             <div class="relative z-10">
                                <div class="flex justify-between items-start mb-6">
                                    <div>
                                        <div class="opacity-80 text-xs font-bold tracking-wider mb-1 uppercase">${vehicle.year} ${vehicle.make}</div>
                                        <div onclick="ui.openVehicleSelector()" class="text-3xl font-black flex items-center gap-2 cursor-pointer active:opacity-70">
                                            ${vehicle.model} 
                                            <span class="material-icons text-2xl opacity-70">expand_more</span>
                                        </div>
                                    </div>
                                    <div class="flex gap-2">
                                        <button onclick="ui.openCalendarSelector()" class="w-10 h-10 rounded-full bg-white/20 backdrop-blur-md flex items-center justify-center hover:bg-white/30 transition text-white">
                                            <span class="material-icons text-lg">event</span>
                                        </button>
                                        <button onclick="ui.openAddVehicle('${vehicle.id}')" class="w-10 h-10 rounded-full bg-white/20 backdrop-blur-md flex items-center justify-center hover:bg-white/30 transition text-white">
                                            <span class="material-icons text-lg">edit</span>
                                        </button>
                                    </div>
                                </div>
                                ${this.renderFilterHeader('dashboard', filter, true)}
                             </div>
                        </div>

                        <div class="px-6 mt-2 relative z-20">
                            <div class="grid grid-cols-2 gap-3 mb-6">
                                <div class="theme-bg-card p-4 rounded-2xl card-shadow">
                                    <div class="theme-text-sub text-[10px] font-bold uppercase tracking-wider mb-1">${utils.t('efficiency')}</div>
                                    <div class="text-2xl font-black text-teal-600">${stats.efficiency}</div>
                                    <div class="text-[10px] theme-text-sub">${utils.getEfficiencyLabel()}</div>
                                </div>
                                <div class="theme-bg-card p-4 rounded-2xl card-shadow">
                                    <div class="theme-text-sub text-[10px] font-bold uppercase tracking-wider mb-1">${utils.getCostPerDistLabel()}</div>
                                    <div class="text-2xl font-black text-blue-600">${stats.costKm}</div>
                                    <div class="text-[10px] theme-text-sub">&nbsp;</div>
                                </div>
                                <div class="theme-bg-card p-4 rounded-2xl card-shadow">
                                    <div class="theme-text-sub text-[10px] font-bold uppercase tracking-wider mb-1">${utils.t('total_cost')}</div>
                                    <div class="text-xl font-black theme-text-heading">${utils.formatCurrency(stats.totalCost)}</div>
                                </div>
                                <div class="theme-bg-card p-4 rounded-2xl card-shadow">
                                    <div class="theme-text-sub text-[10px] font-bold uppercase tracking-wider mb-1">${utils.t('total_dist')}</div>
                                    <div class="text-xl font-black theme-text-heading">${stats.totalDist.toLocaleString()}</div>
                                    <div class="text-[10px] theme-text-sub">${utils.getDistUnit()}</div>
                                </div>
                            </div>

                            <div class="theme-bg-card p-4 rounded-2xl card-shadow mb-6">
                                <div class="flex items-center justify-between">
                                    <div class="font-bold theme-text-heading flex items-center gap-2">
                                        <span class="material-icons text-slate-400 text-base">tire_repair</span>
                                        ${utils.t('next_tire_change')}
                                    </div>
                                    <button onclick="ui.openAddService(null,'tire_replace')" class="text-xs font-bold text-teal-600 bg-teal-50 dark:bg-teal-900/20 px-2 py-1 rounded-lg">+ ${utils.t('tire_replace')}</button>
                                </div>
                                <div class="grid grid-cols-2 gap-3 mt-3">
                                    ${tireStatuses.map(s => `
                                        <button onclick="${s.editLogId ? `ui.openAddService('${s.editLogId}')` : `ui.openAddService(null,'tire_replace'); setTimeout(() => { const el=document.getElementById('l_tire_pos'); if (el) el.value='${s.pos}'; }, 60);`}" class="text-left p-3 rounded-xl border theme-border bg-slate-50 dark:bg-slate-800/40 hover:bg-slate-100 dark:hover:bg-slate-800/60 transition">
                                            <div class="text-xs theme-text-sub font-bold">${utils.t('tire_' + s.pos)}</div>
                                            <div class="text-sm font-black ${s.isOverdue ? 'text-red-600' : 'theme-text-heading'}">${s.primary}</div>
                                            <div class="text-[10px] theme-text-sub">${s.secondary || '&nbsp;'}</div>
                                        </button>
                                    `).join('')}
                                </div>
                            </div>
                        </div>

                        <div class="mt-2 relative z-20">
                            ${remindersHtml}
                            
                            <div class="px-6 flex gap-3 mb-8">
                                <button onclick="ui.openAddFuel()" class="flex-1 grad-teal text-white py-4 rounded-2xl shadow-lg shadow-teal-500/20 active:scale-95 transition-transform flex flex-col items-center justify-center gap-1">
                                    <span class="material-icons text-2xl">local_gas_station</span>
                                    <span class="font-bold text-sm">${utils.t('add_fuel')}</span>
                                </button>
                                <button onclick="ui.openAddService()" class="flex-1 bg-white dark:bg-slate-800 theme-text-heading py-4 rounded-2xl shadow-lg active:scale-95 transition-transform flex flex-col items-center justify-center gap-1 border theme-border">
                                    <span class="material-icons text-2xl text-slate-400">build</span>
                                    <span class="font-bold text-sm">${utils.t('add_service')}</span>
                                </button>
                            </div>

                            <div class="px-6">
                                <div class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3 ml-1">Recent Activity</div>
                                <div class="space-y-3 pb-24">
                                    ${logs.length ? logs.slice(0, 5).map(l => this.renderLogCard(l)).join('') : `<div class="text-center theme-text-sub py-8 italic text-sm">No records yet</div>`}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            },

            renderReminders(vehicle) {
                const now = new Date();
                const center = store.data.settings.reminderCenter || { snoozedUntil: {}, done: {} };
                const snoozedUntil = center.snoozedUntil || {};
                const done = center.done || {};

                const items = [];

                // Tires
                const tireThresholdKm = (() => {
                    const dist = parseInt(store.data.settings.tireReplaceDist) || 0;
                    if (dist <= 0) return 2000;
                    return Math.max(500, Math.min(5000, Math.round(dist * 0.1)));
                })();
                const tireThresholdDays = 60;
                for (const s of utils.getTireReplacementStatus(vehicle)) {
                    const near =
                        s.isOverdue ||
                        (s.remainingKm !== null && s.remainingKm <= tireThresholdKm) ||
                        (s.remainingDays !== null && s.remainingDays <= tireThresholdDays);
                    if (!near) continue;
                    const id = `tire:${vehicle.id}:${s.pos}:${s.editLogId || 'none'}`;
                    items.push({
                        id,
                        icon: 'tire_repair',
                        title: `${utils.t('next_tire_change')} • ${utils.t('tire_' + s.pos)}`,
                        meta: [s.primary, s.secondary].filter(Boolean).join(' • '),
                        dueDateIso: s.dueDateIso,
                        editAction: s.editLogId
                            ? `ui.openAddService('${s.editLogId}')`
                            : `ui.openAddService(null,'tire_replace'); setTimeout(() => { const el=document.getElementById('l_tire_pos'); if (el) el.value='${s.pos}'; }, 60);`
                    });
                }

                // Document expiry
                ['license', 'insurance', 'registration'].forEach(type => {
                    const setting = store.data.settings.reminders?.[type];
                    if (setting && !setting.enabled) return;
                    const latest = store.getVehicleLogs(type)[0];
                    if (!latest || !latest.expiryDate) return;
                    const days = Math.ceil((new Date(latest.expiryDate) - now) / 86400000);
                    if (days > (setting?.days || 30)) return;
                    const id = `doc:${vehicle.id}:${type}:${latest.expiryDate}`;
                    items.push({
                        id,
                        icon: 'assignment',
                        title: utils.t(type),
                        meta: days <= 0 ? utils.t('overdue') : `${utils.t('due_in')} ${utils.formatDaysShort(days)}`,
                        dueDateIso: new Date(latest.expiryDate).toISOString(),
                        editAction: `ui.openAddService('${latest.id}')`,
                        calendarAction: `utils.exportCalendar('${type}', 0)`
                    });
                });

                // Periodic maintenance
                const distInt = parseInt(store.data.settings.maintenanceDist) || 0;
                const timeInt = parseInt(store.data.settings.maintenanceTime) || 0;
                const lastService = store.getVehicleLogs('periodic_maintenance')[0];
                const lastOdo = lastService ? parseFloat(lastService.odometer) || 0 : 0;
                const lastDate = lastService ? new Date(lastService.date) : null;
                if (distInt > 0) {
                    const nextOdo = lastOdo + distInt;
                    const remaining = nextOdo - (parseFloat(vehicle.currentOdometer) || 0);
                    if (remaining <= 500) {
                        const id = `svc:${vehicle.id}:dist:${nextOdo}`;
                        items.push({
                            id,
                            icon: 'build',
                            title: utils.t('due_service'),
                            meta: remaining <= 0 ? utils.t('overdue') : `${utils.t('due_in')} ${Math.max(0, Math.round(remaining)).toLocaleString()} ${utils.getDistUnit()}`,
                            dueDateIso: null,
                            editAction: `ui.openAddService(null,'periodic_maintenance')`
                        });
                    }
                }
                if (timeInt > 0 && lastDate) {
                    const nextDate = new Date(lastDate);
                    nextDate.setMonth(nextDate.getMonth() + timeInt);
                    const remainingDays = Math.ceil((nextDate - now) / 86400000);
                    if (remainingDays <= 30) {
                        const id = `svc:${vehicle.id}:time:${nextDate.toISOString().slice(0,10)}`;
                        items.push({
                            id,
                            icon: 'build',
                            title: utils.t('due_service'),
                            meta: remainingDays <= 0 ? utils.t('overdue') : `${utils.t('due_in')} ${utils.formatDaysShort(remainingDays)}`,
                            dueDateIso: nextDate.toISOString(),
                            editAction: `ui.openAddService(null,'periodic_maintenance')`,
                            calendarAction: `utils.exportDateCalendar('${utils.t('due_service')}: ${vehicle.make} ${vehicle.model}', '${nextDate.toISOString()}', 0)`
                        });
                    }
                }

                // Backup reminder (existing logic)
                const logs = store.getVehicleLogs();
                let showBackup = false;
                if (!store.data.settings.lastBackupDate) {
                    if (logs.length > 5) showBackup = true;
                } else {
                    const daysSince = (now - new Date(store.data.settings.lastBackupDate)) / 86400000;
                    if (daysSince > 30) showBackup = true;
                }
                if (showBackup) {
                    const id = `backup:${vehicle.id}`;
                    items.push({
                        id,
                        icon: 'cloud_upload',
                        title: utils.t('backup_needed'),
                        meta: utils.t('backup_desc'),
                        dueDateIso: null,
                        editAction: `ui.exportData(); ui.render();`
                    });
                }

                const visible = items.filter(it => {
                    if (done[it.id]) return false;
                    const until = snoozedUntil[it.id];
                    if (!until) return true;
                    return new Date(until) <= now;
                });

                return `
                    <div class="px-6 pt-safe min-h-screen pb-24">
                        <div class="flex items-center justify-between mb-4">
                            <h1 class="text-3xl font-black theme-text-heading">${utils.t('reminder_center')}</h1>
                            <button onclick="router.navigate('dashboard')" class="text-sm font-bold text-teal-600">${utils.t('dashboard')}</button>
                        </div>

                        <div class="space-y-3">
                            ${visible.length ? visible.map(it => `
                                <div class="theme-bg-card p-4 rounded-2xl card-shadow border theme-border">
                                    <div class="flex items-start justify-between gap-3">
                                        <div class="flex items-start gap-3">
                                            <div class="w-10 h-10 rounded-xl bg-slate-100 dark:bg-slate-800 flex items-center justify-center">
                                                <span class="material-icons text-slate-500">${it.icon}</span>
                                            </div>
                                            <div>
                                                <div class="font-bold theme-text-heading">${it.title}</div>
                                                <div class="text-xs theme-text-sub mt-0.5">${it.meta || '&nbsp;'}</div>
                                            </div>
                                        </div>
                                        <button onclick="${it.editAction}" class="text-slate-300 hover:text-sky-500"><span class="material-icons">edit</span></button>
                                    </div>
                                    <div class="flex gap-2 mt-3">
                                        <button onclick="ui.snoozeReminder('${it.id}', 7)" class="flex-1 py-2 rounded-xl text-xs font-bold bg-slate-100 dark:bg-slate-800 theme-text-heading">${utils.t('snooze_7d')}</button>
                                        <button onclick="ui.markReminderDone('${it.id}')" class="flex-1 py-2 rounded-xl text-xs font-bold bg-teal-600 text-white">${utils.t('mark_done')}</button>
                                        ${it.dueDateIso ? `<button onclick="utils.exportDateCalendar('${it.title}: ${vehicle.make} ${vehicle.model}', '${it.dueDateIso}', 0)" class="py-2 px-3 rounded-xl text-xs font-bold bg-blue-50 text-blue-700">ICS</button>` : ''}
                                    </div>
                                </div>
                            `).join('') : `<div class="text-center theme-text-sub py-12">No reminders</div>`}
                        </div>
                    </div>
                `;
            },

            renderFuel(vehicle) {
                const logs = store.getVehicleLogs('fuel');
                const filter = store.pageFilters.fuel;
                let filteredLogs = utils.filterLogs(logs, filter);
                const q = (store.pageFilters.fuelSearch || '').toLowerCase();
                if (q) {
                    filteredLogs = filteredLogs.filter(l =>
                        (l.location && l.location.toLowerCase().includes(q)) ||
                        (l.notes && l.notes.toLowerCase().includes(q))
                    );
                }
                const stats = utils.calculateStats(filteredLogs, 'fuel');
                
                return `
                    <div class="px-6 pt-safe min-h-screen">
                        <div class="flex justify-between items-center mb-6">
                             <h1 class="text-3xl font-black theme-text-heading">${utils.t('fuel')}</h1>
                        </div>
                        <div class="mb-4">${this.renderFilterHeader('fuel', filter)}</div>

                        <div class="mb-4 relative">
                            <span class="material-icons absolute left-3 top-2.5 text-slate-400 text-lg">search</span>
                            <input type="text" placeholder="Search..." value="${store.pageFilters.fuelSearch}" oninput="store.pageFilters.fuelSearch=this.value;ui.render()" class="w-full pl-10 pr-4 py-2 rounded-xl theme-bg-card theme-text-heading shadow-sm border-none focus:ring-2 focus:ring-teal-500 text-sm">
                        </div>

                        <div class="grid grid-cols-2 gap-3 mb-6">
                            <div class="theme-bg-card p-3 rounded-xl card-shadow border-l-4 border-teal-500">
                                <div class="text-[10px] theme-text-sub uppercase tracking-wider">${utils.t('efficiency')}</div>
                                <div class="text-lg font-bold text-teal-600">${stats.efficiency} <span class="text-[10px] font-normal">${utils.getEfficiencyLabel()}</span></div>
                            </div>
                            <div class="theme-bg-card p-3 rounded-xl card-shadow border-l-4 border-blue-500">
                                <div class="text-[10px] theme-text-sub uppercase tracking-wider">${utils.getCostPerDistLabel()}</div>
                                <div class="text-lg font-bold text-blue-600">${stats.costKm}</div>
                            </div>
                             <div class="theme-bg-card p-3 rounded-xl card-shadow">
                                <div class="text-[10px] theme-text-sub uppercase tracking-wider">${utils.t('total_cost')}</div>
                                <div class="text-lg font-bold theme-text-heading">${utils.formatCurrency(stats.totalCost)}</div>
                            </div>
                             <div class="theme-bg-card p-3 rounded-xl card-shadow">
                                <div class="text-[10px] theme-text-sub uppercase tracking-wider">${utils.t('total_dist')}</div>
                                <div class="text-lg font-bold theme-text-heading">${stats.totalDist} <span class="text-[10px] font-normal">${utils.getDistUnit()}</span></div>
                            </div>
                        </div>

                        <div class="space-y-3 pb-24">
                            ${filteredLogs.length ? filteredLogs.map(l => this.renderLogCard(l)).join('') : `<div class="text-center theme-text-sub py-12">No records found</div>`}
                        </div>
                        <button onclick="ui.openAddFuel()" class="fixed bottom-[calc(130px+var(--safe-bottom))] right-6 w-14 h-14 rounded-full grad-teal text-white shadow-xl flex items-center justify-center active:scale-90 transition-transform z-50">
                            <span class="material-icons">add</span>
                        </button>
                    </div>
                `;
            },
            
            renderMaintenance(vehicle) {
                const logs = store.getVehicleLogs(); 
                const maintLogs = logs.filter(l => l.type !== 'fuel' && l.type !== 'parking');
                const filter = store.pageFilters.maintenance;
                const view = store.pageFilters.maintenanceView || 'all';
                const selectedTypes = store.pageFilters.maintenanceTypes || [];
                
                let filteredLogs = utils.filterLogs(maintLogs, filter);
                if (selectedTypes.length) filteredLogs = filteredLogs.filter(l => selectedTypes.includes(l.type));
                const query = store.pageFilters.maintenanceSearch.toLowerCase();
                if (query) {
                    filteredLogs = filteredLogs.filter(l => 
                        (l.notes && l.notes.toLowerCase().includes(query)) ||
                        (l.tireBrand && l.tireBrand.toLowerCase().includes(query)) ||
                        utils.t(l.type).toLowerCase().includes(query) ||
                        (l.location && l.location.toLowerCase().includes(query))
                    );
                }
                const stats = utils.calculateStats(filteredLogs, 'maintenance');
                const tireTimeline = utils.getTireTimeline(vehicle);
                const tireTimelineFiltered = query
                    ? tireTimeline.filter(t => (t.lastReplace?.brand || '').toLowerCase().includes(query) || (t.currentPos && utils.t('tire_' + t.currentPos).toLowerCase().includes(query)))
                    : tireTimeline;

                return `
                    <div class="px-6 pt-safe min-h-screen">
                        <div class="flex justify-between items-center mb-2">
                             <h1 class="text-2xl font-black theme-text-heading">維修保養</h1>
                        </div>
                        <div class="mb-4">${this.renderFilterHeader('maintenance', filter)}</div>
                        
                        <div class="mb-4 relative">
                            <span class="material-icons absolute left-3 top-2.5 text-slate-400 text-lg">search</span>
                            <input type="text" placeholder="Search logs..." value="${store.pageFilters.maintenanceSearch}" oninput="store.pageFilters.maintenanceSearch=this.value;ui.render()" class="w-full pl-10 pr-4 py-2 rounded-xl theme-bg-card theme-text-heading shadow-sm border-none focus:ring-2 focus:ring-teal-500 text-sm">
                        </div>

                        <div class="flex bg-slate-100 dark:bg-slate-800 rounded-xl p-1 mb-3">
                            <button onclick="store.pageFilters.maintenanceView='all'; ui.render()" class="flex-1 py-2 text-xs font-bold rounded-lg ${view==='all'?'bg-white dark:bg-slate-700 shadow':''}">All</button>
                            <button onclick="store.pageFilters.maintenanceView='tires'; ui.render()" class="flex-1 py-2 text-xs font-bold rounded-lg ${view==='tires'?'bg-white dark:bg-slate-700 shadow':''}">${utils.t('tire_replace')}</button>
                        </div>

                        ${view === 'all' ? `
                            <div class="flex gap-2 overflow-x-auto no-scrollbar pb-2 mb-4">
                                <button onclick="store.pageFilters.maintenanceTypes=[]; ui.render()" class="shrink-0 px-3 py-1.5 rounded-full text-xs font-bold border ${selectedTypes.length ? 'bg-slate-50 dark:bg-slate-800 theme-border theme-text-sub' : 'bg-teal-600 text-white border-teal-600'}">All</button>
                                ${['service','repair','tire_replace','tire_rotation','periodic_maintenance','car_wash','car_accessories','fine','license','insurance','registration'].map(t => {
                                    const active = selectedTypes.includes(t);
                                    return `<button onclick="const s=store.pageFilters.maintenanceTypes||[]; store.pageFilters.maintenanceTypes = s.includes('${t}') ? s.filter(x=>x!=='${t}') : [...s,'${t}']; ui.render()" class="shrink-0 px-3 py-1.5 rounded-full text-xs font-bold border ${active ? 'bg-teal-50 text-teal-700 border-teal-200 dark:bg-teal-900/20' : 'bg-slate-50 dark:bg-slate-800 theme-border theme-text-sub'}">${utils.t(t)}</button>`;
                                }).join('')}
                            </div>
                        ` : ''}

                        <div class="theme-bg-card p-4 rounded-2xl card-shadow mb-6 flex justify-between items-center">
                            <div>
                                <div class="text-xs theme-text-sub uppercase tracking-wider">Maintenance Cost</div>
                                <div class="text-2xl font-black theme-text-heading">${utils.formatCurrency(stats.totalCost)}</div>
                            </div>
                            <div class="w-10 h-10 rounded-full bg-slate-100 dark:bg-slate-800 flex items-center justify-center">
                                <span class="material-icons text-slate-500">build</span>
                            </div>
                        </div>

                        <div class="space-y-3 pb-24">
                            ${view === 'tires'
                                ? (tireTimelineFiltered.length
                                    ? tireTimelineFiltered.map(t => `
                                        <div class="theme-bg-card p-4 rounded-2xl card-shadow">
                                            <div class="flex items-start justify-between gap-3">
                                                <div>
                                                    <div class="text-xs theme-text-sub font-bold">${t.currentPos ? utils.t('tire_' + t.currentPos) : utils.t('tire_positions')}</div>
                                                    <div class="text-lg font-black theme-text-heading">${t.lastReplace?.brand || utils.t('tire_not_set')}</div>
                                                    <div class="text-xs theme-text-sub mt-0.5">${t.lastReplace ? `${utils.formatDate(t.lastReplace.date)} • ${t.lastReplace.odometer} ${utils.getDistUnit()}` : '&nbsp;'}</div>
                                                </div>
                                                <div class="flex gap-2">
                                                    ${t.lastReplace?.logId
                                                        ? `<button onclick="ui.openAddService('${t.lastReplace.logId}')" class="text-slate-300 hover:text-sky-500"><span class="material-icons text-xl">edit</span></button>`
                                                        : `<button onclick="ui.openAddService(null,'tire_replace'); setTimeout(() => { const el=document.getElementById('l_tire_pos'); if (el && '${t.currentPos || ''}') el.value='${t.currentPos || 'front_left'}'; }, 60);" class="text-xs font-bold text-teal-600 bg-teal-50 dark:bg-teal-900/20 px-2 py-1 rounded-lg">+ ${utils.t('tire_replace')}</button>`
                                                    }
                                                </div>
                                            </div>
                                            <div class="mt-3 space-y-2">
                                                ${(t.events || []).slice().sort((a,b) => (parseFloat(b.odometer)||0) - (parseFloat(a.odometer)||0)).slice(0, 8).map(ev => {
                                                    if (ev.kind === 'replace') {
                                                        return `<div class="flex items-center justify-between text-xs bg-slate-50 dark:bg-slate-800/50 p-2 rounded-lg">
                                                            <div class="flex items-center gap-2">
                                                                <span class="material-icons text-slate-400 text-sm">tire_repair</span>
                                                                <span class="font-bold theme-text-heading">${utils.t('tire_replace')}</span>
                                                                <span class="theme-text-sub">${utils.t('tire_' + ev.pos)}</span>
                                                            </div>
                                                            <div class="theme-text-sub">${ev.odometer} ${utils.getDistUnit()}</div>
                                                        </div>`;
                                                    }
                                                    return `<div class="flex items-center justify-between text-xs bg-slate-50 dark:bg-slate-800/50 p-2 rounded-lg">
                                                        <div class="flex items-center gap-2">
                                                            <span class="material-icons text-slate-400 text-sm">sync_alt</span>
                                                            <span class="font-bold theme-text-heading">${utils.t('tire_rotation')}</span>
                                                            <span class="theme-text-sub">${utils.t('tire_' + ev.from)} → ${utils.t('tire_' + ev.to)}</span>
                                                        </div>
                                                        <div class="theme-text-sub">${ev.odometer} ${utils.getDistUnit()}</div>
                                                    </div>`;
                                                }).join('') || `<div class="text-center theme-text-sub text-sm py-3">No tire events</div>`}
                                            </div>
                                        </div>
                                    `).join('')
                                    : `<div class="text-center theme-text-sub py-12">No tire records found</div>`)
                                : (filteredLogs.length ? filteredLogs.map(l => this.renderLogCard(l)).join('') : `<div class="text-center theme-text-sub py-12">No records found</div>`)}
                        </div>
                        <button onclick="ui.openAddService()" class="fixed bottom-[calc(130px+var(--safe-bottom))] right-6 w-14 h-14 rounded-full bg-white dark:bg-slate-700 theme-text-heading shadow-xl flex items-center justify-center active:scale-90 transition-transform z-50 border theme-border">
                            <span class="material-icons">add</span>
                        </button>
                    </div>
                `;
            },
            
            renderParking(vehicle) {
                const logs = store.getVehicleLogs('parking');
                const filter = store.pageFilters.parking;
                let filteredLogs = utils.filterLogs(logs, filter);
                const q = (store.pageFilters.parkingSearch || '').toLowerCase();
                if (q) {
                    filteredLogs = filteredLogs.filter(l =>
                        (l.location && l.location.toLowerCase().includes(q)) ||
                        (l.notes && l.notes.toLowerCase().includes(q))
                    );
                }
                const stats = utils.calculateStats(filteredLogs, 'parking');
                
                return `
                     <div class="px-6 pt-safe min-h-screen">
                        <div class="flex justify-between items-center mb-6">
                             <h1 class="text-3xl font-black text-blue-600">${utils.t('parking')}</h1>
                        </div>
                        <div class="mb-4">${this.renderFilterHeader('parking', filter)}</div>

                        <div class="mb-4 relative">
                            <span class="material-icons absolute left-3 top-2.5 text-slate-400 text-lg">search</span>
                            <input type="text" placeholder="Search..." value="${store.pageFilters.parkingSearch}" oninput="store.pageFilters.parkingSearch=this.value;ui.render()" class="w-full pl-10 pr-4 py-2 rounded-xl theme-bg-card theme-text-heading shadow-sm border-none focus:ring-2 focus:ring-blue-500 text-sm">
                        </div>
                        
                        <div class="theme-bg-card p-4 rounded-2xl card-shadow mb-6">
                             <div class="text-xs theme-text-sub uppercase tracking-wider">${utils.t('parking_fee')}</div>
                             <div class="text-3xl font-black theme-text-heading">${utils.formatCurrency(stats.totalCost)}</div>
                        </div>
                        
                        <div class="space-y-3 pb-24">
                            ${filteredLogs.length ? filteredLogs.map(l => this.renderLogCard(l)).join('') : `<div class="text-center theme-text-sub py-12">No records yet</div>`}
                        </div>
                        <button onclick="ui.openAddParking()" class="fixed bottom-[calc(130px+var(--safe-bottom))] right-6 w-14 h-14 rounded-full bg-blue-600 text-white shadow-xl flex items-center justify-center active:scale-90 transition-transform z-50">
                            <span class="material-icons">add</span>
                        </button>
                     </div>
                `;
            },
            
            renderAnalytics(vehicle) {
                const logs = store.getVehicleLogs();
                const filter = store.pageFilters.analytics;
                const filteredLogs = utils.filterLogs(logs, filter);
                
                const fuelCost = filteredLogs.filter(l => l.type === 'fuel').reduce((s,l) => s + (Number.isFinite(parseFloat(l.cost)) ? parseFloat(l.cost) : 0), 0);
                const serviceCost = filteredLogs.filter(l => !['fuel','parking','fine'].includes(l.type)).reduce((s,l) => s + (Number.isFinite(parseFloat(l.cost)) ? parseFloat(l.cost) : 0), 0);
                const parkingCost = filteredLogs.filter(l => l.type === 'parking').reduce((s,l) => s + (Number.isFinite(parseFloat(l.cost)) ? parseFloat(l.cost) : 0), 0);
                const fineCost = filteredLogs.filter(l => l.type === 'fine').reduce((s,l) => s + (Number.isFinite(parseFloat(l.cost)) ? parseFloat(l.cost) : 0), 0);
                const total = fuelCost + serviceCost + parkingCost + fineCost;
                
                const fixedLogs = filteredLogs.filter(l => ['license', 'insurance', 'registration'].includes(l.type));
                const fixedTotal = fixedLogs.reduce((sum, l) => sum + (Number.isFinite(parseFloat(l.cost)) ? parseFloat(l.cost) : 0), 0);
                
                let pieHtml = '';
                if (total > 0) {
                     const r = 50, cx = 60, cy = 60;
                     let startA = 0;
                     const slices = [
                         { val: fuelCost, col: '#0d9488' },
                         { val: serviceCost, col: '#a855f7' },
                         { val: parkingCost, col: '#3b82f6' },
                         { val: fineCost, col: '#ef4444' }
                     ];
                     pieHtml = slices.map(s => {
                         if (s.val <= 0) return '';
                         const angle = (s.val / total) * 360;
                         const large = angle > 180 ? 1 : 0;
                         const endA = startA + angle;
                         const x1 = cx + r * Math.cos(Math.PI*startA/180);
                         const y1 = cy + r * Math.sin(Math.PI*startA/180);
                         const x2 = cx + r * Math.cos(Math.PI*endA/180);
                         const y2 = cy + r * Math.sin(Math.PI*endA/180);
                         const path = total === s.val ? `M${cx-r},${cy} a${r},${r} 0 1,0 ${r*2},0 a${r},${r} 0 1,0 -${r*2},0` : `M${cx},${cy} L${x1},${y1} A${r},${r} 0 ${large},1 ${x2},${y2} Z`;
                         startA += angle;
                         return `<path d="${path}" fill="${s.col}" />`;
                     }).join('');
                     pieHtml = `<svg viewBox="0 0 120 120" class="w-32 h-32 mx-auto drop-shadow-lg">${pieHtml}</svg>`;
                }
                
                return `
                    <div class="px-6 pt-safe min-h-screen">
                        <div class="flex justify-between items-center mb-6">
                             <h1 class="text-3xl font-black theme-text-heading">${utils.t('analytics')}</h1>
                        </div>
                        <div class="mb-4">${this.renderFilterHeader('analytics', filter)}</div>

                        <div class="grid grid-cols-2 gap-4 mb-6">
                            <div class="theme-bg-card p-4 rounded-2xl card-shadow">
                                <div class="text-xs theme-text-sub uppercase mb-2">Total Spend</div>
                                <div class="text-2xl font-black theme-text-heading">${utils.formatCurrency(total)}</div>
                            </div>
                            <div class="theme-bg-card p-4 rounded-2xl card-shadow">
                                <div class="text-xs theme-text-sub uppercase mb-2">Fixed Costs</div>
                                <div class="text-2xl font-black text-purple-600">${utils.formatCurrency(fixedTotal)}</div>
                            </div>
                        </div>
                        
                        <div class="theme-bg-card p-4 rounded-2xl card-shadow mb-6">
                            <div class="text-xs font-bold theme-text-sub uppercase mb-4">${utils.t('monthly_spend')} (6 Months)</div>
                            <div class="h-40">
                                ${utils.generateMonthlyBarChart(logs)}
                            </div>
                            <div class="flex justify-center gap-4 mt-2 text-[10px] theme-text-sub">
                                <div class="flex items-center gap-1"><div class="w-2 h-2 rounded-full bg-teal-500"></div>Fuel</div>
                                <div class="flex items-center gap-1"><div class="w-2 h-2 rounded-full bg-orange-400"></div>Service</div>
                            </div>
                        </div>

                        <div class="flex items-center gap-6 mb-8 theme-bg-card p-6 rounded-2xl card-shadow">
                            <div class="flex-1">
                                <div class="space-y-3">
                                    <div class="flex justify-between text-xs"><span class="flex items-center gap-2"><div class="w-2 h-2 rounded-full bg-teal-600"></div>${utils.t('fuel')}</span> <span class="font-bold">${utils.formatCurrency(fuelCost)}</span></div>
                                    <div class="flex justify-between text-xs"><span class="flex items-center gap-2"><div class="w-2 h-2 rounded-full bg-purple-500"></div>${utils.t('maintenance')}</span> <span class="font-bold">${utils.formatCurrency(serviceCost)}</span></div>
                                    <div class="flex justify-between text-xs"><span class="flex items-center gap-2"><div class="w-2 h-2 rounded-full bg-blue-500"></div>${utils.t('parking')}</span> <span class="font-bold">${utils.formatCurrency(parkingCost)}</span></div>
                                    <div class="flex justify-between text-xs"><span class="flex items-center gap-2"><div class="w-2 h-2 rounded-full bg-red-500"></div>${utils.t('traffic_fine')}</span> <span class="font-bold">${utils.formatCurrency(fineCost)}</span></div>
                                </div>
                            </div>
                            <div>${pieHtml}</div>
                        </div>
                        
                        <div class="theme-bg-card p-6 rounded-2xl card-shadow mb-24">
                            <div class="text-xs font-bold theme-text-sub uppercase mb-4">Fuel Efficiency Trend</div>
                            <div class="h-32">
                                ${utils.generateTrendChart(logs)}
                            </div>
                        </div>
                    </div>
                `;
            },
            
            renderSettings(vehicle) {
                const settings = store.data.settings;
                return `
                    <div class="px-6 pt-safe min-h-screen pb-24">
                        <h1 class="text-3xl font-black theme-text-heading mb-6">${utils.t('settings')}</h1>
                        
                        <div class="bg-white dark:bg-slate-800 rounded-2xl p-4 card-shadow mb-6">
                            <div class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-4">Vehicle Management</div>
                            ${store.data.vehicles.map(v => `
                                <div class="flex items-center justify-between py-3 border-b theme-border last:border-0">
                                    <div class="flex items-center gap-3">
                                        <div class="w-10 h-10 rounded-full flex items-center justify-center text-white ${utils.getCarColorClass(v.color)}">
                                            <span class="material-icons text-lg">${utils.getCarIcon(v.type)}</span>
                                        </div>
                                        <div>
                                            <div class="font-bold theme-text-heading">${v.make} ${v.model}</div>
                                            <div class="text-xs theme-text-sub">${v.year} • ${v.currentOdometer} ${utils.getDistUnit()}</div>
                                        </div>
                                    </div>
                                    <button onclick="ui.openAddVehicle('${v.id}')" class="text-teal-500"><span class="material-icons">edit</span></button>
                                </div>
                            `).join('')}
                            <button onclick="ui.openAddVehicle()" class="w-full mt-4 py-2 border border-dashed border-teal-500 text-teal-600 rounded-xl text-sm font-bold hover:bg-teal-50 dark:hover:bg-teal-900/20 transition">+ ${utils.t('add_vehicle')}</button>
                        </div>
                        
                        <div class="bg-white dark:bg-slate-800 rounded-2xl p-4 card-shadow mb-6">
                             <div class="flex items-center justify-between mb-4">
                                 <div class="text-xs font-bold text-slate-400 uppercase tracking-wider">${utils.t('reminder_settings')}</div>
                                 <button onclick="router.navigate('reminders')" class="text-[10px] font-bold text-slate-400 underline">${utils.t('reminder_center')}</button>
                             </div>
                             ${['license','insurance','registration'].map(type => {
                                 const conf = settings.reminders?.[type] || { enabled: true, days: 30 };
                                 return `
                                    <div class="flex items-center justify-between py-3 border-b theme-border last:border-0">
                                        <div class="text-sm font-bold theme-text-heading">${utils.t(type)}</div>
                                        <div class="flex items-center gap-2">
                                            <select onchange="store.data.settings.reminders['${type}'] = { ...store.data.settings.reminders['${type}'], days: this.value }; store.saveData();" class="text-xs p-1 rounded bg-slate-100 dark:bg-slate-700">
                                                <option value="30" ${conf.days==30?'selected':''}>${utils.t('rem_1m')}</option>
                                                <option value="7" ${conf.days==7?'selected':''}>${utils.t('rem_1w')}</option>
                                            </select>
                                            <div onclick="const s=store.data.settings.reminders['${type}']||{days:30}; s.enabled=!s.enabled; store.data.settings.reminders['${type}']=s; store.saveData(); ui.render()" class="w-10 h-6 rounded-full relative cursor-pointer transition-colors ${conf.enabled ? 'bg-teal-500' : 'bg-slate-300'}">
                                                <div class="w-4 h-4 bg-white rounded-full absolute top-1 transition-all ${conf.enabled ? 'left-5' : 'left-1'}"></div>
                                            </div>
                                        </div>
                                    </div>
                                 `;
                             }).join('')}
                        </div>
                        
                        <!-- Maintenance Interval Split -->
                        <div class="bg-white dark:bg-slate-800 rounded-2xl p-4 card-shadow mb-6">
                            <div class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3">${utils.t('service_interval')}</div>
                            <div class="space-y-3">
                                <div>
                                    <label class="text-xs theme-text-sub block mb-1">${utils.t('service_interval_dist')}</label>
                                    <select onchange="store.data.settings.maintenanceDist = this.value; store.saveData(); ui.render()" class="w-full p-2.5 rounded-xl bg-slate-50 dark:bg-slate-700 theme-text-heading text-sm">
                                        <option value="none" ${settings.maintenanceDist==='none'?'selected':''}>${utils.t('int_none')}</option>
                                        <option value="5000" ${settings.maintenanceDist==='5000'?'selected':''}>${utils.t('int_5k')}</option>
                                        <option value="10000" ${settings.maintenanceDist==='10000'?'selected':''}>${utils.t('int_10k')}</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="text-xs theme-text-sub block mb-1">${utils.t('service_interval_time')}</label>
                                    <select onchange="store.data.settings.maintenanceTime = this.value; store.saveData(); ui.render()" class="w-full p-2.5 rounded-xl bg-slate-50 dark:bg-slate-700 theme-text-heading text-sm">
                                        <option value="none" ${settings.maintenanceTime==='none'?'selected':''}>${utils.t('int_none')}</option>
                                        <option value="6" ${settings.maintenanceTime==='6'?'selected':''}>${utils.t('int_6m')}</option>
                                        <option value="12" ${settings.maintenanceTime==='12'?'selected':''}>${utils.t('int_1yr')}</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Tire Replacement Interval -->
                        <div class="bg-white dark:bg-slate-800 rounded-2xl p-4 card-shadow mb-6">
                            <div class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3">${utils.t('tire_replace')}</div>
                            <div class="space-y-3">
                                <div>
                                    <label class="text-xs theme-text-sub block mb-1">${utils.t('tire_interval_dist')} (${utils.getDistUnit()})</label>
                                    <input type="number" min="0" step="100" value="${settings.tireReplaceDist ?? 40000}" onchange="store.data.settings.tireReplaceDist = parseInt(this.value)||0; store.saveData(); ui.render()" class="w-full p-2.5 rounded-xl bg-slate-50 dark:bg-slate-700 theme-text-heading text-sm">
                                </div>
                                <div>
                                    <label class="text-xs theme-text-sub block mb-1">${utils.t('tire_interval_time')}</label>
                                    <select onchange="store.data.settings.tireReplaceYears = parseInt(this.value)||0; store.saveData(); ui.render()" class="w-full p-2.5 rounded-xl bg-slate-50 dark:bg-slate-700 theme-text-heading text-sm">
                                        ${[0,2,3,4,5,6].map(y => `<option value="${y}" ${parseInt(settings.tireReplaceYears)==y?'selected':''}>${y===0 ? utils.t('int_none') : y}</option>`).join('')}
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white dark:bg-slate-800 rounded-2xl p-4 card-shadow mb-6">
                            <div class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-4">App Settings</div>
                            <div class="space-y-4">
                                <div>
                                    <label class="text-xs theme-text-sub block mb-1">${utils.t('units')}</label>
                                    <div class="flex bg-slate-100 dark:bg-slate-700 rounded-lg p-1">
                                        <button onclick="store.data.settings.units='metric';store.saveData();ui.render()" class="flex-1 py-1 text-xs rounded-md ${settings.units==='metric'?'bg-white dark:bg-slate-600 shadow':''}">${utils.t('metric')}</button>
                                        <button onclick="store.data.settings.units='imperial';store.saveData();ui.render()" class="flex-1 py-1 text-xs rounded-md ${settings.units==='imperial'?'bg-white dark:bg-slate-600 shadow':''}">${utils.t('imperial')}</button>
                                    </div>
                                </div>
                                <div>
                                    <label class="text-xs theme-text-sub block mb-1">${utils.t('currency')}</label>
                                    <select onchange="store.data.settings.currency=this.value;store.saveData();ui.render()" class="w-full p-2 rounded-lg text-sm">
                                        ${['$','€','£','¥','HK$','A$','NT$'].map(c => `<option value="${c}" ${settings.currency===c?'selected':''}>${c}</option>`).join('')}
                                    </select>
                                </div>
                                <div>
                                    <label class="text-xs theme-text-sub block mb-1">${utils.t('language')}</label>
                                    <select onchange="store.data.settings.language=this.value;store.saveData();ui.render()" class="w-full p-2 rounded-lg text-sm">
                                        <option value="en" ${settings.language==='en'?'selected':''}>English</option>
                                        <option value="zh" ${settings.language==='zh'?'selected':''}>繁體中文</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-3 mb-8">
                            <button onclick="ui.exportData()" class="bg-blue-50 text-blue-600 p-4 rounded-xl text-sm font-bold flex flex-col items-center gap-2"><span class="material-icons">download</span> ${utils.t('export_json')}</button>
                            <button onclick="document.getElementById('importFile').click()" class="bg-purple-50 text-purple-600 p-4 rounded-xl text-sm font-bold flex flex-col items-center gap-2"><span class="material-icons">upload</span> ${utils.t('import_json')}</button>
                            <input type="file" id="importFile" class="hidden" accept=".json" onchange="ui.importData(this)">
                            <button onclick="ui.exportCSV()" class="col-span-2 bg-green-50 text-green-600 p-4 rounded-xl text-sm font-bold flex items-center justify-center gap-2"><span class="material-icons">table_view</span> ${utils.t('export_csv')}</button>
                        </div>
                        
                        <div class="text-center">
                            <button onclick="ui.openAboutModal()" class="text-teal-600 text-sm font-bold flex items-center justify-center gap-2 opacity-80 hover:opacity-100">
                                <span class="material-icons">info</span> ${utils.t('about')}
                            </button>
                            <div class="text-[10px] theme-text-sub mt-2">v2.1 IndexedDB • Built for iOS</div>
                        </div>
                    </div>
                `;
            },
            
            renderLogCard(log) {
                const vehicle = store.data.vehicles.find(v => v.id === log.vehicleId);
                const date = utils.formatDate(log.date);
                let icon = 'edit_note';
                let colorClass = 'bg-slate-100 text-slate-600';
                let title = utils.t(log.type);
                
                if (log.type === 'fuel') { 
                    icon = 'local_gas_station'; 
                    colorClass = 'bg-teal-50 text-teal-600'; 
                } else if (log.type === 'parking') {
                    icon = 'local_parking';
                    colorClass = 'bg-blue-50 text-blue-600';
                } else if (log.type === 'fine') {
                    icon = 'local_police';
                    colorClass = 'bg-red-50 text-red-600';
                    if (log.notes) title = utils.t(log.notes.split(',')[0]); // Use first tag as title
                } else if (log.type === 'tire_replace') {
                    icon = 'tire_repair';
                    colorClass = 'bg-slate-50 text-slate-700';
                    const posLabel = log.tirePosition ? utils.t('tire_' + log.tirePosition) : '';
                    const brand = log.tireBrand ? ` • ${log.tireBrand}` : '';
                    title = `${utils.t('tire_replace')}${posLabel ? ' • ' + posLabel : ''}${brand}`;
                } else if (log.type === 'tire_rotation') {
                    icon = 'sync_alt';
                    colorClass = 'bg-slate-50 text-slate-700';
                    const swaps = Array.isArray(log.tireSwaps) && log.tireSwaps.length
                        ? log.tireSwaps
                        : (log.tireSwapA && log.tireSwapB ? [{ a: log.tireSwapA, b: log.tireSwapB }] : []);
                    const swapText = swaps
                        .map(s => {
                            const a = s?.a ? utils.t('tire_' + s.a) : '';
                            const b = s?.b ? utils.t('tire_' + s.b) : '';
                            return a && b ? `${a} ↔ ${b}` : '';
                        })
                        .filter(Boolean)
                        .join(', ');
                    title = `${utils.t('tire_rotation')}${swapText ? ` • ${swapText}` : ''}`;
                } else if (['license', 'insurance', 'registration'].includes(log.type)) {
                    icon = 'assignment';
                    colorClass = 'bg-purple-50 text-purple-600';
                } else if (log.type === 'periodic_maintenance') {
                    icon = 'update';
                    colorClass = 'bg-amber-50 text-amber-600';
                } else if (log.type === 'car_wash') {
                     icon = 'local_car_wash';
                     colorClass = 'bg-cyan-50 text-cyan-600';
                } else if (log.type === 'car_accessories') {
                     icon = 'shopping_bag';
                     colorClass = 'bg-pink-50 text-pink-600';
                }

                // Fuel Stats Logic
                let fuelStatsHtml = '';
                if (log.type === 'fuel') {
                    const allFuel = store.getVehicleLogs('fuel');
                    const idx = allFuel.findIndex(l => l.id === log.id);
                    let effVal = '--', costKm = '--';
                    const v = store.getActiveVehicle();
                    const isImperial = store.data.settings.units === 'imperial';
                    const isEV = v && v.fuelUnit === 'kWh';
                    
                    // Logic to span over Partial logs
                    if (!log.isPartial) {
                         let foundPrevFull = false;
                         let prevLog = null;
                         let accumulatedLiters = 0;
                         let accumulatedCost = 0;
                         
                         // Look backwards from the current log
                         for (let i = idx + 1; i < allFuel.length; i++) {
                             const p = allFuel[i];
                             if (p.isPartial) {
                                 accumulatedLiters += parseFloat(p.liters);
                                 accumulatedCost += parseFloat(p.cost);
                             } else {
                                 foundPrevFull = true;
                                 prevLog = p;
                                 break;
                             }
                         }
                         
                         if (foundPrevFull && prevLog) {
                             // Current log liters + accumulated partials
                             // Distance is from Prev Full to Current Full
                             const dist = log.odometer - prevLog.odometer;
                             const totalFuel = parseFloat(log.liters) + accumulatedLiters;
                             const totalCost = parseFloat(log.cost) + accumulatedCost;
                             
                             if (dist > 0) {
                                 if (totalFuel > 0) {
                                     if (isEV) effVal = ((totalFuel / dist) * 100).toFixed(1);
                                     else if (isImperial) effVal = (dist / totalFuel).toFixed(1);
                                     else effVal = ((totalFuel / dist) * 100).toFixed(1);
                                 }
                                 costKm = (totalCost / dist).toFixed(2);
                             }
                         }
                    }
                    
                    fuelStatsHtml = `
                        <div class="mt-3 pt-3 border-t theme-border flex justify-between text-xs">
                            <div>
                                <div class="theme-text-sub mb-0.5 uppercase tracking-wider text-[10px]">${utils.getEfficiencyLabel()}</div>
                                <div class="font-bold text-teal-600 text-sm">${effVal}</div>
                            </div>
                             <div class="text-right">
                                <div class="theme-text-sub mb-0.5 uppercase tracking-wider text-[10px]">${utils.getCostPerDistLabel()}</div>
                                <div class="font-bold text-teal-600 text-sm">${utils.formatCurrency(costKm)}</div>
                            </div>
                        </div>
                    `;
                }
                
                let locHtml = '';
                if (log.location) {
                    locHtml = `<a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(log.location)}" target="_blank" class="text-xs text-sky-500 hover:underline flex items-center gap-1 mt-1" onclick="event.stopPropagation()"><span class="material-icons text-[10px]">place</span>${log.location}</a>`;
                }

                let extraInfoHtml = '';
                if (log.type === 'fuel') {
                    const unit = vehicle ? (vehicle.fuelUnit || 'L') : 'L';
                    const ppu = (parseFloat(log.cost) / parseFloat(log.liters)).toFixed(2);
                    extraInfoHtml = `<div class="text-xs theme-text-sub mt-0.5"><span class="font-semibold theme-text-main">${log.liters} ${unit}</span> <span class="opacity-75">@ ${store.data.settings.currency}${ppu}/${unit}</span></div>`;
                }

                return `
                    <div class="theme-bg-card p-4 rounded-2xl card-shadow relative group">
                        <div class="flex justify-between items-start">
                            <div class="flex gap-3">
                                <div class="w-10 h-10 rounded-xl flex items-center justify-center ${colorClass}">
                                    <span class="material-icons">${icon}</span>
                                </div>
                                <div>
                                    <div class="font-bold text-sm theme-text-heading">${date}</div>
                                    <div class="text-xs theme-text-heading font-semibold mt-0.5">${title} ${log.isPartial ? `<span class="text-amber-500 text-[10px] border border-amber-500 px-1 rounded ml-1">${utils.t('partial')}</span>` : ''}</div>
                                    <div class="text-xs theme-text-sub mt-0.5">${log.odometer} ${utils.getDistUnit()}</div>
                                    ${extraInfoHtml}
                                    ${locHtml}
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="font-bold theme-text-heading">${utils.formatCurrency(log.cost)}</div>
                                <button onclick="ui.openAdd${log.type === 'fuel' ? 'Fuel' : (log.type === 'parking' ? 'Parking' : 'Service')}('${log.id}')" class="text-slate-300 hover:text-sky-500 mt-2"><span class="material-icons text-lg">edit</span></button>
                            </div>
                        </div>
                        ${fuelStatsHtml}
                        ${log.notes && log.type !== 'fine' ? `<div class="mt-2 text-xs theme-text-sub bg-slate-50 dark:bg-slate-800 p-2 rounded-lg italic">${log.notes}</div>` : ''}
                    </div>
                `;
            },
            
            renderBottomNav(active) {
                const nav = [
                    { id: 'dashboard', icon: 'dashboard', label: utils.t('dashboard') },
                    { id: 'fuel', icon: 'local_gas_station', label: utils.t('fuel') },
                    { id: 'parking', icon: 'local_parking', label: utils.t('parking') },
                    { id: 'maintenance', icon: 'build', label: 'Service+' },
                    { id: 'analytics', icon: 'pie_chart', label: utils.t('analytics') },
                    { id: 'settings', icon: 'settings', label: utils.t('settings') }
                ];
                return `
                    <div class="fixed bottom-0 left-0 w-full glass-nav nav-safe z-40">
                        <div class="flex justify-around items-center pt-2">
                            ${nav.map(n => `
                                <button onclick="router.navigate('${n.id}')" class="flex flex-col items-center p-2 w-full transition-colors ${active === n.id ? 'text-teal-600' : 'text-slate-400'}">
                                    <span class="material-icons ${active === n.id ? 'text-2xl' : 'text-xl'}">${n.icon}</span>
                                    <span class="text-[10px] font-medium mt-1">${n.label}</span>
                                </button>
                            `).join('')}
                        </div>
                    </div>
                `;
            },

            // --- MODALS ---
            openModal(html) {
                const overlay = document.getElementById('modal-overlay');
                const content = document.getElementById('modal-content');
                content.innerHTML = html;
                overlay.classList.remove('hidden');
                setTimeout(() => {
                    overlay.classList.remove('opacity-0');
                    content.classList.remove('translate-y-full');
                }, 10);
            },
            closeModal() {
                const overlay = document.getElementById('modal-overlay');
                const content = document.getElementById('modal-content');
                overlay.classList.add('opacity-0');
                content.classList.add('translate-y-full');
                setTimeout(() => overlay.classList.add('hidden'), 300);
            },

            openAddVehicle(id = null) {
                const v = id ? store.data.vehicles.find(v => v.id === id) : { make: '', model: '', year: new Date().getFullYear(), currentOdometer: '', color: 'teal', type: 'sedan', fuelUnit: 'L' };
                const colors = ['teal','blue','red','black','white','yellow','purple','green','orange','brown','grey','pink','cyan'];
                
                this.openModal(`
                    <h2 class="text-xl font-bold mb-4 theme-text-heading">${id ? utils.t('edit_vehicle') : utils.t('add_vehicle')}</h2>
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-3">
                            <div><label class="text-xs theme-text-sub block mb-1">Make</label><input id="v_make" type="text" value="${v.make}" class="w-full p-3 rounded-xl" placeholder="Honda"></div>
                            <div><label class="text-xs theme-text-sub block mb-1">Model</label><input id="v_model" type="text" value="${v.model}" class="w-full p-3 rounded-xl" placeholder="Civic"></div>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                             <div><label class="text-xs theme-text-sub block mb-1">Year</label><input id="v_year" type="number" value="${v.year}" class="w-full p-3 rounded-xl"></div>
                             <div><label class="text-xs theme-text-sub block mb-1">${utils.t('odometer')}</label><input id="v_odo" type="number" value="${v.currentOdometer}" class="w-full p-3 rounded-xl"></div>
                        </div>
                        
                        <div>
                             <label class="text-xs theme-text-sub block mb-1">${utils.t('color')}</label>
                             <div class="grid grid-cols-7 gap-2">
                                 ${colors.map(c => `
                                     <label class="cursor-pointer relative flex items-center justify-center">
                                         <input type="radio" name="v_color" value="${c}" class="sr-only color-radio" ${v.color===c ? 'checked' : ''}>
                                         <div class="w-8 h-8 rounded-full ${utils.getCarColorClass(c)} transition-transform hover:scale-110"></div>
                                     </label>
                                 `).join('')}
                             </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-3">
                             <div>
                                <label class="text-xs theme-text-sub block mb-1">${utils.t('type')}</label>
                                <select id="v_type" class="w-full p-3 rounded-xl text-sm">
                                    ${['sedan','suv','bike','truck','sports','van','bus'].map(t => `<option value="${t}" ${v.type===t?'selected':''}>${utils.t('type_'+t)}</option>`).join('')}
                                </select>
                             </div>
                             <div>
                                <label class="text-xs theme-text-sub block mb-1">Fuel/Energy</label>
                                <select id="v_unit" class="w-full p-3 rounded-xl text-sm">
                                    <option value="L" ${v.fuelUnit==='L'?'selected':''}>Liters (Gas)</option>
                                    <option value="Gal" ${v.fuelUnit==='Gal'?'selected':''}>Gallons (Gas)</option>
                                    <option value="kWh" ${v.fuelUnit==='kWh'?'selected':''}>kWh (EV)</option>
                                </select>
                             </div>
                        </div>

                        <div class="flex gap-3 mt-6">
                            ${id ? `<button onclick="ui.deleteVehicle('${id}')" class="flex-1 bg-red-50 text-red-600 py-3 rounded-xl font-bold">${utils.t('delete')}</button>` : ''}
                            <button onclick="ui.saveVehicle('${id || ''}')" class="flex-1 grad-teal text-white py-3 rounded-xl font-bold shadow-lg">${utils.t('save')}</button>
                        </div>
                        ${id ? `<button onclick="ui.clearVehicleData('${id}')" class="w-full mt-2 text-xs text-red-400 py-2 border border-red-100 rounded-xl hover:bg-red-50">${utils.t('clear_history')}</button>` : ''}
                    </div>
                `);
            },
            
            async saveVehicle(id) {
                const make = document.getElementById('v_make').value;
                const model = document.getElementById('v_model').value;
                if (!make || !model) return alert('Make and Model are required');
                
                const vehicle = {
                    id: id || utils.newId(),
                    make, model,
                    year: document.getElementById('v_year').value,
                    currentOdometer: parseInt(document.getElementById('v_odo').value) || 0,
                    color: document.querySelector('input[name="v_color"]:checked').value,
                    type: document.getElementById('v_type').value,
                    fuelUnit: document.getElementById('v_unit').value
                };
                
                if (id) await store.updateVehicle(vehicle);
                else await store.addVehicle(vehicle);
                
                this.closeModal();
                this.render();
            },
            
            deleteVehicle(id) {
                setTimeout(() => {
                    if (confirm(utils.t('confirm_delete'))) {
                        store.deleteVehicle(id).then(() => {
                            this.closeModal();
                            this.render();
                        });
                    }
                }, 50);
            },
            
            clearVehicleData(id) {
                setTimeout(() => {
                    if (confirm(utils.t('confirm_clear'))) {
                        setTimeout(() => {
                            if (confirm(utils.t('confirm_clear_2'))) {
                                store.clearVehicleLogs(id).then(() => {
                                    this.closeModal();
                                    this.render();
                                });
                            }
                        }, 200);
                    }
                }, 50);
            },

            openAddFuel(id = null) {
                const log = id ? store.data.logs.find(l => l.id === id) : { date: new Date().toISOString().slice(0, 10), odometer: store.getActiveVehicle()?.currentOdometer || '', liters: '', cost: '', location: '', notes: '', isPartial: false };
                const fuelUnit = utils.getFuelUnit();
                const volLabel = fuelUnit === 'kWh' ? utils.t('kwh') : (fuelUnit === 'Gal' ? utils.t('gallons') : utils.t('liters'));
                
                this.openModal(`
                    <h2 class="text-xl font-bold mb-4 theme-text-heading flex items-center gap-2"><span class="material-icons text-teal-600">local_gas_station</span> ${utils.t('add_fuel')}</h2>
                    <div class="space-y-4">
                        <div><label class="text-xs theme-text-sub block mb-1">${utils.t('date')}</label><input id="l_date" type="date" value="${log.date}" class="w-full p-3 rounded-xl"></div>
                        
                         <div>
                            <div class="flex justify-between items-center mb-1">
                                <label class="text-xs theme-text-sub">${utils.t('odometer')}</label>
                                <button onclick="this.innerText = this.innerText==='TRIP' ? 'ODO' : 'TRIP'; document.getElementById('l_odo').placeholder = this.innerText==='TRIP' ? 'Trip Dist (e.g. 400)' : 'Total Odo';" class="text-[10px] bg-slate-200 px-2 py-0.5 rounded font-bold">ODO</button>
                            </div>
                            <input id="l_odo" type="number" value="${log.odometer}" class="w-full p-3 rounded-xl" onblur="if(this.placeholder.includes('Trip')){ this.value = ${store.getActiveVehicle()?.currentOdometer || 0} + parseInt(this.value||0); }">
                        </div>

                        <div class="grid grid-cols-2 gap-3">
                            <div><label class="text-xs theme-text-sub block mb-1">${volLabel}</label><input id="l_liters" type="number" step="0.01" value="${log.liters}" class="w-full p-3 rounded-xl" oninput="ui.calcFuel('vol')"></div>
                            <div><label class="text-xs theme-text-sub block mb-1">${utils.t('price_unit')}</label><input id="l_price" type="number" step="0.01" class="w-full p-3 rounded-xl bg-slate-50" oninput="ui.calcFuel('price')"></div>
                        </div>
                        <div><label class="text-xs theme-text-sub block mb-1">${utils.t('cost')}</label><input id="l_cost" type="number" step="0.01" value="${log.cost}" class="w-full p-3 rounded-xl" oninput="ui.calcFuel('cost')"></div>
                        
                        <div class="flex items-center gap-2 bg-amber-50 p-3 rounded-xl">
                            <input type="checkbox" id="l_partial" class="w-5 h-5 text-teal-600 rounded" ${log.isPartial?'checked':''}>
                            <label for="l_partial" class="text-sm font-medium text-amber-800">${utils.t('partial_tank')}</label>
                        </div>

                        <div class="relative">
                             <label class="text-xs theme-text-sub block mb-1">${utils.t('location')}</label>
                             <input id="l_loc" type="text" value="${log.location || ''}" class="w-full p-3 rounded-xl pr-10">
                             <button onclick="utils.detectLocation(l => document.getElementById('l_loc').value=l)" class="absolute right-3 top-8 text-teal-500"><span class="material-icons">my_location</span></button>
                        </div>

                        <div class="flex gap-3 mt-4">
                            ${id ? `<button onclick="ui.deleteLog('${id}')" class="flex-1 bg-red-50 text-red-600 py-3 rounded-xl font-bold">${utils.t('delete')}</button>` : ''}
                            <button onclick="ui.submitFuel('${id || ''}')" class="flex-1 grad-teal text-white py-3 rounded-xl font-bold shadow-lg">${utils.t('save')}</button>
                        </div>
                    </div>
                `);
                // Init calc
                setTimeout(() => ui.calcFuel('init'), 100);
            },

            calcFuel(trigger) {
                const litersEl = document.getElementById('l_liters');
                const costEl = document.getElementById('l_cost');
                const priceEl = document.getElementById('l_price');

                const vol = parseFloat(litersEl.value) || 0;
                const cost = parseFloat(costEl.value) || 0;
                const price = parseFloat(priceEl.value) || 0;

                const compute = (targetKey) => {
                    if (targetKey === 'liters') {
                        if (price > 0 && cost > 0) litersEl.value = (cost / price).toFixed(2);
                    } else if (targetKey === 'cost') {
                        if (vol > 0 && price > 0) costEl.value = (vol * price).toFixed(2);
                    } else if (targetKey === 'price') {
                        if (vol > 0 && cost > 0) priceEl.value = (cost / vol).toFixed(3);
                    }
                };

                // Initialize derived field without affecting "last 2 inputs" behavior.
                if (trigger === 'init') {
                    if (!price && vol > 0 && cost > 0) compute('price');
                    else if (!cost && vol > 0 && price > 0) compute('cost');
                    else if (!vol && cost > 0 && price > 0) compute('liters');
                    return;
                }

                // Input logic: last 2 edited fields determine the 3rd.
                if (!this._fuelCalcLast) this._fuelCalcLast = [];
                const key = trigger === 'vol' ? 'liters' : trigger; // 'cost' | 'price' | 'liters'
                this._fuelCalcLast = this._fuelCalcLast.filter(k => k !== key);
                this._fuelCalcLast.push(key);
                if (this._fuelCalcLast.length > 2) this._fuelCalcLast = this._fuelCalcLast.slice(-2);
                if (this._fuelCalcLast.length < 2) return;

                const keys = new Set(this._fuelCalcLast);
                const targetKey = ['liters', 'cost', 'price'].find(k => !keys.has(k));
                if (!targetKey) return;

                compute(targetKey);
            },

            async submitFuel(id) {
                const odo = parseInt(document.getElementById('l_odo').value);
                if (!odo) return alert('Odometer is required');
                
                const log = {
                    id: id || utils.newId(),
                    vehicleId: store.data.settings.activeVehicleId,
                    type: 'fuel',
                    date: document.getElementById('l_date').value,
                    odometer: odo,
                    liters: document.getElementById('l_liters').value,
                    cost: document.getElementById('l_cost').value,
                    location: document.getElementById('l_loc').value,
                    isPartial: document.getElementById('l_partial').checked,
                    notes: ''
                };
                
                if (id) await store.updateLog(log);
                else await store.addLog(log);
                this.closeModal();
                this.render();
            },

            openAddService(id = null, defaultType = 'service') {
                const existing = id ? store.data.logs.find(l => l.id === id) : null;
                const log = existing ? { ...existing } : { date: new Date().toISOString().slice(0, 10), odometer: store.getActiveVehicle()?.currentOdometer || '', type: defaultType, cost: '', location: '', notes: '', expiryDate: '', tirePosition: 'front_left', tireBrand: '', tireSwaps: [{ a: 'front_left', b: 'rear_left' }, { a: 'front_right', b: 'rear_right' }] };

                if (log.type === 'tire_rotation') {
                    const swaps = Array.isArray(log.tireSwaps) && log.tireSwaps.length
                        ? log.tireSwaps
                        : (log.tireSwapA && log.tireSwapB ? [{ a: log.tireSwapA, b: log.tireSwapB }] : [{ a: 'front_left', b: 'rear_left' }, { a: 'front_right', b: 'rear_right' }]);
                    log.tireSwaps = swaps;
                    log.tireSwapA1 = swaps[0]?.a || 'front_left';
                    log.tireSwapB1 = swaps[0]?.b || 'rear_left';
                    log.tireSwapA2 = swaps[1]?.a || 'front_right';
                    log.tireSwapB2 = swaps[1]?.b || 'rear_right';
                    log.tireRotPattern = swaps.length >= 2 ? 'front_rear' : 'single';
                }
                const quickTags = ['oil_change','tire_change','alignment','air_filter','cabin_filter','spark_plugs','brake_fluid','transmission_fluid','coolant','wiper_blades','battery','brake','inspection'];
                
                this.openModal(`
                    <h2 class="text-xl font-bold mb-4 theme-text-heading">${utils.t('add_service')}</h2>
                    <div class="space-y-4">
                        <select id="l_type" class="w-full p-3 rounded-xl font-bold bg-slate-100" onchange="ui.handleTypeChange(this.value)">
                            <option value="service" ${log.type==='service'?'selected':''}>${utils.t('service')}</option>
                            <option value="repair" ${log.type==='repair'?'selected':''}>${utils.t('repair')}</option>
                            <option value="tire_replace" ${log.type==='tire_replace'?'selected':''}>${utils.t('tire_replace')}</option>
                            <option value="tire_rotation" ${log.type==='tire_rotation'?'selected':''}>${utils.t('tire_rotation')}</option>
                            <option value="periodic_maintenance" ${log.type==='periodic_maintenance'?'selected':''}>${utils.t('periodic_maintenance')}</option>
                            <option value="car_wash" ${log.type==='car_wash'?'selected':''}>${utils.t('car_wash')}</option>
                            <option value="car_accessories" ${log.type==='car_accessories'?'selected':''}>${utils.t('car_accessories')}</option>
                            <option value="fine" ${log.type==='fine'?'selected':''}>${utils.t('traffic_fine')}</option>
                            <hr>
                            <option value="license" ${log.type==='license'?'selected':''}>${utils.t('license')}</option>
                            <option value="insurance" ${log.type==='insurance'?'selected':''}>${utils.t('insurance')}</option>
                            <option value="registration" ${log.type==='registration'?'selected':''}>${utils.t('registration')}</option>
                        </select>
                        
                        <div class="grid grid-cols-2 gap-3">
                            <div><label class="text-xs theme-text-sub block mb-1">${utils.t('date')}</label><input id="l_date" type="date" value="${log.date}" class="w-full p-3 rounded-xl"></div>
                            <div><label class="text-xs theme-text-sub block mb-1">${utils.t('odometer')}</label><input id="l_odo" type="number" value="${log.odometer}" class="w-full p-3 rounded-xl"></div>
                        </div>
                        <div><label class="text-xs theme-text-sub block mb-1">${utils.t('cost')}</label><input id="l_cost" type="number" step="0.01" value="${log.cost}" class="w-full p-3 rounded-xl"></div>
                        
                        <!-- Dynamic Fields -->
                        <div id="expiry_field" class="${['license','insurance','registration'].includes(log.type) ? '' : 'hidden'}">
                             <label class="text-xs theme-text-sub block mb-1">New Expiry Date</label>
                             <input id="l_expiry" type="date" value="${log.expiryDate || ''}" class="w-full p-3 rounded-xl border-purple-300">
                        </div>
                        
                        <div id="loc_note_fields" class="${['license','insurance','registration'].includes(log.type) ? 'hidden' : ''}">
                            <div id="tire_replace_fields" class="${log.type === 'tire_replace' ? '' : 'hidden'} bg-slate-50 dark:bg-slate-800/40 p-3 rounded-xl border theme-border mb-3">
                                <div class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">${utils.t('tire_positions')}</div>
                                <div class="grid grid-cols-2 gap-3">
                                    <div>
                                        <label class="text-xs theme-text-sub block mb-1">${utils.t('tire_pos')}</label>
                                        <select id="l_tire_pos" class="w-full p-3 rounded-xl text-sm">
                                            ${['front_left','front_right','rear_left','rear_right'].map(p => `<option value="${p}" ${log.tirePosition===p?'selected':''}>${utils.t('tire_'+p)}</option>`).join('')}
                                        </select>
                                    </div>
                                    <div>
                                        <label class="text-xs theme-text-sub block mb-1">${utils.t('tire_brand')}</label>
                                        <input id="l_tire_brand" type="text" value="${log.tireBrand || ''}" class="w-full p-3 rounded-xl text-sm" placeholder="e.g. Michelin Primacy 4">
                                    </div>
                                </div>
                            </div>
                            <div id="tire_rotation_fields" class="${log.type === 'tire_rotation' ? '' : 'hidden'} bg-slate-50 dark:bg-slate-800/40 p-3 rounded-xl border theme-border mb-3">
                                <div class="flex items-center justify-between mb-2">
                                    <div class="text-xs font-bold text-slate-400 uppercase tracking-wider">${utils.t('tire_swap')}</div>
                                    <select id="l_tire_rot_pattern" onchange="ui.applyTireRotationPattern(this.value)" class="text-xs p-1 rounded bg-white/70 dark:bg-slate-700 border theme-border">
                                        <option value="front_rear" ${log.tireRotPattern==='front_rear'?'selected':''}>Front ↔ Rear</option>
                                        <option value="cross" ${log.tireRotPattern==='cross'?'selected':''}>Cross</option>
                                        <option value="front_swap" ${log.tireRotPattern==='front_swap'?'selected':''}>Front L ↔ Front R</option>
                                        <option value="rear_swap" ${log.tireRotPattern==='rear_swap'?'selected':''}>Rear L ↔ Rear R</option>
                                        <option value="single" ${log.tireRotPattern==='single'?'selected':''}>Single Swap</option>
                                    </select>
                                </div>

                                <div class="grid grid-cols-2 gap-3">
                                    <div>
                                        <label class="text-xs theme-text-sub block mb-1">${utils.t('tire_swap_a')}</label>
                                        <select id="l_tire_swap_a1" class="w-full p-3 rounded-xl text-sm">
                                            ${['front_left','front_right','rear_left','rear_right'].map(p => `<option value="${p}" ${(log.tireSwapA1||'front_left')===p?'selected':''}>${utils.t('tire_'+p)}</option>`).join('')}
                                        </select>
                                    </div>
                                    <div>
                                        <label class="text-xs theme-text-sub block mb-1">${utils.t('tire_swap_b')}</label>
                                        <select id="l_tire_swap_b1" class="w-full p-3 rounded-xl text-sm">
                                            ${['front_left','front_right','rear_left','rear_right'].map(p => `<option value="${p}" ${(log.tireSwapB1||'rear_left')===p?'selected':''}>${utils.t('tire_'+p)}</option>`).join('')}
                                        </select>
                                    </div>
                                </div>

                                <div id="tire_rotation_pair2" class="${log.tireRotPattern==='single' ? 'hidden' : ''} grid grid-cols-2 gap-3 mt-2">
                                    <div>
                                        <label class="text-xs theme-text-sub block mb-1">${utils.t('tire_swap_a')}</label>
                                        <select id="l_tire_swap_a2" class="w-full p-3 rounded-xl text-sm">
                                            ${['front_left','front_right','rear_left','rear_right'].map(p => `<option value="${p}" ${(log.tireSwapA2||'front_right')===p?'selected':''}>${utils.t('tire_'+p)}</option>`).join('')}
                                        </select>
                                    </div>
                                    <div>
                                        <label class="text-xs theme-text-sub block mb-1">${utils.t('tire_swap_b')}</label>
                                        <select id="l_tire_swap_b2" class="w-full p-3 rounded-xl text-sm">
                                            ${['front_left','front_right','rear_left','rear_right'].map(p => `<option value="${p}" ${(log.tireSwapB2||'rear_right')===p?'selected':''}>${utils.t('tire_'+p)}</option>`).join('')}
                                        </select>
                                    </div>
                                </div>
                            </div>
                             <div class="relative mb-3">
                                 <label class="text-xs theme-text-sub block mb-1">${utils.t('location')}</label>
                                 <input id="l_loc" type="text" value="${log.location || ''}" class="w-full p-3 rounded-xl pr-10">
                                 <button onclick="utils.detectLocation(l => document.getElementById('l_loc').value=l)" class="absolute right-3 top-8 text-teal-500"><span class="material-icons">my_location</span></button>
                            </div>
                            
                            <div id="quick_tags" class="flex flex-wrap gap-2 mb-2">
                                ${quickTags.map(t => `<button onclick="document.getElementById('l_notes').value += (document.getElementById('l_notes').value ? ', ' : '') + '${utils.t(t)}'" class="text-[10px] bg-slate-100 px-2 py-1 rounded-full border hover:bg-teal-50 hover:text-teal-600 transition">+ ${utils.t(t)}</button>`).join('')}
                            </div>
                            <div id="fine_tags" class="hidden flex flex-wrap gap-2 mb-2">
                                ${['parking_ticket','no_parking','speeding','red_light','illegal_turn','bus_lane','seatbelt','phone_use','toll'].map(t => `<button onclick="document.getElementById('l_notes').value = '${utils.t(t)}'" class="text-[10px] bg-red-50 text-red-600 px-2 py-1 rounded-full border border-red-100 hover:bg-red-100 transition">${utils.t(t)}</button>`).join('')}
                            </div>
                            
                            <div>
                                <label class="text-xs theme-text-sub block mb-1">${utils.t('notes')}</label>
                                <textarea id="l_notes" class="w-full p-3 rounded-xl h-20">${log.notes || ''}</textarea>
                            </div>
                        </div>

                        <div class="flex gap-3 mt-4">
                            ${id ? `<button onclick="ui.deleteLog('${id}')" class="flex-1 bg-red-50 text-red-600 py-3 rounded-xl font-bold">${utils.t('delete')}</button>` : ''}
                            <button onclick="ui.submitService('${id || ''}')" class="flex-1 grad-teal text-white py-3 rounded-xl font-bold shadow-lg">${utils.t('save')}</button>
                        </div>
                    </div>
                `);
                // Init state
                this.handleTypeChange(log.type);
            },
            
            handleTypeChange(type) {
                const isDoc = ['license','insurance','registration'].includes(type);
                const isFine = type === 'fine';
                const isTireReplace = type === 'tire_replace';
                const isTireRotation = type === 'tire_rotation';
                document.getElementById('expiry_field').classList.toggle('hidden', !isDoc);
                document.getElementById('loc_note_fields').classList.toggle('hidden', isDoc);
                if (!isDoc) {
                    document.getElementById('quick_tags').classList.toggle('hidden', isFine);
                    document.getElementById('fine_tags').classList.toggle('hidden', !isFine);
                    const tireReplaceFields = document.getElementById('tire_replace_fields');
                    if (tireReplaceFields) tireReplaceFields.classList.toggle('hidden', !isTireReplace);
                    const tireRotationFields = document.getElementById('tire_rotation_fields');
                    if (tireRotationFields) tireRotationFields.classList.toggle('hidden', !isTireRotation);
                }
            },

            applyTireRotationPattern(pattern) {
                const pair2 = document.getElementById('tire_rotation_pair2');
                const set = (id, value) => {
                    const el = document.getElementById(id);
                    if (el) el.value = value;
                };
                if (pattern === 'front_rear') {
                    if (pair2) pair2.classList.remove('hidden');
                    set('l_tire_swap_a1', 'front_left'); set('l_tire_swap_b1', 'rear_left');
                    set('l_tire_swap_a2', 'front_right'); set('l_tire_swap_b2', 'rear_right');
                } else if (pattern === 'cross') {
                    if (pair2) pair2.classList.remove('hidden');
                    set('l_tire_swap_a1', 'front_left'); set('l_tire_swap_b1', 'rear_right');
                    set('l_tire_swap_a2', 'front_right'); set('l_tire_swap_b2', 'rear_left');
                } else if (pattern === 'front_swap') {
                    if (pair2) pair2.classList.add('hidden');
                    set('l_tire_swap_a1', 'front_left'); set('l_tire_swap_b1', 'front_right');
                } else if (pattern === 'rear_swap') {
                    if (pair2) pair2.classList.add('hidden');
                    set('l_tire_swap_a1', 'rear_left'); set('l_tire_swap_b1', 'rear_right');
                } else { // 'single'
                    if (pair2) pair2.classList.add('hidden');
                }
            },

            async submitService(id) {
                const type = document.getElementById('l_type').value;
                const isDoc = ['license','insurance','registration'].includes(type);
                const isTireReplace = type === 'tire_replace';
                const isTireRotation = type === 'tire_rotation';
                const existing = id ? store.data.logs.find(l => l.id === id) : null;

                let tireSwaps;
                let tireSwapA;
                let tireSwapB;
                if (isTireRotation) {
                    const get = (elId) => document.getElementById(elId)?.value;
                    const swaps = [];
                    const addSwap = (a, b) => {
                        if (!a || !b || a === b) return;
                        swaps.push({ a, b });
                    };
                    addSwap(get('l_tire_swap_a1'), get('l_tire_swap_b1'));
                    const pair2 = document.getElementById('tire_rotation_pair2');
                    if (pair2 && !pair2.classList.contains('hidden')) {
                        addSwap(get('l_tire_swap_a2'), get('l_tire_swap_b2'));
                    }
                    if (!swaps.length) return alert('Please select tire swap positions.');
                    const used = new Set();
                    for (const s of swaps) {
                        if (used.has(s.a) || used.has(s.b)) return alert('Each tire position can only appear once per rotation.');
                        used.add(s.a); used.add(s.b);
                    }
                    tireSwaps = swaps;
                    tireSwapA = swaps[0].a;
                    tireSwapB = swaps[0].b;
                }
                
                const log = {
                    id: id || utils.newId(),
                    vehicleId: store.data.settings.activeVehicleId,
                    type,
                    date: document.getElementById('l_date').value,
                    odometer: parseInt(document.getElementById('l_odo').value) || 0,
                    cost: document.getElementById('l_cost').value,
                    location: isDoc ? '' : document.getElementById('l_loc').value,
                    notes: isDoc ? '' : document.getElementById('l_notes').value,
                    expiryDate: isDoc ? document.getElementById('l_expiry').value : '',
                    tirePosition: isTireReplace ? document.getElementById('l_tire_pos')?.value : undefined,
                    tireBrand: isTireReplace ? document.getElementById('l_tire_brand')?.value : undefined,
                    tireId: isTireReplace ? (existing?.tireId || utils.newId()) : undefined,
                    tireSwaps: isTireRotation ? tireSwaps : undefined,
                    tireSwapA: isTireRotation ? tireSwapA : undefined,
                    tireSwapB: isTireRotation ? tireSwapB : undefined
                };
                
                if (id) await store.updateLog(log);
                else await store.addLog(log);
                this.closeModal();
                this.render();
            },
            
            openAddParking(id = null) {
                const log = id ? store.data.logs.find(l => l.id === id) : { date: new Date().toISOString().slice(0, 10), cost: '', location: '', notes: '' };
                this.openModal(`
                    <h2 class="text-xl font-bold mb-4 theme-text-heading flex items-center gap-2"><span class="material-icons text-blue-600">local_parking</span> ${utils.t('add_fuel').replace('Fuel','Parking')}</h2>
                    <div class="space-y-4">
                        <div><label class="text-xs theme-text-sub block mb-1">${utils.t('date')}</label><input id="p_date" type="date" value="${log.date}" class="w-full p-3 rounded-xl"></div>
                        <div><label class="text-xs theme-text-sub block mb-1">${utils.t('cost')}</label><input id="p_cost" type="number" step="0.01" value="${log.cost}" class="w-full p-3 rounded-xl"></div>
                        <div class="relative">
                             <label class="text-xs theme-text-sub block mb-1">${utils.t('location')}</label>
                             <input id="p_loc" type="text" value="${log.location || ''}" class="w-full p-3 rounded-xl pr-10">
                             <button onclick="utils.detectLocation(l => document.getElementById('p_loc').value=l)" class="absolute right-3 top-8 text-teal-500"><span class="material-icons">my_location</span></button>
                        </div>
                        <div><label class="text-xs theme-text-sub block mb-1">${utils.t('notes')}</label><textarea id="p_notes" class="w-full p-3 rounded-xl h-20">${log.notes || ''}</textarea></div>
                        <div class="flex gap-3 mt-4">
                            ${id ? `<button onclick="ui.deleteLog('${id}')" class="flex-1 bg-red-50 text-red-600 py-3 rounded-xl font-bold">${utils.t('delete')}</button>` : ''}
                            <button onclick="ui.submitParking('${id || ''}')" class="flex-1 bg-blue-600 text-white py-3 rounded-xl font-bold shadow-lg">${utils.t('save')}</button>
                        </div>
                    </div>
                `);
            },
            
            async submitParking(id) {
                const log = {
                    id: id || utils.newId(),
                    vehicleId: store.data.settings.activeVehicleId,
                    type: 'parking',
                    date: document.getElementById('p_date').value,
                    cost: document.getElementById('p_cost').value,
                    location: document.getElementById('p_loc').value,
                    notes: document.getElementById('p_notes').value
                };
                if (id) await store.updateLog(log);
                else await store.addLog(log);
                this.closeModal();
                this.render();
            },

            deleteLog(id) {
                setTimeout(() => {
                    if (confirm(utils.t('confirm_delete'))) {
                        store.deleteLog(id).then(() => {
                            this.closeModal();
                            this.render();
                        });
                    }
                }, 50);
            },
            
            // --- EXPORT / IMPORT / SELECTORS ---
            snoozeReminder(id, days) {
                const rc = store.data.settings.reminderCenter || { snoozedUntil: {}, done: {} };
                rc.snoozedUntil = rc.snoozedUntil || {};
                rc.done = rc.done || {};
                rc.snoozedUntil[id] = new Date(Date.now() + (days * 86400000)).toISOString();
                store.data.settings.reminderCenter = rc;
                store.saveData().then(() => this.render());
            },

            markReminderDone(id) {
                const rc = store.data.settings.reminderCenter || { snoozedUntil: {}, done: {} };
                rc.snoozedUntil = rc.snoozedUntil || {};
                rc.done = rc.done || {};
                rc.done[id] = true;
                delete rc.snoozedUntil[id];
                store.data.settings.reminderCenter = rc;
                store.saveData().then(() => this.render());
            },

            exportData() {
                const json = JSON.stringify(store.data);
                const blob = new Blob([json], {type: 'application/json'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `fuelmate_backup_${new Date().toISOString().slice(0,10)}.json`;
                a.click();
                
                // Update backup date
                store.data.settings.lastBackupDate = new Date().toISOString();
                store.saveData();
                this.render();
            },
            
            exportCSV() { utils.exportCSV(); },

            importData(input) {
                const file = input.files[0];
                if (!file) return;
                
                setTimeout(() => {
                    if (confirm(utils.t('import_warn'))) {
                        const reader = new FileReader();
                        reader.onload = async (e) => {
                            try {
                                const data = JSON.parse(e.target.result);
                                await store.importData(data, { overwrite: true });
                                alert(utils.t('success_import'));
                                location.reload();
                            } catch (err) { alert(utils.t('err_file')); }
                        };
                        reader.readAsText(file);
                    }
                    input.value = ''; // reset
                }, 50);
            },
            
            openVehicleSelector() {
                 this.openModal(`
                    <h2 class="text-xl font-bold mb-4 theme-text-heading">${utils.t('select_vehicle')}</h2>
                    <div class="space-y-2">
                        ${store.data.vehicles.map(v => `
                            <button onclick="store.data.settings.activeVehicleId='${v.id}'; store.saveData(); ui.closeModal(); ui.render();" class="w-full p-4 rounded-xl flex items-center gap-3 ${store.data.settings.activeVehicleId === v.id ? 'bg-teal-50 border-teal-500 border' : 'bg-slate-50 border theme-border'}">
                                <div class="w-10 h-10 rounded-full flex items-center justify-center text-white ${utils.getCarColorClass(v.color)}">
                                    <span class="material-icons">${utils.getCarIcon(v.type)}</span>
                                </div>
                                <div class="text-left">
                                    <div class="font-bold theme-text-heading">${v.make} ${v.model}</div>
                                    <div class="text-xs theme-text-sub">${v.year}</div>
                                </div>
                                ${store.data.settings.activeVehicleId === v.id ? '<span class="material-icons ml-auto text-teal-600">check_circle</span>' : ''}
                            </button>
                        `).join('')}
                    </div>
                 `);
            },
            
            openCalendarSelector() {
                this.openModal(`
                    <h2 class="text-xl font-bold mb-4 theme-text-heading">${utils.t('select_export')}</h2>
                    <div class="space-y-3">
                        <button onclick="ui.openCalendarConfig('license')" class="w-full p-4 rounded-xl bg-purple-50 text-purple-700 font-bold flex items-center justify-between">
                            <span class="flex items-center gap-2"><span class="material-icons">badge</span> ${utils.t('license')}</span>
                            <span class="material-icons">chevron_right</span>
                        </button>
                        <button onclick="ui.openCalendarConfig('insurance')" class="w-full p-4 rounded-xl bg-purple-50 text-purple-700 font-bold flex items-center justify-between">
                            <span class="flex items-center gap-2"><span class="material-icons">security</span> ${utils.t('insurance')}</span>
                            <span class="material-icons">chevron_right</span>
                        </button>
                        <button onclick="ui.openCalendarConfig('registration')" class="w-full p-4 rounded-xl bg-purple-50 text-purple-700 font-bold flex items-center justify-between">
                            <span class="flex items-center gap-2"><span class="material-icons">directions_car</span> ${utils.t('registration')}</span>
                            <span class="material-icons">chevron_right</span>
                        </button>
                    </div>
                `);
            },
            
            openCalendarConfig(type) {
                this.openModal(`
                    <h2 class="text-xl font-bold mb-2 theme-text-heading">${utils.t('export_calendar')}</h2>
                    <p class="text-sm theme-text-sub mb-4">${utils.t(type)}</p>
                    <label class="text-xs font-bold uppercase tracking-wider mb-2 block theme-text-sub">${utils.t('reminder_time')}</label>
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="utils.exportCalendar('${type}', null); ui.closeModal()" class="p-3 rounded-xl border theme-border font-medium text-sm hover:bg-slate-50">${utils.t('rem_none')}</button>
                        <button onclick="utils.exportCalendar('${type}', 0); ui.closeModal()" class="p-3 rounded-xl border theme-border font-medium text-sm hover:bg-slate-50">${utils.t('rem_day')}</button>
                        <button onclick="utils.exportCalendar('${type}', 7); ui.closeModal()" class="p-3 rounded-xl border theme-border font-medium text-sm hover:bg-slate-50">${utils.t('rem_1w')}</button>
                        <button onclick="utils.exportCalendar('${type}', 30); ui.closeModal()" class="p-3 rounded-xl border theme-border font-medium text-sm hover:bg-slate-50">${utils.t('rem_1m')}</button>
                    </div>
                `);
            },
            
            openAboutModal() {
                 this.openModal(`
                    <div class="text-center p-4">
                        <div class="w-20 h-20 mx-auto rounded-3xl grad-teal flex items-center justify-center text-white shadow-xl mb-4">
                            <span class="material-icons text-5xl">local_gas_station</span>
                        </div>
                        <h2 class="text-2xl font-black theme-text-heading mb-1">FuelMate</h2>
                        <div class="text-sm theme-text-sub mb-6">v2.1 (IndexedDB Edition)</div>
                        
                        <div class="text-left space-y-4 text-sm theme-text-heading bg-slate-50 dark:bg-slate-800 p-4 rounded-xl">
                            <h3 class="font-bold border-b pb-2 mb-2">Features</h3>
                            <ul class="list-disc pl-5 space-y-1 opacity-80">
                                <li>Complete Vehicle Cost Tracking</li>
                                <li>Fuel (Gas/EV) & Efficiency Analysis</li>
                                <li>Maintenance, Parking, Fines logging</li>
                                <li>Document Expiry Reminders</li>
                                <li>Offline-First (No Server)</li>
                            </ul>
                            
                            <h3 class="font-bold border-b pb-2 mb-2 mt-4">Tech Specs</h3>
                            <ul class="list-disc pl-5 space-y-1 opacity-80">
                                <li>Single-File PWA Architecture</li>
                                <li>IndexedDB Storage (>500MB capacity)</li>
                                <li>Client-side SVG Charts & Icon Gen</li>
                                <li>iOS Safe-Area Optimized</li>
                            </ul>
                        </div>
                        <div class="mt-6 text-xs text-slate-400">Designed for longevity & privacy.</div>
                    </div>
                 `);
            }
        };

        const router = {
            currentPage: 'dashboard',
            navigate(page) {
                this.currentPage = page;
                ui.render();
            }
        };

        window.addEventListener('DOMContentLoaded', () => ui.init());
        
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js').catch(err => console.error('Service Worker registration failed', err));
            });
        }
    </script>
</body>
</html>
