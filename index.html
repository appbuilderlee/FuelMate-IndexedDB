<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0f766e">
    <link rel="manifest" href="./manifest.webmanifest">
    <link rel="icon" href="./icon.svg" type="image/svg+xml">
    <title>FuelMate</title>
    <link rel="stylesheet" href="./app.css">
    <link rel="stylesheet" href="./material-icons/material-icons.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        :root {
            --safe-top: env(safe-area-inset-top, 20px);
            --safe-bottom: env(safe-area-inset-bottom, 20px);
            --bg-main: #f8fafc;
            --bg-card: #ffffff;
            --text-heading: #0f172a;
            --text-sub: #64748b;
            --border-color: #e2e8f0;
        }
        @media (prefers-color-scheme: dark) {
            :root {
                --bg-main: #0f172a;
                --bg-card: #1e293b;
                --text-heading: #f1f5f9;
                --text-sub: #94a3b8;
                --border-color: #334155;
            }
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-main);
            color: var(--text-heading);
            -webkit-tap-highlight-color: transparent;
            padding-bottom: calc(100px + var(--safe-bottom));
            overscroll-behavior-y: none; 
        }
        .pt-safe { padding-top: calc(var(--safe-top) + 20px); } 
        .pb-safe { padding-bottom: calc(100px + var(--safe-bottom)); }
        .nav-safe { padding-bottom: calc(var(--safe-bottom) + 12px); }
        
        /* Dynamic Gradients based on Car Color */
        .grad-teal { background: linear-gradient(135deg, #0f766e 0%, #0d9488 100%); }
        .grad-blue { background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%); }
        .grad-red { background: linear-gradient(135deg, #991b1b 0%, #ef4444 100%); }
        .grad-black { background: linear-gradient(135deg, #000000 0%, #374151 100%); }
        .grad-white { background: linear-gradient(135deg, #94a3b8 0%, #cbd5e1 100%); color: #0f172a; }
        .grad-yellow { background: linear-gradient(135deg, #ca8a04 0%, #eab308 100%); }
        .grad-purple { background: linear-gradient(135deg, #6b21a8 0%, #a855f7 100%); }
        .grad-green { background: linear-gradient(135deg, #166534 0%, #22c55e 100%); }
        .grad-orange { background: linear-gradient(135deg, #c2410c 0%, #f97316 100%); }
        .grad-brown { background: linear-gradient(135deg, #451a03 0%, #78350f 100%); }
        .grad-grey { background: linear-gradient(135deg, #374151 0%, #6b7280 100%); }
        .grad-pink { background: linear-gradient(135deg, #be185d 0%, #ec4899 100%); }
        .grad-cyan { background: linear-gradient(135deg, #0e7490 0%, #06b6d4 100%); }

        .card-shadow { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03); }
        .glass-nav { 
            background: rgba(255, 255, 255, 0.9); 
            backdrop-filter: blur(10px); 
            border-top: 1px solid var(--border-color);
        }
        @media (prefers-color-scheme: dark) {
            .glass-nav { background: rgba(30, 41, 59, 0.9); border-top: 1px solid #334155; }
        }
        .liquid-nav {
            position: fixed;
            left: 0;
            bottom: 0;
            width: 100%;
            overflow: hidden;
            border-top: 1px solid rgba(255, 255, 255, 0.5);
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(18px) saturate(1.4);
            box-shadow: 0 -10px 30px rgba(15, 23, 42, 0.12);
        }
        .liquid-nav-bg {
            position: absolute;
            inset: -40px;
            background:
                radial-gradient(120px 80px at 10% 20%, rgba(20, 184, 166, 0.35), transparent 60%),
                radial-gradient(140px 90px at 90% 30%, rgba(59, 130, 246, 0.25), transparent 60%),
                radial-gradient(180px 120px at 50% 120%, rgba(16, 185, 129, 0.25), transparent 70%);
            filter: blur(6px);
            animation: liquid-drift 8s ease-in-out infinite alternate, liquid-float 12s ease-in-out infinite;
            pointer-events: none;
        }
        .liquid-nav-gloss {
            position: absolute;
            inset: 0;
            background: linear-gradient(120deg, rgba(255, 255, 255, 0.55), rgba(255, 255, 255, 0.05) 45%, rgba(255, 255, 255, 0.35) 70%);
            opacity: 0.6;
            animation: liquid-shimmer 6s ease-in-out infinite;
            pointer-events: none;
        }
        .liquid-nav-inner { position: relative; z-index: 1; }
        .liquid-nav-highlight {
            position: absolute;
            left: 0;
            top: 50%;
            height: 62px;
            width: calc(100% / var(--nav-count));
            transform: translate3d(calc(var(--active-index) * 100%), -50%, 0);
            border-radius: 18px;
            background: radial-gradient(80px 40px at 50% 0%, rgba(20, 184, 166, 0.35), transparent 70%);
            box-shadow: 0 6px 14px rgba(15, 118, 110, 0.18);
            transition: transform 0.35s ease;
            z-index: 0;
        }
        .liquid-nav-item { position: relative; z-index: 1; transition: transform 0.2s ease, color 0.2s ease; }
        .liquid-nav-item:hover { transform: translateY(-2px); }
        .liquid-nav-item:active { transform: translateY(-1px) scale(0.98); }
        .liquid-nav-item.is-active .material-icons { text-shadow: 0 0 12px rgba(20, 184, 166, 0.35); }
        @keyframes liquid-drift {
            0% { transform: translate3d(-4%, -2%, 0) scale(1); }
            100% { transform: translate3d(4%, 2%, 0) scale(1.05); }
        }
        @keyframes liquid-float {
            0% { filter: blur(6px); }
            50% { filter: blur(10px); }
            100% { filter: blur(6px); }
        }
        @keyframes liquid-shimmer {
            0% { transform: translateX(-15%); opacity: 0.35; }
            50% { transform: translateX(10%); opacity: 0.55; }
            100% { transform: translateX(20%); opacity: 0.4; }
        }
        @media (prefers-color-scheme: dark) {
            .liquid-nav {
                background: rgba(15, 23, 42, 0.65);
                border-top: 1px solid rgba(148, 163, 184, 0.25);
                box-shadow: 0 -10px 30px rgba(2, 6, 23, 0.6);
            }
            .liquid-nav-bg {
                background:
                    radial-gradient(120px 80px at 10% 20%, rgba(94, 234, 212, 0.2), transparent 60%),
                    radial-gradient(140px 90px at 90% 30%, rgba(56, 189, 248, 0.2), transparent 60%),
                    radial-gradient(180px 120px at 50% 120%, rgba(34, 197, 94, 0.18), transparent 70%);
                opacity: 0.8;
            }
            .liquid-nav-gloss { opacity: 0.25; }
            .liquid-nav-highlight {
                background: radial-gradient(80px 40px at 50% 0%, rgba(94, 234, 212, 0.25), transparent 70%);
                box-shadow: 0 6px 16px rgba(45, 212, 191, 0.15);
            }
            .liquid-nav-item.is-active .material-icons { text-shadow: 0 0 12px rgba(94, 234, 212, 0.25); }
        }
        /* Hide scrollbar but allow scroll */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .theme-bg-card { background-color: var(--bg-card); }
        .theme-text-heading { color: var(--text-heading); }
        .theme-text-sub { color: var(--text-sub); }
        .theme-border { border-color: var(--border-color); }
        
        input, select, textarea {
            background-color: var(--bg-main);
            color: var(--text-heading);
            border: 1px solid var(--border-color);
        }
        .service-odo-grid > div { min-width: 0; }
        @media (max-width: 520px) {
            .service-odo-grid { grid-template-columns: 1fr !important; }
        }
        /* Color Picker Radio */
        .color-radio:checked + div { ring: 2px solid white; box-shadow: 0 0 0 4px currentColor; }
    </style>
    <!-- Dynamic Icon Generator -->
    <script>
        (function() {
            const canvas = document.createElement('canvas');
            canvas.width = 1024;
            canvas.height = 1024;
            const ctx = canvas.getContext('2d');
            
            // Background
            const grad = ctx.createLinearGradient(0, 0, 1024, 1024);
            grad.addColorStop(0, '#0ea5e9'); // Sky Blue
            grad.addColorStop(1, '#0284c7'); // Darker Blue
            ctx.fillStyle = grad;
            ctx.fillRect(0, 0, 1024, 1024);

            // Icon - Material Design Local Gas Station Path
            ctx.fillStyle = '#FFFFFF';
            ctx.save();
            ctx.translate(150, 150); // Center slightly
            ctx.scale(30, 30); // Scale up the 24px path
            const p = new Path2D("M19.77 7.23l.01-.01-3.72-3.72L15 4.56l2.11 2.11c-.94.36-1.61 1.26-1.61 2.33 0 1.38 1.12 2.5 2.5 2.5.36 0 .69-.08 1-.21v7.21c0 .55-.45 1-1 1s-1-.45-1-1V14c0-1.1-.9-2-2-2h-1V5c0-1.1-.9-2-2-2H6c-1.1 0-2 .9-2 2v16h10v-7.5h1.5v5c0 1.38 1.12 2.5 2.5 2.5s2.5-1.12 2.5-2.5V9c0-.69-.28-1.32-.73-1.77zM12 10H6V5h6v5zm6 0c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1z");
            ctx.fill(p);
            ctx.restore();

            const url = canvas.toDataURL('image/png');
            const link = document.createElement('link');
            link.rel = 'apple-touch-icon';
            link.href = url;
            document.head.appendChild(link);
        })();
    </script>
</head>
<body>
    <div id="app" class="pb-safe min-h-screen"></div>

    <!-- Modals Overlay -->
    <div id="modal-overlay" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden z-50 flex items-end sm:items-center justify-center p-0 sm:p-4 opacity-0 transition-opacity duration-200" onclick="ui.closeModal()">
        <div id="modal-content" class="bg-white dark:bg-slate-900 w-full max-w-lg rounded-t-3xl sm:rounded-3xl p-6 transform translate-y-full sm:translate-y-0 transition-transform duration-300 shadow-2xl max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
            <!-- Dynamic Content -->
        </div>
    </div>

    <script>
        // --- TRANSLATIONS ---
        const translations = {
            en: {
                dashboard: 'Dashboard', fuel: 'Fuel', maintenance: 'Vehicle Records', maintenance_plus: 'Records+', analytics: 'Analytics', settings: 'Settings', parking: 'Park',
                welcome: 'Welcome', add_vehicle: 'Add Vehicle', select_vehicle: 'Select Vehicle',
                range_month: 'Month', range_year: 'Year', range_all: 'All Time',
                efficiency: 'Efficiency', cost_km: 'Cost/km', total_cost: 'Total Cost', total_dist: 'Total Distance',
                add_fuel: 'Add Fuel', add_service: 'Add Vehicle Record', add_parking: 'Add Parking', edit_vehicle: 'Edit Vehicle',
                date: 'Date', odometer: 'Odometer', liters: 'Liters', gallons: 'Gallons', cost: 'Cost', price_unit: 'Price/Unit', location: 'Location', notes: 'Notes',
                detect_loc: 'Detect Location', save: 'Save', cancel: 'Cancel', delete: 'Delete',
                service_type: 'Service Type', service: 'Service', repair: 'Repair', parking_fee: 'Parking Fee', traffic_fine: 'Traffic Fine',
                tire_replace: 'Tire Replacement',
                tire_rotation: 'Tire Rotation',
                license: 'License Renewal', insurance: 'Insurance Renewal', registration: 'Vehicle Registration',
                periodic_maintenance: 'Periodic Maintenance', car_wash: 'Car Wash', car_accessories: 'Accessories',
                tire_positions: 'Tire Positions',
                tire_pos: 'Position',
                tire_front_left: 'Front Left', tire_front_right: 'Front Right', tire_rear_left: 'Rear Left', tire_rear_right: 'Rear Right',
                tire_brand: 'Brand/Model',
                tire_swap: 'Swap Positions',
                tire_swap_a: 'From',
                tire_swap_b: 'To',
                drive_type: 'Drive Type',
                drive_fwd: 'FWD',
                drive_rwd: 'RWD',
                drive_awd: 'AWD/4WD',
                tire_tread: 'Tread Depth (mm)',
                tire_pressure: 'Pressure (psi)',
                pressure_unit: 'Pressure Unit',
                unit_psi: 'psi',
                unit_kpa: 'kPa',
                unit_bar: 'bar',
                tire_alignment: 'Alignment',
                tire_balancing: 'Balancing',
                tire_recommended: 'Recommended',
                next_tire_change: 'Next Tire Change',
                tire_not_set: 'Not set',
                quick_tire_setup: 'Quick Setup',
                quick_tire_setup_desc: 'Set remaining tire life in 2-3 steps.',
                remaining_distance: 'Remaining Distance',
                remaining_months: 'Remaining Months',
                quick_tire_setup_error: 'Please enter remaining distance or months.',
                quick_tire_setup_all: 'Set All Tires',
                apply_to_all_tires: 'Apply to all tires',
                apply_unset_only: 'Only unset',
                apply_overwrite_all: 'Overwrite all',
                due_in: 'Due in',
                overdue: 'Overdue',
                tire_interval_dist: 'Tire Interval (Distance)',
                tire_interval_time: 'Tire Interval (Years)',
                license_expiry: 'License Expiry', insurance_expiry: 'Insurance Expiry', expiring_soon: 'Expiring in', expired: 'Expired',
                reminders: 'Reminders', reminder_settings: 'Reminder Settings',
                reminder_center: 'Reminder Center',
                reminder_due_count: '{n} due soon',
                reminder_summary: 'Summary',
                reminder_quick_actions: 'Quick Actions',
                reminder_open: 'Open',
                reminder_none: 'No reminders right now',
                reminder_tires: 'Tires',
                reminder_service: 'Service',
                reminder_docs: 'Docs',
                reminder_backup: 'Backup',
                documents: 'Documents',
                reminder_settings_desc: 'Manage document reminders and due dates.',
                search_placeholder: 'Search notes/location...',
                install_guide: 'Install Guide',
                install_guide_hint: 'Add FuelMate to your home screen for the best experience.',
                view_details: 'View Details',
                backup_warning: 'Please back up regularly; clearing browser cache can remove local data.',
                all: 'All',
                maintenance_cost: 'Maintenance Cost',
                no_records_found: 'No records found',
                no_tire_records_found: 'No tire records found',
                no_tire_events: 'No tire events',
                no_records_yet: 'No records yet',
                view_all: 'View All',
                snooze_7d: 'Snooze 7d',
                snooze_1d: 'Snooze 1d',
                snooze_30d: 'Snooze 30d',
                tab_active: 'Active',
                tab_snoozed: 'Snoozed',
                tab_done: 'Done',
                unsnooze: 'Unsnooze',
                restore: 'Restore',
                mark_done: 'Done',
                snooze_all_7d: 'Snooze all 7d',
                clear_done: 'Clear done',
                load_more: 'Load more',
                showing: 'Showing',
                export_json: 'Backup Data (JSON)', import_json: 'Restore Data (JSON)', export_csv: 'Export Excel (CSV)',
                clear_history: 'Clear Vehicle History', delete_vehicle: 'Delete Vehicle',
                confirm_delete: 'Are you sure you want to delete this record?',
                confirm_clear: 'WARNING: This will delete ALL logs for this vehicle. Are you sure?',
                confirm_clear_2: 'Double Check: This cannot be undone. Delete everything?',
                import_warn: 'WARNING: This will overwrite your current data. Continue?',
                import_summary: 'Import Summary',
                import_file: 'File',
                import_current: 'Current',
                import_incoming: 'Incoming',
                import_counts: 'Counts',
                import_types: 'Types',
                import_settings: 'Settings',
                import_invalid: 'Invalid backup file.',
                import_autobackup: 'Auto-backup downloaded:',
                import_overwrite: 'Backup & Overwrite',
                units: 'Units', currency: 'Currency', language: 'Language',
                metric: 'Metric (L, km)', imperial: 'Imperial (Gal, mi)',
                success_import: 'Data imported successfully!', err_file: 'Invalid file format',
                partial_tank: 'Partial Tank / Missed Fill-up',
                partial: 'Partial',
                full: 'Full',
                common_services: 'Common Services', oil_change: 'Oil Change', tire_change: 'Tire Change', tire_rotation: 'Tire Rotation', alignment: 'Wheel Alignment', air_filter: 'Air Filter', cabin_filter: 'Cabin Filter', spark_plugs: 'Spark Plugs', brake_fluid: 'Brake Fluid', transmission_fluid: 'Transmission Fluid', coolant: 'Coolant', wiper_blades: 'Wiper Blades', battery: 'Battery', brake: 'Brakes', inspection: 'Inspection',
                fine_types: 'Fine Types', parking_ticket: 'Parking Ticket', no_parking: 'No Parking', speeding: 'Speeding', red_light: 'Red Light', illegal_turn: 'Illegal Turn', bus_lane: 'Bus Lane', seatbelt: 'Seat Belt', phone_use: 'Phone Use', toll: 'Toll / Fee',
                service_interval: 'Service Interval', int_none: 'None', int_5k: '5,000 km', int_10k: '10,000 km', int_6m: '6 Months', int_1yr: '1 Year',
                service_interval_dist: 'Interval (Distance)', service_interval_time: 'Interval (Time)',
                interval_settings: 'Intervals',
                due_service: 'Service Due', due_in: 'Due in',
                export_calendar: 'Add to Calendar', select_export: 'Select Item to Export',
                reminder_time: 'Reminder Time', rem_none: 'None', rem_day: 'On Day', rem_1w: '1 Week Before', rem_1m: '1 Month Before',
                color: 'Color', type: 'Type',
                col_teal: 'Teal', col_blue: 'Blue', col_red: 'Red', col_black: 'Black', col_white: 'White', col_yellow: 'Yellow', col_purple: 'Purple', col_green: 'Green', col_orange: 'Orange', col_brown: 'Brown', col_grey: 'Grey', col_pink: 'Pink', col_cyan: 'Cyan',
                type_sedan: 'Sedan', type_suv: 'SUV', type_bike: 'Motorcycle', type_truck: 'Truck', type_sports: 'Sports Car', type_van: 'Van', type_bus: 'Bus', type_hatch: 'Hatchback', type_offroad_4x4: 'Offroad 4x4', type_ute: 'Ute',
                about: 'About FuelMate', app_desc: 'A complete PWA for vehicle tracking.',
                backup_needed: 'Backup Needed', backup_desc: 'You haven\'t backed up in 30 days.', backup_now: 'Backup Now', backup_later: 'Later',
                add_demo_car: 'Add Demo Car',
                trip_dist: 'Trip Distance', total_odo: 'Total Odometer', input_mode: 'Input Mode',
                monthly_spend: 'Monthly Spending',
                fixed_costs: 'Fixed Costs',
                kwh: 'kWh'
            },
            zh: {
                dashboard: '首頁', fuel: '加油', maintenance: '車務紀錄', maintenance_plus: '車務+', analytics: '統計', settings: '設定', parking: '停車',
                welcome: '歡迎使用', add_vehicle: '新增車輛', select_vehicle: '切換車輛',
                range_month: '月份', range_year: '年份', range_all: '全部',
                efficiency: '油耗表現', cost_km: '每公里成本', total_cost: '總支出', total_dist: '總里程',
                add_fuel: '新增加油', add_service: '新增車務', add_parking: '新增停車', edit_vehicle: '編輯車輛',
                date: '日期', odometer: '里程', liters: '升數', gallons: '加侖', cost: '金額', price_unit: '單價', location: '地點', notes: '備註',
                detect_loc: '定位', save: '保存', cancel: '取消', delete: '刪除',
                service_type: '維修類型', service: '一般維修', repair: '故障維修', parking_fee: '停車費', traffic_fine: '罰單/告票',
                tire_replace: '更換輪胎',
                tire_rotation: '輪胎換位',
                license: '車牌續期', insurance: '保險續期', registration: '車輛登記',
                periodic_maintenance: '定期保養', car_wash: '洗車', car_accessories: '汽車用品',
                tire_positions: '輪胎位置',
                tire_pos: '位置',
                tire_front_left: '左前', tire_front_right: '右前', tire_rear_left: '左後', tire_rear_right: '右後',
                tire_brand: '品牌/型號',
                tire_swap: '交換位置',
                tire_swap_a: '由',
                tire_swap_b: '到',
                drive_type: '驅動方式',
                drive_fwd: '前驅',
                drive_rwd: '後驅',
                drive_awd: '四驅',
                tire_tread: '胎紋深度 (mm)',
                tire_pressure: '胎壓',
                pressure_unit: '氣壓單位',
                unit_psi: 'psi',
                unit_kpa: 'kPa',
                unit_bar: 'bar',
                tire_alignment: '四輪定位',
                tire_balancing: '平衡',
                tire_recommended: '建議',
                next_tire_change: '下次換胎',
                tire_not_set: '未設定',
                quick_tire_setup: '快速設定剩餘壽命',
                quick_tire_setup_desc: '用 2-3 個步驟完成設定',
                remaining_distance: '剩餘里程',
                remaining_months: '剩餘月數',
                quick_tire_setup_error: '請至少填寫剩餘里程或剩餘月數',
                quick_tire_setup_all: '單一設定全輪',
                apply_to_all_tires: '套用到所有輪胎',
                apply_unset_only: '只未設定',
                apply_overwrite_all: '覆蓋全部',
                due_in: '剩餘',
                overdue: '已到期',
                tire_interval_dist: '換胎間隔（里程）',
                tire_interval_time: '換胎間隔（年）',
                license_expiry: '車牌到期', insurance_expiry: '保險到期', expiring_soon: '剩餘', expired: '已過期',
                reminders: '提醒通知', reminder_settings: '提醒設定',
                reminder_center: '提醒中心',
                reminder_due_count: '即將到期 {n} 件',
                reminder_summary: '分類摘要',
                reminder_quick_actions: '快速操作',
                reminder_open: '查看',
                reminder_none: '目前沒有提醒',
                reminder_tires: '輪胎',
                reminder_service: '保養',
                reminder_docs: '證件',
                reminder_backup: '備份',
                documents: '證件',
                reminder_settings_desc: '管理證件提醒與到期日',
                search_placeholder: '搜尋地點/備註...',
                install_guide: '安裝教學',
                install_guide_hint: '將 FuelMate 加到主畫面，離線也可快速開啟。',
                view_details: '詳細教學',
                backup_warning: '提示：請定期備份；清除瀏覽器快取會刪除本機資料。',
                all: '全部',
                maintenance_cost: '車務總額',
                no_records_found: '沒有任何紀錄',
                no_tire_records_found: '沒有輪胎紀錄',
                no_tire_events: '沒有輪胎事件',
                no_records_yet: '尚未有紀錄',
                view_all: '查看全部',
                snooze_7d: '延後 7 天',
                snooze_1d: '延後 1 天',
                snooze_30d: '延後 30 天',
                tab_active: '進行中',
                tab_snoozed: '已延後',
                tab_done: '已完成',
                unsnooze: '取消延後',
                restore: '還原',
                mark_done: '完成',
                snooze_all_7d: '全部延後 7 天',
                clear_done: '清除已完成',
                load_more: '載入更多',
                showing: '顯示',
                export_json: '匯出資料 (JSON)', import_json: '匯入資料 (JSON)', export_csv: '匯出 Excel (CSV)',
                clear_history: '清除所有紀錄', delete_vehicle: '刪除車輛',
                confirm_delete: '確定要刪除此記錄嗎？',
                confirm_clear: '警告：這將刪除此車輛的所有記錄。確定嗎？',
                confirm_clear_2: '再次確認：刪除後無法恢復。確定要清空嗎？',
                import_warn: '警告：這將覆蓋您當前的所有資料。是否繼續？',
                import_summary: '匯入摘要',
                import_file: '檔案',
                import_current: '目前',
                import_incoming: '將匯入',
                import_counts: '數量',
                import_types: '類型',
                import_settings: '設定',
                import_invalid: '備份檔案格式不正確。',
                import_autobackup: '已下載自動備份：',
                import_overwrite: '備份並覆蓋',
                units: '單位', currency: '貨幣', language: '語言',
                metric: '公制 (L, km)', imperial: '英制 (Gal, mi)',
                success_import: '資料匯入成功！', err_file: '文件格式錯誤',
                partial_tank: '未加滿 / 漏記 (不計算油耗)',
                partial: '未加滿',
                full: '加滿',
                common_services: '常用項目', oil_change: '換機油', tire_change: '換輪胎', tire_rotation: '輪胎換位', alignment: '四輪定位', air_filter: '更換空氣濾芯', cabin_filter: '更換冷氣濾芯', spark_plugs: '更換火咀', brake_fluid: '更換煞車油', transmission_fluid: '更換波箱油', coolant: '更換冷卻液', wiper_blades: '更換雨刷', battery: '換電池', brake: '煞車皮', inspection: '年檢',
                fine_types: '罰單類型', parking_ticket: '違例泊車', no_parking: '禁止停車', speeding: '超速', red_light: '衝紅燈', illegal_turn: '違規轉彎', bus_lane: '巴士線', seatbelt: '安全帶', phone_use: '使用手機', toll: '道路收費/費用',
                service_interval: '保養間隔', int_none: '關閉', int_5k: '5,000 km', int_10k: '10,000 km', int_6m: '6 個月', int_1yr: '1 年',
                service_interval_dist: '保養間隔 (里程)', service_interval_time: '保養間隔 (時間)',
                interval_settings: '保養/換胎間隔',
                due_service: '即將保養', due_in: '剩餘',
                export_calendar: '加入日曆', select_export: '選擇導出項目',
                reminder_time: '提醒時間', rem_none: '無', rem_day: '當天', rem_1w: '1 週前', rem_1m: '1 個月前',
                color: '顏色', type: '車型',
                col_teal: '青色', col_blue: '藍色', col_red: '紅色', col_black: '黑色', col_white: '白色', col_yellow: '黃色', col_purple: '紫色', col_green: '綠色', col_orange: '橘色', col_brown: '棕色', col_grey: '灰色', col_pink: '粉紅', col_cyan: '湖水綠',
                type_sedan: '房車', type_suv: '休旅車', type_bike: '機車', type_truck: '貨車', type_sports: '跑車', type_van: '廂型車', type_bus: '巴士', type_hatch: '掀背車', type_offroad_4x4: '越野 4x4', type_ute: '皮卡',
                about: '關於 FuelMate', app_desc: '全功能車輛開支追蹤 PWA。',
                backup_needed: '備份提醒', backup_desc: '您已經超過 30 天沒有備份資料了。', backup_now: '立即備份', backup_later: '稍後',
                add_demo_car: '加入示範車 (Demo)',
                trip_dist: '行駛距離', total_odo: '總里程', input_mode: '輸入模式',
                monthly_spend: '每月支出',
                fixed_costs: '固定支出',
                kwh: '度電 (kWh)'
            }
        };

        // --- INDEXEDDB STORE ---
        const store = {
            db: null,
            dbName: 'FuelMateDB',
            currentSchemaVersion: 2,
            defaultSettings: { currency: '$', units: 'metric', pressureUnit: 'kPa', language: 'en', maintenanceDist: 'none', maintenanceTime: 'none', tireReplaceDist: 40000, tireReplaceYears: 4, reminders: {}, reminderCenter: { snoozedUntil: {}, done: {} }, lastBackupDate: null, activeVehicleId: null },
            data: { vehicles: [], logs: [], settings: { currency: '$', units: 'metric', pressureUnit: 'kPa', language: 'en', maintenanceDist: 'none', maintenanceTime: 'none', tireReplaceDist: 40000, tireReplaceYears: 4, reminders: {}, reminderCenter: { snoozedUntil: {}, done: {} }, lastBackupDate: null, activeVehicleId: null } },
            pageFilters: { 
                dashboard: { mode: 'month', value: new Date().toISOString().slice(0, 7) }, 
                fuel: { mode: 'year', value: new Date().getFullYear().toString() }, 
                maintenance: { mode: 'year', value: new Date().getFullYear().toString() }, 
                parking: { mode: 'year', value: new Date().getFullYear().toString() }, 
                analytics: { mode: 'year', value: new Date().getFullYear().toString() },
                maintenanceSearch: '',
                maintenanceTypes: [],
                maintenanceView: 'all',
                fuelSearch: '',
                parkingSearch: '',
                analyticsSearch: '',
                fuelFrom: '',
                fuelTo: '',
                parkingFrom: '',
                parkingTo: '',
                maintenanceFrom: '',
                maintenanceTo: '',
                analyticsFrom: '',
                analyticsTo: '',
                fuelFlags: { full: false, partial: false },
                parkingFlags: { withLocation: false, withNotes: false },
                remindersTab: 'active'
            },
            pageLimits: { fuel: 100, maintenance: 100, parking: 100 },
            _logsVersion: 0,
            _cache: {
                logsSorted: new Map(),
                logSearchText: new Map(),
                filtered: new Map()
            },
            _bulkImporting: false,

            _invalidateLogsCache() {
                this._logsVersion += 1;
                this._cache.logsSorted.clear();
                this._cache.logSearchText.clear();
                this._cache.filtered.clear();
            },

            _getCachedFiltered(key, compute) {
                const fullKey = `${this._logsVersion}|${this.data.settings.activeVehicleId || 'none'}|${key}`;
                const cached = this._cache.filtered.get(fullKey);
                if (cached) return cached;
                const value = compute();
                this._cache.filtered.set(fullKey, value);
                return value;
            },

            getLogSearchText(log) {
                if (!log || !log.id) return '';
                const cached = this._cache.logSearchText.get(log.id);
                if (cached) return cached;
                const text = `${log.location || ''}\n${log.notes || ''}`.toLowerCase();
                this._cache.logSearchText.set(log.id, text);
                return text;
            },

            async init() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(this.dbName, 1);
                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;
                        if (!db.objectStoreNames.contains('vehicles')) db.createObjectStore('vehicles', { keyPath: 'id' });
                        if (!db.objectStoreNames.contains('logs')) {
                            const logsStore = db.createObjectStore('logs', { keyPath: 'id' });
                            logsStore.createIndex('vehicleId', 'vehicleId', { unique: false });
                            logsStore.createIndex('type', 'type', { unique: false });
                        }
                        if (!db.objectStoreNames.contains('settings')) db.createObjectStore('settings', { keyPath: 'id' });
                    };
                    request.onsuccess = async (event) => {
                        this.db = event.target.result;
                        await this.migrateFromLocalStorage(); 
                        await this.loadAllData();
                        resolve();
                    };
                    request.onerror = (e) => reject(e);
                });
            },

            async runTransaction(storeName, mode, callback) {
                return new Promise((resolve, reject) => {
                    const tx = this.db.transaction(storeName, mode);
                    const store = tx.objectStore(storeName);
                    let request;
                    let result;
                    try {
                        request = callback(store, tx);
                    } catch (err) {
                        reject(err);
                        return;
                    }
                    if (request) {
                        request.onsuccess = () => { result = request.result; };
                        request.onerror = () => reject(request.error);
                    }
                    tx.oncomplete = () => resolve(result);
                    tx.onerror = () => reject(tx.error || new Error('Transaction failed'));
                    tx.onabort = () => reject(tx.error || new Error('Transaction aborted'));
                });
            },

            async clearAllData() {
                return new Promise((resolve, reject) => {
                    const tx = this.db.transaction(['vehicles', 'logs', 'settings'], 'readwrite');
                    tx.objectStore('vehicles').clear();
                    tx.objectStore('logs').clear();
                    tx.objectStore('settings').clear();
                    tx.oncomplete = () => resolve();
                    tx.onerror = () => reject(tx.error || new Error('Clear failed'));
                    tx.onabort = () => reject(tx.error || new Error('Clear aborted'));
                });
            },

            async migrateFromLocalStorage() {
                const oldData = localStorage.getItem('fuelmate_data');
                if (oldData) {
                    try {
                        const parsed = JSON.parse(oldData);
                        await this.importData(parsed);
                        localStorage.removeItem('fuelmate_data'); 
                        console.log('Migrated from LocalStorage to IndexedDB');
                    } catch(e) { console.error('Migration failed', e); }
                }
            },

            async loadAllData() {
                this.data.vehicles = await this.runTransaction('vehicles', 'readonly', s => s.getAll());
                this.data.logs = await this.runTransaction('logs', 'readonly', s => s.getAll());
                const settings = await this.runTransaction('settings', 'readonly', s => s.get('global'));
                if (settings) this.data.settings = { ...this.data.settings, ...settings };
                
                // Ensure default settings
                if (!this.data.settings.activeVehicleId && this.data.vehicles.length > 0) {
                    this.data.settings.activeVehicleId = this.data.vehicles[0].id;
                }
                this._invalidateLogsCache();
                await this.migrateSchemaIfNeeded();
            },

            async migrateSchemaIfNeeded() {
                const raw = parseInt(this.data.settings.schemaVersion, 10);
                let schemaVersion = Number.isFinite(raw) ? raw : 1;
                let changedSettings = false;
                let updatedLogs = [];

                if (!this.data.settings.schemaVersion) {
                    this.data.settings.schemaVersion = schemaVersion;
                    changedSettings = true;
                }

                while (schemaVersion < this.currentSchemaVersion) {
                    if (schemaVersion === 1) {
                        if (!this.data.settings.pressureUnit) {
                            this.data.settings.pressureUnit = (this.data.settings.units === 'imperial') ? 'psi' : 'kPa';
                            changedSettings = true;
                        }
                        for (const log of this.data.logs) {
                            if (log && log.type === 'tire_replace' && (log.tirePressureKpa === undefined || log.tirePressureKpa === null || log.tirePressureKpa === '') && log.tirePressure !== undefined && log.tirePressure !== null && log.tirePressure !== '') {
                                const kpa = utils.pressureToKpa(log.tirePressure, 'psi');
                                if (kpa !== null) {
                                    log.tirePressureKpa = kpa.toFixed(1);
                                    updatedLogs.push(log);
                                }
                            }
                        }
                        schemaVersion = 2;
                        continue;
                    }
                    schemaVersion = this.currentSchemaVersion;
                }

                if (schemaVersion !== parseInt(this.data.settings.schemaVersion, 10)) {
                    this.data.settings.schemaVersion = schemaVersion;
                    changedSettings = true;
                }

                if (updatedLogs.length) {
                    await new Promise((resolve, reject) => {
                        const tx = this.db.transaction('logs', 'readwrite');
                        const s = tx.objectStore('logs');
                        for (const l of updatedLogs) s.put(l);
                        tx.oncomplete = () => resolve();
                        tx.onerror = () => reject(tx.error || new Error('Migration log update failed'));
                        tx.onabort = () => reject(tx.error || new Error('Migration log update aborted'));
                    });
                    this._invalidateLogsCache();
                }

                if (changedSettings) {
                    await this.saveData();
                }
            },

            async saveData() {
                await this.runTransaction('settings', 'readwrite', s => s.put({ id: 'global', ...this.data.settings }));
            },

            async addVehicle(vehicle) {
                this.data.vehicles.push(vehicle);
                if (!this.data.settings.activeVehicleId) {
                    this.data.settings.activeVehicleId = vehicle.id;
                    await this.saveData();
                }
                await this.runTransaction('vehicles', 'readwrite', s => s.put(vehicle));
            },

            async updateVehicle(vehicle) {
                const idx = this.data.vehicles.findIndex(v => v.id === vehicle.id);
                if (idx !== -1) {
                    this.data.vehicles[idx] = vehicle;
                    await this.runTransaction('vehicles', 'readwrite', s => s.put(vehicle));
                }
            },

            async deleteVehicle(id) {
                this.data.vehicles = this.data.vehicles.filter(v => v.id !== id);
                this.data.logs = this.data.logs.filter(l => l.vehicleId !== id);
                if (this.data.settings.activeVehicleId === id) {
                    this.data.settings.activeVehicleId = this.data.vehicles.length ? this.data.vehicles[0].id : null;
                    await this.saveData();
                }
                this._invalidateLogsCache();
                await this.runTransaction('vehicles', 'readwrite', s => s.delete(id));
                const tx = this.db.transaction('logs', 'readwrite');
                const logStore = tx.objectStore('logs');
                const idx = logStore.index('vehicleId');
                const keyRange = IDBKeyRange.only(id);
                const req = idx.openCursor(keyRange);
                req.onsuccess = (e) => {
                    const cursor = e.target.result;
                    if (cursor) { cursor.delete(); cursor.continue(); }
                };
            },

            async addLog(log) {
                this.data.logs.push(log);
                await this.runTransaction('logs', 'readwrite', s => s.put(log));
                
                // Auto-update vehicle odometer
                const vehicle = this.data.vehicles.find(v => v.id === log.vehicleId);
                const odo = parseFloat(log.odometer) || 0;
                const current = parseFloat(vehicle?.currentOdometer) || 0;
                if (vehicle && odo > current) {
                    vehicle.currentOdometer = odo;
                    await this.updateVehicle(vehicle);
                }
                if (!this._bulkImporting) this._invalidateLogsCache();
            },

            async updateLog(log) {
                const idx = this.data.logs.findIndex(l => l.id === log.id);
                if (idx !== -1) {
                    this.data.logs[idx] = log;
                    await this.runTransaction('logs', 'readwrite', s => s.put(log));
                    if (!this._bulkImporting) this._invalidateLogsCache();
                    
                    const vehicle = this.data.vehicles.find(v => v.id === log.vehicleId);
                    const maxOdo = Math.max(...this.data.logs.filter(l => l.vehicleId === log.vehicleId).map(l => parseFloat(l.odometer) || 0));
                    const current = parseFloat(vehicle?.currentOdometer) || 0;
                    if (vehicle && maxOdo > current) {
                        vehicle.currentOdometer = maxOdo;
                        await this.updateVehicle(vehicle);
                    }
                }
            },

            async deleteLog(id) {
                this.data.logs = this.data.logs.filter(l => l.id !== id);
                await this.runTransaction('logs', 'readwrite', s => s.delete(id));
                if (!this._bulkImporting) this._invalidateLogsCache();
            },

            async clearVehicleLogs(vehicleId) {
                this.data.logs = this.data.logs.filter(l => l.vehicleId !== vehicleId);
                if (!this._bulkImporting) this._invalidateLogsCache();
                const tx = this.db.transaction('logs', 'readwrite');
                const idx = tx.objectStore('logs').index('vehicleId');
                const req = idx.openCursor(IDBKeyRange.only(vehicleId));
                req.onsuccess = (e) => {
                    const cursor = e.target.result;
                    if (cursor) { cursor.delete(); cursor.continue(); }
                };
            },

            async importData(importedData, options = {}) {
                const { overwrite = false } = options;
                this._bulkImporting = true;
                if (overwrite) {
                    this.data.vehicles = [];
                    this.data.logs = [];
                    this.data.settings = { ...this.defaultSettings };
                    await this.clearAllData();
                }
                if (importedData.vehicles) {
                    for (const v of importedData.vehicles) await this.addVehicle(v);
                }
                if (importedData.logs) {
                    for (const l of importedData.logs) await this.addLog(l);
                }
                if (importedData.settings) {
                    this.data.settings = { ...this.data.settings, ...importedData.settings };
                    await this.saveData();
                }

                if (!this.data.settings.activeVehicleId && this.data.vehicles.length > 0) {
                    this.data.settings.activeVehicleId = this.data.vehicles[0].id;
                    await this.saveData();
                }
                this._bulkImporting = false;
                this._invalidateLogsCache();
            },

            getActiveVehicle() {
                return this.data.vehicles.find(v => v.id === this.data.settings.activeVehicleId);
            },
            
            getVehicleLogs(type = null) {
                const vehicleId = this.data.settings.activeVehicleId;
                const key = `${vehicleId || 'none'}|${type || '*'}|${this._logsVersion}`;
                const cached = this._cache.logsSorted.get(key);
                if (cached) return cached;
                let logs = this.data.logs.filter(l => l.vehicleId === vehicleId);
                if (type) logs = logs.filter(l => l.type === type);
                logs = logs.sort((a, b) => new Date(b.date) - new Date(a.date)); // Newest first
                this._cache.logsSorted.set(key, logs);
                return logs;
            }
        };

        // --- UTILS ---
        const utils = {
            t(key) {
                const lang = store.data.settings.language || 'en';
                return translations[lang][key] || key;
            },
            newId() {
                if (globalThis.crypto && typeof globalThis.crypto.randomUUID === 'function') {
                    return globalThis.crypto.randomUUID();
                }
                return `${Date.now().toString(36)}-${Math.random().toString(36).slice(2, 10)}`;
            },
            _debounceTimers: new Map(),
            debounceByKey(key, fn, waitMs = 200) {
                const t = this._debounceTimers.get(key);
                if (t) clearTimeout(t);
                const next = setTimeout(() => {
                    this._debounceTimers.delete(key);
                    fn();
                }, waitMs);
                this._debounceTimers.set(key, next);
            },
            cancelDebounce(key) {
                const t = this._debounceTimers.get(key);
                if (t) clearTimeout(t);
                this._debounceTimers.delete(key);
            },
            csvEscape(value) {
                const s = value === undefined || value === null ? '' : String(value);
                if (/[",\n\r]/.test(s)) return `"${s.replace(/"/g, '""')}"`;
                return s;
            },
            formatDate(isoString) {
                if (!isoString) return '';
                const date = new Date(isoString);
                const lang = store.data.settings.language;
                if (lang === 'zh') return `${date.getFullYear()}年${date.getMonth()+1}月${date.getDate()}日`;
                return date.toLocaleDateString('en-GB'); // DD/MM/YYYY
            },
            formatCurrency(amount) {
                if (amount === undefined || amount === null || amount === '--' || isNaN(parseFloat(amount))) return '--';
                return `${store.data.settings.currency}${parseFloat(amount).toFixed(2)}`;
            },
            getCostPerDistLabel() {
                const lang = store.data.settings.language || 'en';
                const unit = store.data.settings.units === 'imperial' ? 'mi' : 'km';
                if (lang === 'zh') return unit === 'mi' ? '每英里成本' : '每公里成本';
                return `Cost/${unit}`;
            },
            getDistUnit() { return store.data.settings.units === 'imperial' ? 'mi' : 'km'; },
            getPressureUnit() {
                const u = store.data.settings.pressureUnit;
                if (u === 'psi' || u === 'kPa' || u === 'bar') return u;
                return store.data.settings.units === 'imperial' ? 'psi' : 'kPa';
            },
            pressureToKpa(value, unit) {
                const v = parseFloat(value);
                if (!Number.isFinite(v)) return null;
                if (unit === 'psi') return v * 6.89476;
                if (unit === 'bar') return v * 100;
                return v; // kPa
            },
            pressureFromKpa(kpaValue, unit) {
                const v = parseFloat(kpaValue);
                if (!Number.isFinite(v)) return null;
                if (unit === 'psi') return v / 6.89476;
                if (unit === 'bar') return v / 100;
                return v; // kPa
            },
            formatPressureFromLog(log) {
                const unit = utils.getPressureUnit();
                let kpa = null;
                if (log && log.tirePressureKpa !== undefined && log.tirePressureKpa !== null && log.tirePressureKpa !== '') {
                    kpa = utils.pressureToKpa(log.tirePressureKpa, 'kPa');
                } else if (log && log.tirePressure !== undefined && log.tirePressure !== null && log.tirePressure !== '') {
                    // Back-compat: older entries assumed psi
                    kpa = utils.pressureToKpa(log.tirePressure, 'psi');
                }
                if (kpa === null) return null;
                const shown = utils.pressureFromKpa(kpa, unit);
                if (shown === null) return null;
                const decimals = unit === 'psi' ? 0 : 1;
                return `${shown.toFixed(decimals)} ${unit}`;
            },
            getFuelUnit() { 
                const v = store.getActiveVehicle();
                return v && v.fuelUnit ? v.fuelUnit : (store.data.settings.units === 'imperial' ? 'Gal' : 'L'); 
            },
            getEfficiencyLabel() {
                 const v = store.getActiveVehicle();
                 const distUnit = utils.getDistUnit();
                 const fuelUnit = v && v.fuelUnit ? v.fuelUnit : (store.data.settings.units === 'imperial' ? 'Gal' : 'L');
                 if (fuelUnit === 'kWh') return `kWh/100${distUnit}`;
                 if (distUnit === 'mi' && fuelUnit === 'Gal') return 'MPG';
                 return `${fuelUnit}/100${distUnit}`;
            },
            calcEfficiencyValue(fuelAmount, distAmount, fuelUnit, distUnit) {
                const f = parseFloat(fuelAmount) || 0;
                const d = parseFloat(distAmount) || 0;
                if (d <= 0 || f <= 0) return null;
                if (distUnit === 'mi' && fuelUnit === 'Gal') return d / f; // MPG
                return (f / d) * 100; // per 100 distance
            },
            filterByDateRange(logs, fromIso, toIso) {
                if (!fromIso && !toIso) return logs;
                const from = fromIso ? new Date(fromIso) : null;
                const to = toIso ? new Date(toIso) : null;
                return logs.filter(l => {
                    const d = new Date(l.date);
                    if (from && d < from) return false;
                    if (to) {
                        const end = new Date(to);
                        end.setHours(23, 59, 59, 999);
                        if (d > end) return false;
                    }
                    return true;
                });
            },
            getTirePositions() { return ['front_left','front_right','rear_left','rear_right']; },
            formatDaysShort(days) {
                const d = Math.max(0, Math.ceil(days));
                return (store.data.settings.language === 'zh') ? `${d}天` : `${d}d`;
            },
            getTireReplacementStatus(vehicle) {
                const distInt = parseInt(vehicle?.tireReplaceDist ?? store.data.settings.tireReplaceDist) || 0;
                const yearsInt = parseInt(vehicle?.tireReplaceYears ?? store.data.settings.tireReplaceYears) || 0;
                const now = new Date();
                const currentOdo = parseFloat(vehicle?.currentOdometer) || 0;
                const events = store.data.logs
                    .filter(l => l.vehicleId === vehicle?.id && (l.type === 'tire_replace' || l.type === 'tire_rotation'))
                    .map(l => ({
                        log: l,
                        odo: parseFloat(l.odometer) || 0,
                        dateMs: l.date ? new Date(l.date).getTime() : 0
                    }))
                    .sort((a, b) => (a.odo - b.odo) || (a.dateMs - b.dateMs));

                const posToTireId = new Map(utils.getTirePositions().map(p => [p, `init:${vehicle?.id}:${p}`]));
                const tireLastReplace = new Map(); // tireId -> { odo, dateMs, logId, log }

                for (const { log, odo, dateMs } of events) {
                    if (log.type === 'tire_replace') {
                        const pos = log.tirePosition;
                        if (!pos) continue;
                        const tireId = log.tireId || `rep:${log.id}`;
                        posToTireId.set(pos, tireId);
                        tireLastReplace.set(tireId, { odo, dateMs, logId: log.id, log });
                    } else if (log.type === 'tire_rotation') {
                        const swaps = Array.isArray(log.tireSwaps) && log.tireSwaps.length
                            ? log.tireSwaps
                            : (log.tireSwapA && log.tireSwapB ? [{ a: log.tireSwapA, b: log.tireSwapB }] : []);
                        for (const s of swaps) {
                            const a = s?.a;
                            const b = s?.b;
                            if (!a || !b || a === b) continue;
                            const idA = posToTireId.get(a);
                            const idB = posToTireId.get(b);
                            posToTireId.set(a, idB);
                            posToTireId.set(b, idA);
                        }
                    }
                }

                const yearDays = 365;
                return utils.getTirePositions().map((pos) => {
                    const tireId = posToTireId.get(pos);
                    const latest = tireId ? tireLastReplace.get(tireId) : null;
                    if (!latest) {
                        return { pos, editLogId: null, isOverdue: false, primary: utils.t('tire_not_set'), secondary: '', remainingKm: null, remainingDays: null, dueDateIso: null, dueOdo: null, isNotSet: true };
                    }

                    const lastOdo = latest.odo;
                    const lastDate = latest.dateMs ? new Date(latest.dateMs) : null;

                    const remainingDistSeed = Number.isFinite(parseFloat(latest.log?.tireRemainingDist))
                        ? parseFloat(latest.log.tireRemainingDist)
                        : null;
                    const remainingDaysSeed = Number.isFinite(parseFloat(latest.log?.tireRemainingDays))
                        ? parseFloat(latest.log.tireRemainingDays)
                        : null;
                    if (remainingDistSeed !== null || remainingDaysSeed !== null) {
                        const distUsed = Math.max(0, currentOdo - lastOdo);
                        const remainingKm = remainingDistSeed === null ? null : (remainingDistSeed - distUsed);
                        const daysElapsed = latest.dateMs ? Math.floor((now.getTime() - latest.dateMs) / 86400000) : 0;
                        const remainingDays = remainingDaysSeed === null ? null : (remainingDaysSeed - daysElapsed);

                        const overdueDist = remainingKm !== null && remainingKm <= 0;
                        const overdueTime = remainingDays !== null && remainingDays <= 0;
                        const isOverdue = overdueDist || overdueTime;

                        const distText = remainingKm === null ? '' : `${Math.max(0, Math.round(remainingKm)).toLocaleString()} ${utils.getDistUnit()}`;
                        const timeText = remainingDays === null ? '' : utils.formatDaysShort(remainingDays);

                        const distFrac = remainingKm === null || !remainingDistSeed ? Number.POSITIVE_INFINITY : (remainingKm / Math.max(1, remainingDistSeed));
                        const timeFrac = remainingDays === null || !remainingDaysSeed ? Number.POSITIVE_INFINITY : (remainingDays / Math.max(1, remainingDaysSeed));
                        const primaryIsDist = distFrac <= timeFrac;

                        const primary = isOverdue ? utils.t('overdue') : (primaryIsDist ? (distText || timeText) : (timeText || distText));
                        const secondaryParts = [];
                        if (!isOverdue && distText && !primaryIsDist) secondaryParts.push(distText);
                        if (!isOverdue && timeText && primaryIsDist) secondaryParts.push(timeText);
                        const secondary = secondaryParts.length ? `${utils.t('due_in')} ${secondaryParts.join(' / ')}` : '';

                        const dueOdo = remainingDistSeed === null ? null : (lastOdo + remainingDistSeed);
                        const dueDate = (remainingDaysSeed !== null && lastDate)
                            ? new Date(lastDate.getTime() + remainingDaysSeed * 86400000)
                            : null;

                        return { pos, editLogId: latest.logId || null, isOverdue, primary, secondary, remainingKm, remainingDays, dueDateIso: dueDate ? dueDate.toISOString() : null, dueOdo, isNotSet: false };
                    }

                    const dueOdo = distInt > 0 ? (lastOdo + distInt) : null;
                    const remainingKm = dueOdo === null ? null : (dueOdo - currentOdo);

                    let dueDate = null;
                    let remainingDays = null;
                    if (yearsInt > 0 && lastDate) {
                        dueDate = new Date(lastDate);
                        dueDate.setFullYear(dueDate.getFullYear() + yearsInt);
                        remainingDays = Math.ceil((dueDate - now) / 86400000);
                    }

                    const overdueDist = remainingKm !== null && remainingKm <= 0;
                    const overdueTime = remainingDays !== null && remainingDays <= 0;
                    const isOverdue = overdueDist || overdueTime;

                    const distText = remainingKm === null ? '' : `${Math.max(0, Math.round(remainingKm)).toLocaleString()} ${utils.getDistUnit()}`;
                    const timeText = remainingDays === null ? '' : utils.formatDaysShort(remainingDays);

                    const distFrac = remainingKm === null ? Number.POSITIVE_INFINITY : (remainingKm / Math.max(1, distInt));
                    const timeFrac = remainingDays === null ? Number.POSITIVE_INFINITY : (remainingDays / Math.max(1, yearsInt * yearDays));
                    const primaryIsDist = distFrac <= timeFrac;

                    const primary = isOverdue ? utils.t('overdue') : (primaryIsDist ? (distText || timeText) : (timeText || distText));
                    const secondaryParts = [];
                    if (!isOverdue && distText && !primaryIsDist) secondaryParts.push(distText);
                    if (!isOverdue && timeText && primaryIsDist) secondaryParts.push(timeText);
                    const secondary = secondaryParts.length ? `${utils.t('due_in')} ${secondaryParts.join(' / ')}` : '';

                    return { pos, editLogId: latest.logId || null, isOverdue, primary, secondary, remainingKm, remainingDays, dueDateIso: dueDate ? dueDate.toISOString() : null, dueOdo, isNotSet: false };
                });
            },

            getTireTimeline(vehicle) {
                const events = store.data.logs
                    .filter(l => l.vehicleId === vehicle?.id && (l.type === 'tire_replace' || l.type === 'tire_rotation'))
                    .map(l => ({
                        log: l,
                        odo: parseFloat(l.odometer) || 0,
                        dateMs: l.date ? new Date(l.date).getTime() : 0
                    }))
                    .sort((a, b) => (a.odo - b.odo) || (a.dateMs - b.dateMs));

                const posToTireId = new Map(utils.getTirePositions().map(p => [p, `init:${vehicle?.id}:${p}`]));
                const tires = new Map(); // tireId -> { tireId, currentPos, lastReplace, events: [] }

                const ensure = (tireId) => {
                    if (!tires.has(tireId)) tires.set(tireId, { tireId, currentPos: null, lastReplace: null, events: [] });
                    return tires.get(tireId);
                };

                for (const { log, odo } of events) {
                    if (log.type === 'tire_replace') {
                        const pos = log.tirePosition;
                        if (!pos) continue;
                        const tireId = log.tireId || `rep:${log.id}`;
                        posToTireId.set(pos, tireId);
                        const t = ensure(tireId);
                        t.lastReplace = { logId: log.id, date: log.date, odometer: odo, brand: log.tireBrand || '' };
                        t.events.push({ kind: 'replace', logId: log.id, date: log.date, odometer: odo, pos, brand: log.tireBrand || '' });
                    } else if (log.type === 'tire_rotation') {
                        const swaps = Array.isArray(log.tireSwaps) && log.tireSwaps.length
                            ? log.tireSwaps
                            : (log.tireSwapA && log.tireSwapB ? [{ a: log.tireSwapA, b: log.tireSwapB }] : []);
                        for (const s of swaps) {
                            const a = s?.a;
                            const b = s?.b;
                            if (!a || !b || a === b) continue;
                            const idA = posToTireId.get(a);
                            const idB = posToTireId.get(b);
                            if (idA) ensure(idA).events.push({ kind: 'rotate', logId: log.id, date: log.date, odometer: odo, from: a, to: b });
                            if (idB) ensure(idB).events.push({ kind: 'rotate', logId: log.id, date: log.date, odometer: odo, from: b, to: a });
                            posToTireId.set(a, idB);
                            posToTireId.set(b, idA);
                        }
                    }
                }

                for (const [pos, tireId] of posToTireId.entries()) {
                    ensure(tireId).currentPos = pos;
                }

                const posRank = new Map(utils.getTirePositions().map((p, i) => [p, i]));
                return Array.from(tires.values()).sort((a, b) => {
                    const ar = a.currentPos ? posRank.get(a.currentPos) ?? 999 : 999;
                    const br = b.currentPos ? posRank.get(b.currentPos) ?? 999 : 999;
                    if (ar !== br) return ar - br;
                    const ad = a.lastReplace?.date ? new Date(a.lastReplace.date).getTime() : 0;
                    const bd = b.lastReplace?.date ? new Date(b.lastReplace.date).getTime() : 0;
                    return bd - ad;
                });
            },
            
            getAvailableYears() {
                const logs = store.getVehicleLogs();
                const years = new Set(
                    logs
                        .map(l => new Date(l.date).getFullYear())
                        .filter(y => Number.isFinite(y))
                );
                if (!years.size) years.add(new Date().getFullYear());
                return Array.from(years).sort((a,b) => b-a);
            },
            filterLogs(logs, filter) {
                if (!filter) return logs;
                return logs.filter(l => {
                    const d = new Date(l.date);
                    if (filter.mode === 'month') {
                        const [y, m] = filter.value.split('-');
                        return d.getFullYear() == y && (d.getMonth() + 1) == m;
                    } else if (filter.mode === 'year') {
                         return d.getFullYear() == filter.value;
                    }
                    return true; 
                });
            },

            calculateStats(logs, category = 'all') {
                if (!logs.length) return { efficiency: '--', costKm: '--', totalCost: 0, totalDist: 0, totalDistCount: 0 };
                
                // 1. Total Cost
                const totalCost = logs.reduce((sum, l) => {
                    const c = parseFloat(l.cost);
                    return sum + (Number.isFinite(c) ? c : 0);
                }, 0);
                
                // 2. Total Distance
                const odoLogs = logs.filter(l => Number.isFinite(parseFloat(l.odometer)));
                const sorted = odoLogs.sort((a, b) => parseFloat(a.odometer) - parseFloat(b.odometer));
                const totalDist = sorted.length > 1
                    ? (parseFloat(sorted[sorted.length-1].odometer) - parseFloat(sorted[0].odometer))
                    : (sorted.length === 1 ? (parseFloat(sorted[0].odometer) || 0) : 0);

                // 3. Fuel Efficiency (Always calc if fuel data exists)
                let efficiency = '--';
                let costKm = '--';
                
                if (category === 'fuel' || category === 'all') {
                    // Filter specifically for fuel logs to calculate efficiency
                    const fuelLogs = logs.filter(l => l.type === 'fuel').sort((a, b) => parseFloat(a.odometer) - parseFloat(b.odometer));
                    const v = store.getActiveVehicle();
                    const isImperial = store.data.settings.units === 'imperial';
                    const isEV = v && v.fuelUnit === 'kWh';
                    const distUnit = utils.getDistUnit();
                    const fuelUnit = v && v.fuelUnit ? v.fuelUnit : (isImperial ? 'Gal' : 'L');
                    
                    if (fuelLogs.length > 1) {
                        let totalFuel = 0;
                        let validDist = 0;
                        
                        for (let i = 0; i < fuelLogs.length - 1; i++) {
                            const curr = fuelLogs[i];
                            const next = fuelLogs[i+1];
                            
                            // Simple efficiency calculation: if segments are consecutive full tanks
                            if (!curr.isPartial && !next.isPartial) {
                                const dist = next.odometer - curr.odometer;
                                if (dist > 0) {
                                    validDist += dist;
                                    totalFuel += parseFloat(next.liters) || 0; 
                                }
                            }
                        }
                        
                        if (validDist > 0 && totalFuel > 0) {
                            const eff = utils.calcEfficiencyValue(totalFuel, validDist, fuelUnit, distUnit);
                            if (eff !== null) efficiency = eff.toFixed(1);
                        }
                    }
                }
                
                // 4. Cost per KM (Total)
                if (totalDist > 0 && totalCost > 0) {
                    costKm = (totalCost / totalDist).toFixed(2);
                }

                return { efficiency, costKm, totalCost, totalDist, totalDistCount: sorted.length };
            },
            
            detectLocation(callback) {
                if (!navigator.geolocation) return callback('');
                navigator.geolocation.getCurrentPosition(async (pos) => {
                    try {
                        const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${pos.coords.latitude}&lon=${pos.coords.longitude}`);
                        const data = await res.json();
                        const parts = [data.address.amenity, data.address.road, data.address.suburb].filter(Boolean);
                        callback(parts.join(', ') || `${pos.coords.latitude.toFixed(3)}, ${pos.coords.longitude.toFixed(3)}`);
                    } catch {
                        callback(`${pos.coords.latitude.toFixed(3)}, ${pos.coords.longitude.toFixed(3)}`);
                    }
                }, () => callback(''));
            },

            generateTrendChart(logs) {
                const fuelLogs = logs.filter(l => l.type === 'fuel' && !l.isPartial).sort((a,b) => new Date(a.date) - new Date(b.date));
                if (fuelLogs.length < 2) return '';
                const v = store.getActiveVehicle();
                const isImperial = store.data.settings.units === 'imperial';
                const distUnit = utils.getDistUnit();
                const fuelUnit = v && v.fuelUnit ? v.fuelUnit : (isImperial ? 'Gal' : 'L');
                
                const monthly = new Map();
                for (let i = 0; i < fuelLogs.length - 1; i++) {
                    const dist = fuelLogs[i+1].odometer - fuelLogs[i].odometer;
                    if (dist <= 0) continue;
                    const fuel = parseFloat(fuelLogs[i+1].liters) || 0;
                    if (fuel <= 0) continue;
                    const ym = fuelLogs[i+1].date ? fuelLogs[i+1].date.slice(0, 7) : '';
                    if (!ym) continue;
                    const cur = monthly.get(ym) || { fuel: 0, dist: 0 };
                    cur.fuel += fuel;
                    cur.dist += dist;
                    monthly.set(ym, cur);
                }
                const recentPoints = Array.from(monthly.entries())
                    .sort((a, b) => a[0].localeCompare(b[0]))
                    .slice(-12)
                    .map(([ym, v]) => ({
                        val: utils.calcEfficiencyValue(v.fuel, v.dist, fuelUnit, distUnit),
                        month: ym.slice(5, 7)
                    }))
                    .filter(p => p.val !== null);
                if (recentPoints.length < 1) return '';

                const w = 300, h = 120; 
                const max = Math.max(...recentPoints.map(p => p.val)) * 1.1;
                const min = Math.min(...recentPoints.map(p => p.val)) * 0.9;
                const range = max - min || 1;
                const avg = recentPoints.reduce((a,b)=>a+b.val,0) / recentPoints.length;
                const avgY = h - ((avg - min) / range) * h;
                
                const points = recentPoints.map((p, i) => {
                    const x = (i / (recentPoints.length - 1)) * w;
                    const y = h - ((p.val - min) / range) * h;
                    return {x, y, val: p.val, month: p.month};
                });
                
                const pathD = points.map((p, i) => (i===0 ? 'M' : 'L') + `${p.x},${p.y}`).join(' ');
                const fillD = `M0,${h} ${pathD} L${w},${h}`;

                return `
                    <svg viewBox="-10 -20 ${w+20} ${h+40}" class="w-full h-full overflow-visible">
                        <defs>
                            <linearGradient id="chartGrad" x1="0" x2="0" y1="0" y2="1">
                                <stop offset="0%" stop-color="currentColor" stop-opacity="0.3"/>
                                <stop offset="100%" stop-color="currentColor" stop-opacity="0"/>
                            </linearGradient>
                        </defs>
                        <!-- Grid -->
                        <line x1="0" y1="${avgY}" x2="${w}" y2="${avgY}" stroke="currentColor" stroke-width="1" stroke-dasharray="5,5" opacity="0.3" />
                        <text x="0" y="${avgY-5}" font-size="8" fill="currentColor" opacity="0.5">AVG: ${avg.toFixed(1)}</text>

                        <!-- Area & Line -->
                        <path d="${fillD}" fill="url(#chartGrad)" class="text-teal-500"/>
                        <path d="${pathD}" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-teal-600"/>
                        
                        <!-- Points & Labels -->
                        ${points.map(p => `
                            <circle cx="${p.x}" cy="${p.y}" r="3" fill="white" stroke="currentColor" stroke-width="2" class="text-teal-600"/>
                            <text x="${p.x}" y="${p.y - 10}" text-anchor="middle" font-size="8" font-weight="bold" fill="currentColor">${p.val.toFixed(1)}</text>
                            ${p.month ? `<text x="${p.x}" y="${h + 14}" text-anchor="middle" font-size="8" font-weight="600" fill="currentColor" opacity="0.6">${p.month}</text>` : ''}
                        `).join('')}
                    </svg>
                `;
            },
            
            generateMonthlyBarChart(logs) {
                const months = [];
                const now = new Date();
                for (let i=5; i>=0; i--) {
                    const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
                    months.push(d.toISOString().slice(0, 7)); 
                }
                
                const data = months.map(m => {
                    const monthLogs = logs.filter(l => l.date.startsWith(m));
                    const fuel = monthLogs.filter(l => l.type === 'fuel').reduce((sum, l) => sum + (Number.isFinite(parseFloat(l.cost)) ? parseFloat(l.cost) : 0), 0);
                    const parking = monthLogs.filter(l => l.type === 'parking').reduce((sum, l) => sum + (Number.isFinite(parseFloat(l.cost)) ? parseFloat(l.cost) : 0), 0);
                    const fine = monthLogs.filter(l => l.type === 'fine').reduce((sum, l) => sum + (Number.isFinite(parseFloat(l.cost)) ? parseFloat(l.cost) : 0), 0);
                    const docs = monthLogs.filter(l => ['license', 'insurance', 'registration'].includes(l.type)).reduce((sum, l) => sum + (Number.isFinite(parseFloat(l.cost)) ? parseFloat(l.cost) : 0), 0);
                    const maintenance = monthLogs
                        .filter(l => !['fuel', 'parking', 'fine', 'license', 'insurance', 'registration'].includes(l.type))
                        .reduce((sum, l) => sum + (Number.isFinite(parseFloat(l.cost)) ? parseFloat(l.cost) : 0), 0);
                    return { month: m, fuel, maintenance, parking, fine, docs };
                });
                
                const maxVal = Math.max(...data.map(d => d.fuel + d.maintenance + d.parking + d.fine + d.docs)) || 100;
                const w = 360, h = 240;
                const barW = (w / 6) * 0.6;
                const chartBottom = h - 36;
                const formatVal = (v) => `${store.data.settings.currency}${Math.round(v).toLocaleString()}`;
                
                return `
                    <svg viewBox="0 0 ${w} ${h}" class="w-full h-full overflow-visible">
                        <!-- Grid Lines -->
                        ${[0.25, 0.5, 0.75, 1].map(p => {
                            const y = chartBottom - (chartBottom * p);
                            return `<line x1="0" y1="${y}" x2="${w}" y2="${y}" stroke="currentColor" stroke-opacity="0.05" stroke-dasharray="4,4" />`;
                        }).join('')}

                        ${data.map((d, i) => {
                            const x = (w/6) * i + (w/6 - barW)/2;
                            const hFuel = (d.fuel / maxVal) * chartBottom;
                            const hMaintenance = (d.maintenance / maxVal) * chartBottom;
                            const hParking = (d.parking / maxVal) * chartBottom;
                            const hFine = (d.fine / maxVal) * chartBottom;
                            const hDocs = (d.docs / maxVal) * chartBottom;
                            const yFuel = chartBottom - hFuel;
                            const yMaintenance = yFuel - hMaintenance;
                            const yParking = yMaintenance - hParking;
                            const yFine = yParking - hFine;
                            const yDocs = yFine - hDocs;
                            const total = d.fuel + d.maintenance + d.parking + d.fine + d.docs;
                            const labelBaseSize = 11;
                            const labelSmallSize = 9;
                            const labelOpacity = (h) => (h >= 14 ? 0.95 : 0.6);
                            
                            return `
                                <rect x="${x}" y="${yFuel}" width="${barW}" height="${hFuel}" class="fill-teal-500" rx="4" data-label-id="m${i}-fuel" data-label="${utils.t('fuel')}" data-value="${formatVal(d.fuel)}" data-month="${d.month.split('-')[1]}" data-series="fuel" data-month-index="${i}" />
                                <rect x="${x}" y="${yMaintenance}" width="${barW}" height="${hMaintenance}" class="fill-purple-400" rx="4" data-label-id="m${i}-maintenance" data-label="${utils.t('maintenance')}" data-value="${formatVal(d.maintenance)}" data-month="${d.month.split('-')[1]}" data-series="maintenance" data-month-index="${i}" />
                                <rect x="${x}" y="${yParking}" width="${barW}" height="${hParking}" class="fill-blue-400" rx="4" data-label-id="m${i}-parking" data-label="${utils.t('parking')}" data-value="${formatVal(d.parking)}" data-month="${d.month.split('-')[1]}" data-series="parking" data-month-index="${i}" />
                                <rect x="${x}" y="${yFine}" width="${barW}" height="${hFine}" class="fill-red-400" rx="4" data-label-id="m${i}-fine" data-label="${utils.t('traffic_fine')}" data-value="${formatVal(d.fine)}" data-month="${d.month.split('-')[1]}" data-series="fine" data-month-index="${i}" />
                                <rect x="${x}" y="${yDocs}" width="${barW}" height="${hDocs}" class="fill-amber-400" rx="4" data-label-id="m${i}-docs" data-label="${utils.t('fixed_costs')}" data-value="${formatVal(d.docs)}" data-month="${d.month.split('-')[1]}" data-series="fixed" data-month-index="${i}" />
                                ${total > 0 ? `<text x="${x + barW/2}" y="${yDocs - 8}" text-anchor="middle" font-size="12" font-weight="800" fill="currentColor" opacity="0.9">${formatVal(total)}</text>` : ''}
                                ${d.fuel > 0 ? `<text x="${x + barW/2}" y="${yFuel + hFuel/2 + 4}" text-anchor="middle" font-size="${hFuel >= 12 ? labelBaseSize : labelSmallSize}" font-weight="600" fill="white" opacity="${labelOpacity(hFuel)}" data-label-id="m${i}-fuel" data-base-size="${hFuel >= 12 ? labelBaseSize : labelSmallSize}" pointer-events="none">${formatVal(d.fuel)}</text>` : ''}
                                ${d.maintenance > 0 ? `<text x="${x + barW/2}" y="${yMaintenance + hMaintenance/2 + 4}" text-anchor="middle" font-size="${hMaintenance >= 12 ? labelBaseSize : labelSmallSize}" font-weight="600" fill="white" opacity="${labelOpacity(hMaintenance)}" data-label-id="m${i}-maintenance" data-base-size="${hMaintenance >= 12 ? labelBaseSize : labelSmallSize}" pointer-events="none">${formatVal(d.maintenance)}</text>` : ''}
                                ${d.parking > 0 ? `<text x="${x + barW/2}" y="${yParking + hParking/2 + 4}" text-anchor="middle" font-size="${hParking >= 12 ? labelBaseSize : labelSmallSize}" font-weight="600" fill="white" opacity="${labelOpacity(hParking)}" data-label-id="m${i}-parking" data-base-size="${hParking >= 12 ? labelBaseSize : labelSmallSize}" pointer-events="none">${formatVal(d.parking)}</text>` : ''}
                                ${d.fine > 0 ? `<text x="${x + barW/2}" y="${yFine + hFine/2 + 4}" text-anchor="middle" font-size="${hFine >= 12 ? labelBaseSize : labelSmallSize}" font-weight="600" fill="white" opacity="${labelOpacity(hFine)}" data-label-id="m${i}-fine" data-base-size="${hFine >= 12 ? labelBaseSize : labelSmallSize}" pointer-events="none">${formatVal(d.fine)}</text>` : ''}
                                ${d.docs > 0 ? `<text x="${x + barW/2}" y="${yDocs + hDocs/2 + 4}" text-anchor="middle" font-size="${hDocs >= 12 ? labelBaseSize : labelSmallSize}" font-weight="600" fill="white" opacity="${labelOpacity(hDocs)}" data-label-id="m${i}-docs" data-base-size="${hDocs >= 12 ? labelBaseSize : labelSmallSize}" pointer-events="none">${formatVal(d.docs)}</text>` : ''}
                                <text x="${x + barW/2}" y="${h}" text-anchor="middle" font-size="12" font-weight="700" fill="currentColor" opacity="0.7">${d.month.split('-')[1]}</text>
                            `;
                        }).join('')}
                    </svg>
                `;
            },

            exportCSV() {
                const logs = store.getVehicleLogs();
                const fuelUnit = utils.getFuelUnit();
                const rows = [['Date', 'Type', `Odometer (${utils.getDistUnit()})`, `Cost (${store.data.settings.currency})`, 'Details']];
                logs.forEach(l => {
                    let details = l.notes || '';
                    if (l.type === 'fuel') {
                        const tank = l.isPartial ? utils.t('partial') : utils.t('full');
                        details = `${l.liters}${fuelUnit}, ${tank}`;
                    }
                    rows.push([l.date, l.type, l.odometer ?? '', l.cost ?? '', details]);
                });
                const csv = rows.map(r => r.map(utils.csvEscape).join(',')).join('\n') + '\n';
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `fuelmate_export_${new Date().toISOString().slice(0,10)}.csv`;
                a.click();
            },
            
            exportCalendar(type, alarmDays) {
                const v = store.getActiveVehicle();
                if (!v) return;
                const logs = store.getVehicleLogs(type);
                if (!logs.length || !logs[0].expiryDate) return alert('No expiry date found for this item.');
                
                const log = logs[0];
                const expDate = log.expiryDate.replace(/-/g, ''); 
                const title = `${utils.t(type)}: ${v.make} ${v.model}`;
                
                let alarmBlock = '';
                if (alarmDays !== null) {
                    const trigger = `-P${alarmDays}D`; 
                    alarmBlock = `BEGIN:VALARM\nTRIGGER:${trigger}\nDESCRIPTION:${title}\nACTION:DISPLAY\nEND:VALARM\n`;
                }

                const ics = `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//FuelMate//EN
BEGIN:VEVENT
UID:${utils.newId()}@fuelmate
DTSTAMP:${new Date().toISOString().replace(/[-:]/g, '').split('.')[0]}Z
DTSTART;VALUE=DATE:${expDate}
SUMMARY:${title}
DESCRIPTION:Renew ${utils.t(type)} for ${v.make} ${v.model}
${alarmBlock}END:VEVENT
END:VCALENDAR`;

                const blob = new Blob([ics], { type: 'text/calendar' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `fuelmate_${type}.ics`;
                a.click();
            },

            exportDateCalendar(title, isoDate, alarmDays = null) {
                if (!isoDate) return;
                const dateStr = isoDate.slice(0, 10).replace(/-/g, '');
                let alarmBlock = '';
                if (alarmDays !== null) {
                    const trigger = `-P${alarmDays}D`;
                    alarmBlock = `BEGIN:VALARM\nTRIGGER:${trigger}\nDESCRIPTION:${title}\nACTION:DISPLAY\nEND:VALARM\n`;
                }
                const ics = `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//FuelMate//EN
BEGIN:VEVENT
UID:${utils.newId()}@fuelmate
DTSTAMP:${new Date().toISOString().replace(/[-:]/g, '').split('.')[0]}Z
DTSTART;VALUE=DATE:${dateStr}
SUMMARY:${title}
${alarmBlock}END:VEVENT
END:VCALENDAR`;
                const blob = new Blob([ics], { type: 'text/calendar' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `fuelmate_reminder_${dateStr}.ics`;
                a.click();
            },
            formatFileSize(bytes) {
                const b = Number(bytes) || 0;
                if (b < 1024) return `${b} B`;
                if (b < 1024 * 1024) return `${(b / 1024).toFixed(1)} KB`;
                return `${(b / (1024 * 1024)).toFixed(1)} MB`;
            },
            summarizeImportData(data) {
                const vehicles = Array.isArray(data?.vehicles) ? data.vehicles : [];
                const logs = Array.isArray(data?.logs) ? data.logs : [];
                const typeCounts = logs.reduce((acc, l) => {
                    const t = l?.type || 'unknown';
                    acc[t] = (acc[t] || 0) + 1;
                    return acc;
                }, {});
                const settings = data?.settings || {};
                return {
                    vehiclesCount: vehicles.length,
                    logsCount: logs.length,
                    typeCounts,
                    settings: {
                        units: settings.units,
                        currency: settings.currency,
                        language: settings.language
                    }
                };
            },
            validateImportData(data) {
                const errors = [];
                const warnings = [];
                if (!data || typeof data !== 'object') errors.push('root_not_object');

                const vehicles = Array.isArray(data?.vehicles) ? data.vehicles : null;
                const logs = Array.isArray(data?.logs) ? data.logs : null;
                const settings = data?.settings;

                if (!vehicles) errors.push('vehicles_not_array');
                if (!logs) errors.push('logs_not_array');
                if (settings !== undefined && (settings === null || typeof settings !== 'object')) errors.push('settings_not_object');

                if (vehicles) {
                    const ids = new Set();
                    for (const v of vehicles) {
                        if (!v || typeof v !== 'object') { errors.push('vehicle_not_object'); break; }
                        if (!v.id) { errors.push('vehicle_missing_id'); break; }
                        ids.add(String(v.id));
                    }
                    if (logs) {
                        let orphan = 0;
                        for (const l of logs) {
                            if (!l || typeof l !== 'object') { errors.push('log_not_object'); break; }
                            if (!l.id || !l.vehicleId || !l.type || !l.date) { errors.push('log_missing_fields'); break; }
                            if (!ids.has(String(l.vehicleId))) orphan++;
                        }
                        if (orphan > 0) warnings.push({ code: 'orphan_logs', count: orphan });
                    }
                }

                return {
                    ok: errors.length === 0,
                    errors,
                    warnings,
                    summary: utils.summarizeImportData(data)
                };
            },

            getCarColorClass(color) {
                const map = {
                    teal: 'grad-teal text-white', blue: 'grad-blue text-white', red: 'grad-red text-white',
                    black: 'grad-black text-white', white: 'grad-white', yellow: 'grad-yellow text-white',
                    purple: 'grad-purple text-white', green: 'grad-green text-white', orange: 'grad-orange text-white',
                    brown: 'grad-brown text-white', grey: 'grad-grey text-white', pink: 'grad-pink text-white', cyan: 'grad-cyan text-white'
                };
                return map[color] || map.teal;
            },
            getCarIcon(type) {
                const map = {
                    sedan: 'directions_car',
                    hatch: 'directions_car',
                    suv: 'airport_shuttle',
                    offroad_4x4: 'terrain',
                    ute: 'local_shipping',
                    bike: 'two_wheeler',
                    truck: 'local_shipping',
                    sports: 'sports_motorsports',
                    van: 'airport_shuttle',
                    bus: 'directions_bus'
                };
                return map[type] || 'directions_car';
            }
        };

        // --- UI RENDERER ---
        const ui = {
            init() {
                store.init().then(() => {
                    this.render();
                    if (!store.data.vehicles.length) this.openAddVehicle();
                }).catch(err => console.error("DB Init Failed", err));
            },

            getPageLimit(pageKey) {
                const v = store.pageLimits?.[pageKey];
                return Number.isFinite(v) && v > 0 ? v : 100;
            },

            _searchDebounceKey(pageKey, filterKey) {
                return `search:${pageKey}:${filterKey}`;
            },

            onSearchInput(pageKey, filterKey, value) {
                const key = this._searchDebounceKey(pageKey, filterKey);
                utils.debounceByKey(key, () => {
                    store.pageFilters[filterKey] = value;
                    this.resetPageLimit(pageKey);
                    this.render();
                }, 200);
            },

            clearSearch(pageKey, filterKey) {
                const key = this._searchDebounceKey(pageKey, filterKey);
                utils.cancelDebounce(key);
                store.pageFilters[filterKey] = '';
                this.resetPageLimit(pageKey);
                this.render();
            },

            resetPageLimit(pageKey) {
                if (!store.pageLimits) store.pageLimits = {};
                if (pageKey && Object.prototype.hasOwnProperty.call(store.pageLimits, pageKey)) {
                    store.pageLimits[pageKey] = 100;
                }
            },

            loadMore(pageKey, step = 100) {
                if (!store.pageLimits) store.pageLimits = {};
                const curr = this.getPageLimit(pageKey);
                store.pageLimits[pageKey] = curr + step;
                this.render();
            },

            renderLoadMore(pageKey, shown, total) {
                const safeShown = Math.max(0, Math.min(total || 0, shown || 0));
                return `
                    <div class="pt-2 pb-6 flex flex-col items-center gap-2">
                        <div class="text-[10px] theme-text-sub">${utils.t('showing')} ${safeShown.toLocaleString()} / ${(total || 0).toLocaleString()}</div>
                        <button onclick="ui.loadMore('${pageKey}')" class="px-4 py-2 rounded-xl text-sm font-bold bg-slate-100 dark:bg-slate-800 theme-text-heading border theme-border active:scale-95 transition-transform">
                            ${utils.t('load_more')}
                        </button>
                    </div>
                `;
            },

            render() {
                const app = document.getElementById('app');
                const page = router.currentPage;
                const vehicle = store.getActiveVehicle();
                const scrollY = window.scrollY;

                if (!vehicle && store.data.vehicles.length > 0) {
                     store.data.settings.activeVehicleId = store.data.vehicles[0].id;
                     store.saveData().then(() => this.render());
                     return;
                }

                let content = '';
                if (!vehicle) {
                    content = this.renderNoVehicleState();
                } else {
                    if (page === 'dashboard') content = this.renderDashboard(vehicle);
                    else if (page === 'fuel') content = this.renderFuel(vehicle);
                    else if (page === 'maintenance') content = this.renderMaintenance(vehicle);
                    else if (page === 'parking') content = this.renderParking(vehicle);
                    else if (page === 'analytics') content = this.renderAnalytics(vehicle);
                    else if (page === 'reminders') content = this.renderReminders(vehicle);
                    else if (page === 'settings') content = this.renderSettings(vehicle);
                }

                app.innerHTML = `
                    ${content}
                    ${this.renderBottomNav(page)}
                `;
                window.scrollTo(0, scrollY);
            },
            
            renderNoVehicleState() {
                return `
                    <div class="flex flex-col items-center justify-center min-h-[80vh] p-8 text-center">
                        <div class="w-24 h-24 bg-teal-100 rounded-full flex items-center justify-center mb-6">
                            <span class="material-icons text-4xl text-teal-600">no_crash</span>
                        </div>
                        <h2 class="text-2xl font-bold mb-2 theme-text-heading">${utils.t('welcome')}</h2>
                        <p class="theme-text-sub mb-8">Add your first vehicle to start tracking fuel, costs, and maintenance.</p>
                        <button onclick="ui.openAddVehicle()" class="grad-teal text-white px-8 py-3 rounded-xl font-bold shadow-lg shadow-teal-500/30 active:scale-95 transition-transform flex items-center gap-2">
                            <span class="material-icons">add</span> ${utils.t('add_vehicle')}
                        </button>
                        <button onclick="ui.addDemoCar()" class="mt-3 bg-white dark:bg-slate-800 theme-text-heading px-8 py-3 rounded-xl font-bold shadow active:scale-95 transition-transform flex items-center gap-2 border theme-border">
                            <span class="material-icons text-teal-500">auto_awesome</span> ${utils.t('add_demo_car')}
                        </button>
                    </div>
                `;
            },

            renderSearchPanel(opts) {
                const {
                    searchValue = '',
                    onSearchInput = '',
                    onClearSearch = '',
                    placeholder = 'Search...',
                    fromValue = '',
                    toValue = '',
                    onFromChange = '',
                    onToChange = '',
                    onClearRange = '',
                    chips = []
                } = opts || {};

                const hasRange = onFromChange || onToChange;
                const hasSearch = onSearchInput;
                return `
                    <div class="space-y-3 mb-4">
                        ${hasSearch ? `
                            <div class="relative">
                                <span class="material-icons absolute left-3 top-2.5 text-slate-400 text-lg">search</span>
                                <input type="text" placeholder="${placeholder}" value="${searchValue || ''}" oninput="${onSearchInput}" class="w-full pl-10 pr-10 py-2 rounded-xl theme-bg-card theme-text-heading shadow-sm border-none focus:ring-2 focus:ring-teal-500 text-sm">
                                ${searchValue ? `<button onclick="${onClearSearch}" class="absolute right-2 top-2 w-8 h-8 rounded-full bg-slate-100 dark:bg-slate-800 flex items-center justify-center"><span class="material-icons text-slate-500 text-base">close</span></button>` : ''}
                            </div>
                        ` : ''}

                        ${hasRange ? `
                            <div class="grid grid-cols-2 gap-3">
                                <div class="relative">
                                    <input type="date" value="${fromValue || ''}" onchange="${onFromChange}" class="w-full p-2.5 rounded-xl theme-bg-card theme-text-heading shadow-sm border-none focus:ring-2 focus:ring-teal-500 text-sm">
                                </div>
                                <div class="relative">
                                    <input type="date" value="${toValue || ''}" onchange="${onToChange}" class="w-full p-2.5 rounded-xl theme-bg-card theme-text-heading shadow-sm border-none focus:ring-2 focus:ring-teal-500 text-sm">
                                </div>
                            </div>
                            ${(fromValue || toValue) ? `<button onclick="${onClearRange}" class="w-full py-2 rounded-xl text-xs font-bold bg-slate-100 dark:bg-slate-800 theme-text-heading">${utils.t('cancel')}</button>` : ''}
                        ` : ''}

                        ${chips && chips.length ? `
                            <div class="flex gap-2 overflow-x-auto no-scrollbar pb-1">
                                ${chips.map(c => `
                                    <button onclick="${c.onClick}" class="shrink-0 px-3 py-1.5 rounded-full text-xs font-bold border ${c.active ? 'bg-teal-50 text-teal-700 border-teal-200 dark:bg-teal-900/20' : 'bg-slate-50 dark:bg-slate-800 theme-border theme-text-sub'}">${c.label}</button>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                `;
            },
            
            renderFilterHeader(page, filter, isColorBg = false) {
                const isYear = filter.mode === 'year';
                const isMonth = filter.mode === 'month';
                const availableYears = utils.getAvailableYears();
                
                const inputClass = isColorBg 
                    ? 'bg-white/20 backdrop-blur-md text-white placeholder-white/70' 
                    : 'bg-slate-100 dark:bg-slate-800 text-slate-700 dark:text-slate-200 border theme-border';
                
                const containerClass = isColorBg 
                    ? 'bg-black/10 backdrop-blur-md' 
                    : 'bg-slate-100 dark:bg-slate-800 border theme-border';

                const activeBtnClass = isColorBg
                    ? 'bg-white text-teal-700 shadow-sm'
                    : 'bg-white dark:bg-slate-600 text-teal-600 shadow-sm border theme-border';
                
                const inactiveBtnClass = isColorBg
                    ? 'text-white/80 hover:bg-white/10'
                    : 'text-slate-500 dark:text-slate-400 hover:bg-slate-200 dark:hover:bg-slate-700';

                return `
                    <div class="flex items-center justify-end gap-2 mb-4 w-full">
                        <div class="flex-1 flex items-center gap-2">
                             ${isMonth ? `<input type="month" value="${filter.value}" onchange="ui.setFilter('${page}', 'month', this.value)" class="text-sm p-1 rounded font-medium outline-none ${inputClass}">` : ''}
                             ${isYear ? `
                                <select onchange="ui.setFilter('${page}', 'year', this.value)" class="text-sm p-1 rounded font-medium outline-none appearance-none pl-2 pr-6 relative ${inputClass}">
                                    ${availableYears.map(y => `<option value="${y}" ${y == filter.value ? 'selected' : ''} class="text-black">${y}</option>`).join('')}
                                </select>
                            ` : ''}
                        </div>
                        
                        <div class="flex rounded-lg p-1 shrink-0 ${containerClass}">
                            <button onclick="ui.setFilter('${page}', 'month')" class="px-3 py-1 rounded-md text-xs font-medium transition-all ${filter.mode === 'month' ? activeBtnClass : inactiveBtnClass}">${utils.t('range_month')}</button>
                            <button onclick="ui.setFilter('${page}', 'year')" class="px-3 py-1 rounded-md text-xs font-medium transition-all ${filter.mode === 'year' ? activeBtnClass : inactiveBtnClass}">${utils.t('range_year')}</button>
                            <button onclick="ui.setFilter('${page}', 'all')" class="px-3 py-1 rounded-md text-xs font-medium transition-all ${filter.mode === 'all' ? activeBtnClass : inactiveBtnClass}">${utils.t('range_all')}</button>
                        </div>
                    </div>
                `;
            },

            setFilter(page, mode, value) {
                if (mode === 'month' && !value) value = new Date().toISOString().slice(0, 7);
                if (mode === 'year' && !value) value = new Date().getFullYear().toString();
                store.pageFilters[page] = { mode, value };
                this.resetPageLimit(page);
                this.render();
            },

            renderDashboard(vehicle) {
                const logs = store.getVehicleLogs();
                const filter = store.pageFilters.dashboard;
                const filteredLogs = utils.filterLogs(logs, filter);
                const stats = utils.calculateStats(filteredLogs, 'all');
                const tireStatuses = utils.getTireReplacementStatus(vehicle);
                const hasUnsetTires = tireStatuses.some(s => s.isNotSet);
                const reminderData = this.getReminderData(vehicle);
                const activeReminders = reminderData.activeItems;
                const doneReminders = reminderData.doneItems;
                const reminderSummary = { tire: 0, service: 0, docs: 0, backup: 0 };
                activeReminders.forEach(it => {
                    if (it.id.startsWith('tire:')) reminderSummary.tire += 1;
                    else if (it.id.startsWith('svc:')) reminderSummary.service += 1;
                    else if (it.id.startsWith('doc:')) reminderSummary.docs += 1;
                    else if (it.id.startsWith('backup:')) reminderSummary.backup += 1;
                });

                const getReminderTone = (it) => {
                    if (it.id.startsWith('backup:')) return 'blue';
                    const meta = (it.meta || '').toLowerCase();
                    const overdue = utils.t('overdue').toLowerCase();
                    const expired = utils.t('expired').toLowerCase();
                    if (meta.includes(overdue) || meta.includes(expired)) return 'red';
                    return 'amber';
                };

                const topReminders = activeReminders.slice(0, 3);
                const remindersHtml = `
                    <div class="px-6 mb-6">
                        <div class="theme-bg-card p-5 rounded-3xl card-shadow border theme-border">
                            <div class="flex items-start justify-between gap-3 mb-4">
                                <div>
                                    <div class="text-[11px] theme-text-sub uppercase tracking-wider flex items-center gap-1">
                                        <span class="material-icons text-sm">notifications</span> ${utils.t('reminder_center')}
                                    </div>
                                    <div class="text-xl font-black theme-text-heading">${utils.t('reminders')}</div>
                                    <div class="text-xs theme-text-sub mt-1">${utils.t('reminder_due_count').replace('{n}', activeReminders.length)}</div>
                                </div>
                                <button onclick="router.navigate('reminders')" class="inline-flex items-center gap-2 text-[10px] font-bold text-teal-700 bg-teal-100 dark:bg-teal-900/30 px-3 py-2 rounded-xl border border-teal-200 dark:border-teal-800">${utils.t('view_all')} <span class="material-icons text-[14px]">arrow_forward</span></button>
                            </div>

                            <div class="text-[10px] theme-text-sub uppercase tracking-wider mb-2">${utils.t('reminder_summary')}</div>
                            <div class="grid grid-cols-4 gap-2 mb-4">
                                ${[
                                    { key: 'tire', label: utils.t('reminder_tires'), icon: 'tire_repair', count: reminderSummary.tire },
                                    { key: 'service', label: utils.t('reminder_service'), icon: 'build', count: reminderSummary.service },
                                    { key: 'docs', label: utils.t('reminder_docs'), icon: 'assignment', count: reminderSummary.docs },
                                    { key: 'backup', label: utils.t('reminder_backup'), icon: 'cloud_upload', count: reminderSummary.backup }
                                ].map(s => `
                                    <div class="bg-slate-50 dark:bg-slate-800/60 rounded-xl p-2 border theme-border flex flex-col items-start">
                                        <div class="flex items-center gap-1 text-[10px] theme-text-sub">
                                            <span class="material-icons text-[14px]">${s.icon}</span>${s.label}
                                        </div>
                                        <div class="text-sm font-black theme-text-heading">${s.count}</div>
                                    </div>
                                `).join('')}
                            </div>

                            <div class="space-y-2 mb-4">
                                ${topReminders.length ? topReminders.map(it => {
                                    const tone = getReminderTone(it);
                                    return `
                                        <div class="p-3 rounded-2xl border theme-border bg-${tone}-50 dark:bg-${tone}-900/20">
                                            <div class="flex items-start justify-between gap-3">
                                                <div class="flex items-start gap-3">
                                                    <div class="w-9 h-9 rounded-xl bg-${tone}-100 text-${tone}-600 flex items-center justify-center">
                                                        <span class="material-icons text-base">${it.icon}</span>
                                                    </div>
                                                    <div>
                                                        <div class="font-bold theme-text-heading text-sm">${it.title}</div>
                                                        <div class="text-[10px] theme-text-sub mt-0.5">${it.meta || '&nbsp;'}</div>
                                                    </div>
                                                </div>
                                                ${it.editAction ? `<button onclick="${it.editAction}" class="text-[10px] font-bold text-${tone}-600">${utils.t('reminder_open')}</button>` : ''}
                                            </div>
                                            <div class="flex gap-2 mt-3">
                                                <button onclick="ui.snoozeReminder('${it.id}', 7)" class="flex-1 py-2 rounded-xl text-[10px] font-bold bg-white/70 dark:bg-slate-800 theme-text-heading border theme-border">${utils.t('snooze_7d')}</button>
                                                <button onclick="ui.markReminderDone('${it.id}')" class="flex-1 py-2 rounded-xl text-[10px] font-bold bg-teal-600 text-white">${utils.t('mark_done')}</button>
                                            </div>
                                        </div>
                                    `;
                                }).join('') : `
                                    <div class="text-center text-xs theme-text-sub py-6">${utils.t('reminder_none')}</div>
                                `}
                            </div>

                            <div class="flex items-center justify-between gap-3">
                                <div class="text-[10px] theme-text-sub uppercase tracking-wider">${utils.t('reminder_quick_actions')}</div>
                                <div class="flex gap-2">
                                    <button onclick="ui.snoozeAllReminders(7)" class="text-[10px] font-bold px-3 py-2 rounded-xl bg-slate-100 dark:bg-slate-800 theme-text-heading border theme-border ${activeReminders.length ? '' : 'opacity-40 pointer-events-none'}">${utils.t('snooze_all_7d')}</button>
                                    <button onclick="ui.clearDoneReminders()" class="text-[10px] font-bold px-3 py-2 rounded-xl bg-slate-100 dark:bg-slate-800 theme-text-heading border theme-border ${doneReminders.length ? '' : 'opacity-40 pointer-events-none'}">${utils.t('clear_done')}</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                const bgClass = utils.getCarColorClass(vehicle.color || 'teal');
                return `
                    <div class="relative pb-20">
                        <div class="${bgClass} pt-safe pb-20 rounded-b-[2.5rem] shadow-xl px-6 relative overflow-hidden transition-all duration-500 z-10">
                             <div class="absolute top-0 right-0 w-64 h-64 bg-white opacity-5 rounded-full -translate-y-1/2 translate-x-1/2 blur-3xl"></div>
                             
                             <div class="relative z-10">
                                <div class="flex justify-between items-start mb-6">
                                    <div>
                                        <div class="opacity-80 text-xs font-bold tracking-wider mb-1 uppercase">${vehicle.year} ${vehicle.make}</div>
                                        <div onclick="ui.openVehicleSelector()" class="text-3xl font-black flex items-center gap-2 cursor-pointer active:opacity-70">
                                            ${vehicle.model} 
                                            <span class="material-icons text-2xl opacity-70">expand_more</span>
                                        </div>
                                    </div>
                                    <div class="flex gap-2">
                                        <button onclick="router.navigate('reminders')" class="w-10 h-10 rounded-full bg-white/20 backdrop-blur-md flex items-center justify-center hover:bg-white/30 transition text-white">
                                            <span class="material-icons text-lg">notifications</span>
                                        </button>
                                        <button onclick="ui.openCalendarSelector()" class="w-10 h-10 rounded-full bg-white/20 backdrop-blur-md flex items-center justify-center hover:bg-white/30 transition text-white">
                                            <span class="material-icons text-lg">event</span>
                                        </button>
                                        <button onclick="ui.openAddVehicle('${vehicle.id}')" class="w-10 h-10 rounded-full bg-white/20 backdrop-blur-md flex items-center justify-center hover:bg-white/30 transition text-white">
                                            <span class="material-icons text-lg">edit</span>
                                        </button>
                                    </div>
                                </div>
                                ${this.renderFilterHeader('dashboard', filter, true)}
                             </div>
                        </div>

                        <div class="px-6 mt-2 relative z-20">
                            <div class="grid grid-cols-2 gap-3 mb-6">
                                <div class="theme-bg-card p-4 rounded-2xl card-shadow">
                                    <div class="theme-text-sub text-[10px] font-bold uppercase tracking-wider mb-1">${utils.t('efficiency')}</div>
                                    <div class="text-2xl font-black text-teal-600">${stats.efficiency}</div>
                                    <div class="text-[10px] theme-text-sub">${utils.getEfficiencyLabel()}</div>
                                </div>
                                <div class="theme-bg-card p-4 rounded-2xl card-shadow">
                                    <div class="theme-text-sub text-[10px] font-bold uppercase tracking-wider mb-1">${utils.getCostPerDistLabel()}</div>
                                    <div class="text-2xl font-black text-blue-600">${stats.costKm}</div>
                                    <div class="text-[10px] theme-text-sub">&nbsp;</div>
                                </div>
                                <div class="theme-bg-card p-4 rounded-2xl card-shadow">
                                    <div class="theme-text-sub text-[10px] font-bold uppercase tracking-wider mb-1">${utils.t('total_cost')}</div>
                                    <div class="text-xl font-black theme-text-heading">${utils.formatCurrency(stats.totalCost)}</div>
                                </div>
                                <div class="theme-bg-card p-4 rounded-2xl card-shadow">
                                    <div class="theme-text-sub text-[10px] font-bold uppercase tracking-wider mb-1">${utils.t('total_dist')}</div>
                                    <div class="text-xl font-black theme-text-heading">${(filter.mode !== 'all' && stats.totalDistCount < 2) ? '--' : (Number.isFinite(stats.totalDist) ? stats.totalDist.toLocaleString() : '--')}</div>
                                    <div class="text-[10px] theme-text-sub">${utils.getDistUnit()}</div>
                                </div>
                            </div>

                            <div class="flex gap-3 mb-6">
                                <button onclick="ui.openAddFuel()" class="flex-1 grad-teal text-white py-4 rounded-2xl shadow-lg shadow-teal-500/20 active:scale-95 transition-transform flex flex-col items-center justify-center gap-1">
                                    <span class="material-icons text-2xl">local_gas_station</span>
                                    <span class="font-bold text-sm">${utils.t('add_fuel')}</span>
                                </button>
                                <button onclick="ui.openAddService()" class="flex-1 bg-white dark:bg-slate-800 theme-text-heading py-4 rounded-2xl shadow-lg active:scale-95 transition-transform flex flex-col items-center justify-center gap-1 border theme-border">
                                    <span class="material-icons text-2xl text-slate-400">build</span>
                                    <span class="font-bold text-sm">${utils.t('add_service')}</span>
                                </button>
                            </div>

                            <div class="theme-bg-card p-4 rounded-2xl card-shadow mb-6">
                                <div class="flex items-center justify-between">
                                    <div class="font-bold theme-text-heading flex items-center gap-2">
                                        <span class="material-icons text-slate-400 text-base">tire_repair</span>
                                        ${utils.t('next_tire_change')}
                                    </div>
                                    ${hasUnsetTires
                                        ? `<button onclick="ui.openQuickTireSetup()" class="text-xs font-bold text-teal-600 bg-teal-50 dark:bg-teal-900/20 px-2 py-1 rounded-lg">${utils.t('quick_tire_setup')}</button>`
                                        : `<button onclick="ui.openAddService(null,'tire_replace')" class="text-xs font-bold text-teal-600 bg-teal-50 dark:bg-teal-900/20 px-2 py-1 rounded-lg">+ ${utils.t('tire_replace')}</button>`
                                    }
                                </div>
                                <div class="grid grid-cols-2 gap-3 mt-3">
                                    ${tireStatuses.map(s => `
                                        <button onclick="${s.isNotSet ? `ui.openQuickTireSetup('${s.pos}')` : (s.editLogId ? `ui.openAddService('${s.editLogId}')` : `ui.openAddService(null,'tire_replace'); setTimeout(() => { const el=document.getElementById('l_tire_pos'); if (el) el.value='${s.pos}'; }, 60);`)}" class="text-left p-3 rounded-xl border theme-border bg-slate-50 dark:bg-slate-800/40 hover:bg-slate-100 dark:hover:bg-slate-800/60 transition">
                                            <div class="text-xs theme-text-sub font-bold">${utils.t('tire_' + s.pos)}</div>
                                            <div class="text-sm font-black ${s.isOverdue ? 'text-red-600' : 'theme-text-heading'}">${s.primary}</div>
                                            <div class="text-[10px] theme-text-sub">${s.secondary || '&nbsp;'}</div>
                                        </button>
                                    `).join('')}
                                </div>
                            </div>
                        </div>

                        <div class="mt-2 relative z-20">
                            ${remindersHtml}
                            
                            <div class="px-6">
                                <div class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3 ml-1">Recent Activity</div>
                                <div class="space-y-3 pb-24">
                                    ${logs.length ? logs.slice(0, 5).map(l => this.renderLogCard(l)).join('') : `<div class="text-center theme-text-sub py-8 italic text-sm">${utils.t('no_records_yet')}</div>`}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            },

            getReminderData(vehicle, options = {}) {
                const includeAll = !!options.includeAll;
                if (!vehicle) {
                    return { items: [], activeItems: [], snoozedItems: [], doneItems: [], snoozedUntil: {}, done: {} };
                }
                const now = new Date();
                const center = store.data.settings.reminderCenter || { snoozedUntil: {}, done: {} };
                const snoozedUntil = center.snoozedUntil || {};
                const done = center.done || {};

                const items = [];

                // Tires
                const tireThresholdKm = (() => {
                    const dist = parseInt(vehicle?.tireReplaceDist ?? store.data.settings.tireReplaceDist) || 0;
                    if (dist <= 0) return 2000;
                    return Math.max(500, Math.min(5000, Math.round(dist * 0.1)));
                })();
                const tireThresholdDays = 60;
                let hasTireReminder = false;
                const tireStatuses = utils.getTireReplacementStatus(vehicle);
                for (const s of tireStatuses) {
                    const near =
                        s.isOverdue ||
                        (s.remainingKm !== null && s.remainingKm <= tireThresholdKm) ||
                        (s.remainingDays !== null && s.remainingDays <= tireThresholdDays);
                    if (!includeAll && !near) continue;
                    hasTireReminder = true;
                    const id = `tire:${vehicle.id}:${s.pos}:${s.editLogId || 'none'}`;
                    items.push({
                        id,
                        icon: 'tire_repair',
                        title: `${utils.t('next_tire_change')} • ${utils.t('tire_' + s.pos)}`,
                        meta: [s.primary, s.secondary].filter(Boolean).join(' • '),
                        dueDateIso: s.dueDateIso,
                        calendarTitle: `${utils.t('next_tire_change')} • ${utils.t('tire_' + s.pos)}: ${vehicle.make} ${vehicle.model}`,
                        editAction: s.editLogId
                            ? `ui.openAddService('${s.editLogId}')`
                            : `ui.openAddService(null,'tire_replace'); setTimeout(() => { const el=document.getElementById('l_tire_pos'); if (el) el.value='${s.pos}'; }, 60);`
                    });
                }
                if (!hasTireReminder) {
                    const byDays = tireStatuses.filter(s => !s.isNotSet && s.remainingDays !== null);
                    const byKm = tireStatuses.filter(s => !s.isNotSet && s.remainingKm !== null);
                    const candidate = byDays.length
                        ? byDays.sort((a, b) => (a.remainingDays || 0) - (b.remainingDays || 0))[0]
                        : (byKm.length ? byKm.sort((a, b) => (a.remainingKm || 0) - (b.remainingKm || 0))[0] : null);
                    const fallbackUnset = tireStatuses.find(s => s.isNotSet);
                    const picked = candidate || fallbackUnset;
                    if (picked) {
                        const id = `tire:${vehicle.id}:next:${picked.pos || 'unset'}`;
                        items.push({
                            id,
                            icon: 'tire_repair',
                            title: picked.pos ? `${utils.t('next_tire_change')} • ${utils.t('tire_' + picked.pos)}` : utils.t('next_tire_change'),
                            meta: [picked.primary, picked.secondary].filter(Boolean).join(' • '),
                            dueDateIso: picked.dueDateIso,
                            editAction: picked.isNotSet
                                ? `ui.openQuickTireSetup('${picked.pos || 'front_left'}')`
                                : (picked.editLogId
                                    ? `ui.openAddService('${picked.editLogId}')`
                                    : `ui.openAddService(null,'tire_replace'); setTimeout(() => { const el=document.getElementById('l_tire_pos'); if (el) el.value='${picked.pos || 'front_left'}'; }, 60);`)
                        });
                    }
                }

                // Document expiry
                ['license', 'insurance', 'registration'].forEach(type => {
                    const setting = store.data.settings.reminders?.[type];
                    if (setting && !setting.enabled) return;
                    const latest = store.getVehicleLogs(type)[0];
                    if (!latest || !latest.expiryDate) return;
                    const days = Math.ceil((new Date(latest.expiryDate) - now) / 86400000);
                    if (!includeAll && days > (setting?.days || 30)) return;
                    const id = `doc:${vehicle.id}:${type}:${latest.expiryDate}`;
                    items.push({
                        id,
                        icon: 'assignment',
                        title: utils.t(type),
                        meta: days <= 0 ? utils.t('overdue') : `${utils.t('due_in')} ${utils.formatDaysShort(days)}`,
                        dueDateIso: new Date(latest.expiryDate).toISOString(),
                        calendarType: type,
                        calendarTitle: `${utils.t(type)}: ${vehicle.make} ${vehicle.model}`,
                        editAction: `ui.openAddService('${latest.id}')`,
                        calendarAction: `utils.exportCalendar('${type}', 0)`
                    });
                });

                // Periodic maintenance
                const distInt = parseInt(vehicle?.maintenanceDist ?? store.data.settings.maintenanceDist) || 0;
                const timeInt = parseInt(vehicle?.maintenanceTime ?? store.data.settings.maintenanceTime) || 0;
                const lastService = store.getVehicleLogs('periodic_maintenance')[0];
                const lastOdo = lastService ? parseFloat(lastService.odometer) || 0 : 0;
                const lastDate = lastService ? new Date(lastService.date) : null;
                if (distInt > 0) {
                    const nextOdo = lastOdo + distInt;
                    const remaining = nextOdo - (parseFloat(vehicle.currentOdometer) || 0);
                    if (includeAll || remaining <= 500) {
                        const id = `svc:${vehicle.id}:dist:${nextOdo}`;
                        items.push({
                            id,
                            icon: 'build',
                            title: utils.t('due_service'),
                            meta: remaining <= 0 ? utils.t('overdue') : `${utils.t('due_in')} ${Math.max(0, Math.round(remaining)).toLocaleString()} ${utils.getDistUnit()}`,
                            dueDateIso: null,
                            editAction: `ui.openAddService(null,'periodic_maintenance')`
                        });
                    }
                }
                if (timeInt > 0 && lastDate) {
                    const nextDate = new Date(lastDate);
                    nextDate.setMonth(nextDate.getMonth() + timeInt);
                    const remainingDays = Math.ceil((nextDate - now) / 86400000);
                    if (includeAll || remainingDays <= 30) {
                        const id = `svc:${vehicle.id}:time:${nextDate.toISOString().slice(0,10)}`;
                        items.push({
                            id,
                            icon: 'build',
                            title: utils.t('due_service'),
                            meta: remainingDays <= 0 ? utils.t('overdue') : `${utils.t('due_in')} ${utils.formatDaysShort(remainingDays)}`,
                            dueDateIso: nextDate.toISOString(),
                            calendarTitle: `${utils.t('due_service')}: ${vehicle.make} ${vehicle.model}`,
                            editAction: `ui.openAddService(null,'periodic_maintenance')`,
                            calendarAction: `utils.exportDateCalendar('${utils.t('due_service')}: ${vehicle.make} ${vehicle.model}', '${nextDate.toISOString()}', 0)`
                        });
                    }
                }

                // Backup reminder (existing logic)
                const logs = store.getVehicleLogs();
                let showBackup = false;
                if (!store.data.settings.lastBackupDate) {
                    if (logs.length > 5) showBackup = true;
                } else {
                    const daysSince = (now - new Date(store.data.settings.lastBackupDate)) / 86400000;
                    if (daysSince > 30) showBackup = true;
                }
                if (showBackup) {
                    const id = `backup:${vehicle.id}`;
                    items.push({
                        id,
                        icon: 'cloud_upload',
                        title: utils.t('backup_needed'),
                        meta: utils.t('backup_desc'),
                        dueDateIso: null,
                        editAction: `ui.exportData(); ui.render();`
                    });
                }

                const activeItems = items.filter(it => {
                    if (done[it.id]) return false;
                    const until = snoozedUntil[it.id];
                    if (!until) return true;
                    return new Date(until) <= now;
                });
                const snoozedItems = items.filter(it => {
                    if (done[it.id]) return false;
                    const until = snoozedUntil[it.id];
                    return until && new Date(until) > now;
                });
                const doneItems = items.filter(it => !!done[it.id]);

                return { items, activeItems, snoozedItems, doneItems, snoozedUntil, done };
            },

            renderReminders(vehicle) {
                const { activeItems, snoozedItems, doneItems, snoozedUntil, done } = this.getReminderData(vehicle, { includeAll: true });
                const tab = store.pageFilters.remindersTab || 'active';
                const sortByDue = (list) => list.slice().sort((a, b) => {
                    const aTime = a.dueDateIso ? new Date(a.dueDateIso).getTime() : Number.POSITIVE_INFINITY;
                    const bTime = b.dueDateIso ? new Date(b.dueDateIso).getTime() : Number.POSITIVE_INFINITY;
                    if (aTime !== bTime) return aTime - bTime;
                    return (a.title || '').localeCompare(b.title || '');
                });
                const visible =
                    tab === 'snoozed' ? sortByDue(snoozedItems) :
                    tab === 'done' ? sortByDue(doneItems) :
                    sortByDue(activeItems);

                return `
                    <div class="px-6 pt-safe min-h-screen pb-24">
                        <div class="flex items-center justify-between mb-4">
                            <h1 class="text-3xl font-black theme-text-heading">${utils.t('reminder_center')}</h1>
                            <button onclick="router.navigate('dashboard')" class="text-sm font-bold text-teal-600">${utils.t('dashboard')}</button>
                        </div>

                        <div class="flex bg-slate-100 dark:bg-slate-800 rounded-xl p-1 mb-4">
                            <button onclick="store.pageFilters.remindersTab='active'; ui.render()" class="flex-1 py-2 text-xs font-bold rounded-lg ${tab==='active'?'bg-white dark:bg-slate-700 shadow':''}">${utils.t('tab_active')} (${activeItems.length})</button>
                            <button onclick="store.pageFilters.remindersTab='snoozed'; ui.render()" class="flex-1 py-2 text-xs font-bold rounded-lg ${tab==='snoozed'?'bg-white dark:bg-slate-700 shadow':''}">${utils.t('tab_snoozed')} (${snoozedItems.length})</button>
                            <button onclick="store.pageFilters.remindersTab='done'; ui.render()" class="flex-1 py-2 text-xs font-bold rounded-lg ${tab==='done'?'bg-white dark:bg-slate-700 shadow':''}">${utils.t('tab_done')} (${doneItems.length})</button>
                        </div>

                        <div class="space-y-3">
                            ${visible.length ? visible.map(it => `
                                <div class="theme-bg-card p-4 rounded-2xl card-shadow border theme-border">
                                    <div class="flex items-start justify-between gap-3">
                                        <div class="flex items-start gap-3">
                                            <div class="w-10 h-10 rounded-xl bg-slate-100 dark:bg-slate-800 flex items-center justify-center">
                                                <span class="material-icons text-slate-500">${it.icon}</span>
                                            </div>
                                            <div>
                                                <div class="font-bold theme-text-heading">${it.title}</div>
                                                <div class="text-xs theme-text-sub mt-0.5">${it.meta || '&nbsp;'}</div>
                                                ${snoozedUntil[it.id] && !done[it.id] ? `<div class="text-[10px] text-slate-400 mt-1">Snoozed until ${utils.formatDate(snoozedUntil[it.id])}</div>` : ''}
                                            </div>
                                        </div>
                                        <button onclick="${it.editAction}" class="text-slate-300 hover:text-sky-500"><span class="material-icons">edit</span></button>
                                    </div>
                                    <div class="flex gap-2 mt-3">
                                        ${tab === 'done'
                                            ? `<button onclick="ui.restoreReminder('${it.id}')" class="flex-1 py-2 rounded-xl text-xs font-bold bg-slate-100 dark:bg-slate-800 theme-text-heading">${utils.t('restore')}</button>`
                                            : `
                                                <button onclick="ui.snoozeReminder('${it.id}', 1)" class="py-2 px-3 rounded-xl text-xs font-bold bg-slate-100 dark:bg-slate-800 theme-text-heading">${utils.t('snooze_1d')}</button>
                                                <button onclick="ui.snoozeReminder('${it.id}', 7)" class="py-2 px-3 rounded-xl text-xs font-bold bg-slate-100 dark:bg-slate-800 theme-text-heading">${utils.t('snooze_7d')}</button>
                                                <button onclick="ui.snoozeReminder('${it.id}', 30)" class="py-2 px-3 rounded-xl text-xs font-bold bg-slate-100 dark:bg-slate-800 theme-text-heading">${utils.t('snooze_30d')}</button>
                                                ${tab === 'snoozed' ? `<button onclick="ui.unsnoozeReminder('${it.id}')" class="flex-1 py-2 rounded-xl text-xs font-bold bg-slate-100 dark:bg-slate-800 theme-text-heading">${utils.t('unsnooze')}</button>` : `<button onclick="ui.markReminderDone('${it.id}')" class="flex-1 py-2 rounded-xl text-xs font-bold bg-teal-600 text-white">${utils.t('mark_done')}</button>`}
                                            `}
                                        ${(it.calendarType || it.dueDateIso)
                                            ? `<button data-action="reminder-calendar" data-title="${encodeURIComponent(it.calendarTitle || it.title || '')}" data-date="${it.dueDateIso || ''}" data-type="${it.calendarType || ''}" class="py-2 px-3 rounded-xl text-xs font-bold bg-blue-50 text-blue-700">${utils.t('export_calendar')}</button>`
                                            : ''
                                        }
                                    </div>
                                </div>
                            `).join('') : `<div class="text-center theme-text-sub py-12">No reminders</div>`}
                        </div>
                    </div>
                `;
            },

            renderFuel(vehicle) {
                const logs = store.getVehicleLogs('fuel');
                const filter = store.pageFilters.fuel;
                const q = (store.pageFilters.fuelSearch || '').toLowerCase();
                const fuelFlags = store.pageFilters.fuelFlags || { full: false, partial: false };
                const from = store.pageFilters.fuelFrom || '';
                const to = store.pageFilters.fuelTo || '';
                const filteredLogs = store._getCachedFiltered(
                    `fuel|${store.data.settings.language || 'en'}|${filter.mode}:${filter.value}|${from}|${to}|${q}|${fuelFlags.full ? 1 : 0}${fuelFlags.partial ? 1 : 0}`,
                    () => {
                        let out = utils.filterLogs(logs, filter);
                        out = utils.filterByDateRange(out, from, to);
                        if (q) out = out.filter(l => store.getLogSearchText(l).includes(q));
                        if (fuelFlags.full && !fuelFlags.partial) out = out.filter(l => !l.isPartial);
                        if (fuelFlags.partial && !fuelFlags.full) out = out.filter(l => !!l.isPartial);
                        return out;
                    }
                );
                const stats = utils.calculateStats(filteredLogs, 'fuel');
                const limit = ui.getPageLimit('fuel');
                const visibleLogs = filteredLogs.slice(0, limit);
                
                return `
                    <div class="px-6 pt-safe min-h-screen">
                        <div class="flex justify-between items-center mb-6">
                             <h1 class="text-3xl font-black theme-text-heading">${utils.t('fuel')}</h1>
                        </div>
                        <div class="mb-4">${this.renderFilterHeader('fuel', filter)}</div>

                        ${ui.renderSearchPanel({
                            searchValue: store.pageFilters.fuelSearch,
                            onSearchInput: "ui.onSearchInput('fuel','fuelSearch',this.value)",
                            onClearSearch: "ui.clearSearch('fuel','fuelSearch')",
                            placeholder: "Search notes/location...",
                            fromValue: store.pageFilters.fuelFrom,
                            toValue: store.pageFilters.fuelTo,
                            onFromChange: "store.pageFilters.fuelFrom=this.value;ui.resetPageLimit('fuel');ui.render()",
                            onToChange: "store.pageFilters.fuelTo=this.value;ui.resetPageLimit('fuel');ui.render()",
                            onClearRange: "store.pageFilters.fuelFrom='';store.pageFilters.fuelTo='';ui.resetPageLimit('fuel');ui.render()",
                            chips: [
                                { label: "Full", active: !!fuelFlags.full, onClick: "store.pageFilters.fuelFlags={...store.pageFilters.fuelFlags, full: !store.pageFilters.fuelFlags.full};ui.resetPageLimit('fuel');ui.render()" },
                                { label: "Partial", active: !!fuelFlags.partial, onClick: "store.pageFilters.fuelFlags={...store.pageFilters.fuelFlags, partial: !store.pageFilters.fuelFlags.partial};ui.resetPageLimit('fuel');ui.render()" }
                            ]
                        })}

                        <div class="grid grid-cols-2 gap-3 mb-6">
                            <div class="theme-bg-card p-3 rounded-xl card-shadow border-l-4 border-teal-500">
                                <div class="text-[10px] theme-text-sub uppercase tracking-wider">${utils.t('efficiency')}</div>
                                <div class="text-lg font-bold text-teal-600">${stats.efficiency} <span class="text-[10px] font-normal">${utils.getEfficiencyLabel()}</span></div>
                            </div>
                            <div class="theme-bg-card p-3 rounded-xl card-shadow border-l-4 border-blue-500">
                                <div class="text-[10px] theme-text-sub uppercase tracking-wider">${utils.getCostPerDistLabel()}</div>
                                <div class="text-lg font-bold text-blue-600">${stats.costKm}</div>
                            </div>
                             <div class="theme-bg-card p-3 rounded-xl card-shadow">
                                <div class="text-[10px] theme-text-sub uppercase tracking-wider">${utils.t('total_cost')}</div>
                                <div class="text-lg font-bold theme-text-heading">${utils.formatCurrency(stats.totalCost)}</div>
                            </div>
                             <div class="theme-bg-card p-3 rounded-xl card-shadow">
                                <div class="text-[10px] theme-text-sub uppercase tracking-wider">${utils.t('total_dist')}</div>
                                <div class="text-lg font-bold theme-text-heading">${(filter.mode !== 'all' && stats.totalDistCount < 2) ? '--' : (Number.isFinite(stats.totalDist) ? stats.totalDist : '--')} <span class="text-[10px] font-normal">${utils.getDistUnit()}</span></div>
                            </div>
                        </div>

                        <div class="space-y-3 pb-24">
                            ${visibleLogs.length ? visibleLogs.map(l => this.renderLogCard(l)).join('') : `<div class="text-center theme-text-sub py-12">No records found</div>`}
                            ${filteredLogs.length > visibleLogs.length ? ui.renderLoadMore('fuel', visibleLogs.length, filteredLogs.length) : ''}
                        </div>
                        <button onclick="ui.openAddFuel()" class="fixed bottom-[calc(130px+var(--safe-bottom))] right-6 w-14 h-14 rounded-full grad-teal text-white shadow-xl flex items-center justify-center active:scale-90 transition-transform z-50">
                            <span class="material-icons">add</span>
                        </button>
                    </div>
                `;
            },
            
            renderMaintenance(vehicle) {
                const filter = store.pageFilters.maintenance;
                const view = store.pageFilters.maintenanceView || 'all';
                const selectedTypes = store.pageFilters.maintenanceTypes || [];
                
                const query = (store.pageFilters.maintenanceSearch || '').toLowerCase();
                const from = store.pageFilters.maintenanceFrom || '';
                const to = store.pageFilters.maintenanceTo || '';
                const typeKey = (selectedTypes || []).slice().sort().join(',');
                const filteredLogs = store._getCachedFiltered(
                    `maintenance|${store.data.settings.language || 'en'}|${filter.mode}:${filter.value}|${from}|${to}|${typeKey}|${query}`,
                    () => {
                        const logs = store.getVehicleLogs();
                        let out = logs.filter(l => l.type !== 'fuel' && l.type !== 'parking');
                        out = utils.filterLogs(out, filter);
                        out = utils.filterByDateRange(out, from, to);
                        if (selectedTypes.length) out = out.filter(l => selectedTypes.includes(l.type));
                        if (query) {
                            out = out.filter(l => {
                                if (store.getLogSearchText(l).includes(query)) return true;
                                if ((l.tireBrand || '').toLowerCase().includes(query)) return true;
                                return utils.t(l.type).toLowerCase().includes(query);
                            });
                        }
                        return out;
                    }
                );
                const limit = ui.getPageLimit('maintenance');
                const visibleLogs = view === 'all' ? filteredLogs.slice(0, limit) : filteredLogs;
                const stats = utils.calculateStats(filteredLogs, 'maintenance');
                const tireTimeline = utils.getTireTimeline(vehicle);
                const tireTimelineFiltered = query
                    ? tireTimeline.filter(t => (t.lastReplace?.brand || '').toLowerCase().includes(query) || (t.currentPos && utils.t('tire_' + t.currentPos).toLowerCase().includes(query)))
                    : tireTimeline;
                const tireStatuses = utils.getTireReplacementStatus(vehicle);
                const hasUnsetTires = tireStatuses.some(s => s.isNotSet);

                return `
                    <div class="px-6 pt-safe min-h-screen">
                        <div class="flex justify-between items-center mb-2">
                             <h1 class="text-3xl font-black theme-text-heading">${utils.t('maintenance')}</h1>
                        </div>
                        <div class="mb-4">${this.renderFilterHeader('maintenance', filter)}</div>
                        
                        ${ui.renderSearchPanel({
                            searchValue: store.pageFilters.maintenanceSearch,
                            onSearchInput: "ui.onSearchInput('maintenance','maintenanceSearch',this.value)",
                            onClearSearch: "ui.clearSearch('maintenance','maintenanceSearch')",
                            placeholder: "Search notes/location/brand...",
                            fromValue: store.pageFilters.maintenanceFrom,
                            toValue: store.pageFilters.maintenanceTo,
                            onFromChange: "store.pageFilters.maintenanceFrom=this.value;ui.resetPageLimit('maintenance');ui.render()",
                            onToChange: "store.pageFilters.maintenanceTo=this.value;ui.resetPageLimit('maintenance');ui.render()",
                            onClearRange: "store.pageFilters.maintenanceFrom='';store.pageFilters.maintenanceTo='';ui.resetPageLimit('maintenance');ui.render()"
                        })}

                        <div class="flex bg-slate-100 dark:bg-slate-800 rounded-xl p-1 mb-3">
                            <button onclick="store.pageFilters.maintenanceView='all'; store.pageFilters.maintenanceTypes=[]; ui.resetPageLimit('maintenance'); ui.render()" class="flex-1 py-2 text-xs font-bold rounded-lg ${view==='all'?'bg-white dark:bg-slate-700 shadow':''}">${utils.t('all')}</button>
                            <button onclick="store.pageFilters.maintenanceView='tires'; ui.resetPageLimit('maintenance'); ui.render()" class="flex-1 py-2 text-xs font-bold rounded-lg ${view==='tires'?'bg-white dark:bg-slate-700 shadow':''}">${utils.t('tire_replace')}</button>
                        </div>

                        ${view === 'all' ? `
                            <div class="flex gap-2 overflow-x-auto no-scrollbar pb-2 mb-4">
                                <button onclick="store.pageFilters.maintenanceTypes=[]; ui.resetPageLimit('maintenance'); ui.render()" class="shrink-0 px-3 py-1.5 rounded-full text-xs font-bold border ${selectedTypes.length ? 'bg-slate-50 dark:bg-slate-800 theme-border theme-text-sub' : 'bg-teal-600 text-white border-teal-600'}">${utils.t('all')}</button>
                                ${['service','repair','tire_replace','tire_rotation','periodic_maintenance','car_wash','car_accessories','fine','license','insurance','registration'].map(t => {
                                    const active = selectedTypes.includes(t);
                                    return `<button onclick="const s=store.pageFilters.maintenanceTypes||[]; store.pageFilters.maintenanceTypes = s.includes('${t}') ? s.filter(x=>x!=='${t}') : [...s,'${t}']; ui.resetPageLimit('maintenance'); ui.render()" class="shrink-0 px-3 py-1.5 rounded-full text-xs font-bold border ${active ? 'bg-teal-50 text-teal-700 border-teal-200 dark:bg-teal-900/20' : 'bg-slate-50 dark:bg-slate-800 theme-border theme-text-sub'}">${utils.t(t)}</button>`;
                                }).join('')}
                            </div>
                        ` : ''}

                        <div class="theme-bg-card p-4 rounded-2xl card-shadow mb-6 flex justify-between items-center">
                            <div>
                                <div class="text-xs theme-text-sub uppercase tracking-wider">${utils.t('maintenance_cost')}</div>
                                <div class="text-2xl font-black theme-text-heading">${utils.formatCurrency(stats.totalCost)}</div>
                            </div>
                            <div class="w-10 h-10 rounded-full bg-slate-100 dark:bg-slate-800 flex items-center justify-center">
                                <span class="material-icons text-slate-500">build</span>
                            </div>
                        </div>

                        ${view === 'tires' ? `
                            <div class="theme-bg-card p-4 rounded-2xl card-shadow mb-6">
                                <div class="flex items-center justify-between gap-2">
                                    <div class="text-xs theme-text-sub">${utils.t('quick_tire_setup_desc')}</div>
                                    <div class="flex gap-2">
                                        <button onclick="ui.openQuickTireSetup()" class="text-xs font-bold text-teal-600 bg-teal-50 dark:bg-teal-900/20 px-2 py-1 rounded-lg">${utils.t('quick_tire_setup')}</button>
                                        <button onclick="ui.openQuickTireSetup(null,true)" class="text-xs font-bold text-slate-600 bg-slate-100 dark:bg-slate-800/60 px-2 py-1 rounded-lg">${utils.t('quick_tire_setup_all')}</button>
                                    </div>
                                </div>
                            </div>
                        ` : ''}

                        <div class="space-y-3 pb-24">
                            ${view === 'tires'
                                ? (tireTimelineFiltered.length
                                    ? tireTimelineFiltered.map(t => `
                                        <div class="theme-bg-card p-4 rounded-2xl card-shadow">
                                            <div class="flex items-start justify-between gap-3">
                                                <div>
                                                    <div class="text-xs theme-text-sub font-bold">${t.currentPos ? utils.t('tire_' + t.currentPos) : utils.t('tire_positions')}</div>
                                                    <div class="text-lg font-black theme-text-heading">${t.lastReplace?.brand || utils.t('tire_not_set')}</div>
                                                    <div class="text-xs theme-text-sub mt-0.5">${t.lastReplace ? `${utils.formatDate(t.lastReplace.date)} • ${t.lastReplace.odometer} ${utils.getDistUnit()}` : '&nbsp;'}</div>
                                                </div>
                                                <div class="flex gap-2">
                                                    ${t.lastReplace?.logId
                                                        ? `<button type="button" data-action="edit-log" data-log-id="${t.lastReplace.logId}" onclick="event.stopPropagation(); ui.openLogEditorById('${t.lastReplace.logId}')" class="text-slate-300 hover:text-sky-500"><span class="material-icons text-xl">edit</span></button>`
                                                        : `<button onclick="ui.openQuickTireSetup('${t.currentPos || 'front_left'}')" class="text-xs font-bold text-teal-600 bg-teal-50 dark:bg-teal-900/20 px-2 py-1 rounded-lg">${utils.t('quick_tire_setup')}</button>`
                                                    }
                                                </div>
                                            </div>
                                            <div class="mt-3 space-y-2">
                                                ${(t.events || []).slice().sort((a,b) => (parseFloat(b.odometer)||0) - (parseFloat(a.odometer)||0)).slice(0, 8).map(ev => {
                                                    if (ev.kind === 'replace') {
                                                        return `<div class="flex items-center justify-between text-xs bg-slate-50 dark:bg-slate-800/50 p-2 rounded-lg">
                                                            <div class="flex items-center gap-2">
                                                                <span class="material-icons text-slate-400 text-sm">tire_repair</span>
                                                                <span class="font-bold theme-text-heading">${utils.t('tire_replace')}</span>
                                                                <span class="theme-text-sub">${utils.t('tire_' + ev.pos)}</span>
                                                            </div>
                                                            <div class="theme-text-sub">${ev.odometer} ${utils.getDistUnit()}</div>
                                                        </div>`;
                                                    }
                                                    return `<div class="flex items-center justify-between text-xs bg-slate-50 dark:bg-slate-800/50 p-2 rounded-lg">
                                                        <div class="flex items-center gap-2">
                                                            <span class="material-icons text-slate-400 text-sm">sync_alt</span>
                                                            <span class="font-bold theme-text-heading">${utils.t('tire_rotation')}</span>
                                                            <span class="theme-text-sub">${utils.t('tire_' + ev.from)} → ${utils.t('tire_' + ev.to)}</span>
                                                        </div>
                                                        <div class="theme-text-sub">${ev.odometer} ${utils.getDistUnit()}</div>
                                                    </div>`;
                                                }).join('') || `<div class="text-center theme-text-sub text-sm py-3">${utils.t('no_tire_events')}</div>`}
                                            </div>
                                        </div>
                                    `).join('')
                                    : `<div class="text-center theme-text-sub py-12">${utils.t('no_tire_records_found')}</div>`)
                                : (visibleLogs.length ? visibleLogs.map(l => this.renderLogCard(l)).join('') : `<div class="text-center theme-text-sub py-12">${utils.t('no_records_found')}</div>`)}
                            ${view === 'all' && filteredLogs.length > visibleLogs.length ? ui.renderLoadMore('maintenance', visibleLogs.length, filteredLogs.length) : ''}
                        </div>
                        <button onclick="ui.openAddService()" class="fixed bottom-[calc(130px+var(--safe-bottom))] right-6 w-14 h-14 rounded-full bg-white dark:bg-slate-700 theme-text-heading shadow-xl flex items-center justify-center active:scale-90 transition-transform z-50 border theme-border">
                            <span class="material-icons">add</span>
                        </button>
                    </div>
                `;
            },
            
            renderParking(vehicle) {
                const logs = store.getVehicleLogs('parking');
                const filter = store.pageFilters.parking;
                const q = (store.pageFilters.parkingSearch || '').toLowerCase();
                const parkingFlags = store.pageFilters.parkingFlags || { withLocation: false, withNotes: false };
                const from = store.pageFilters.parkingFrom || '';
                const to = store.pageFilters.parkingTo || '';
                const filteredLogs = store._getCachedFiltered(
                    `parking|${store.data.settings.language || 'en'}|${filter.mode}:${filter.value}|${from}|${to}|${q}|${parkingFlags.withLocation ? 1 : 0}${parkingFlags.withNotes ? 1 : 0}`,
                    () => {
                        let out = utils.filterLogs(logs, filter);
                        out = utils.filterByDateRange(out, from, to);
                        if (q) out = out.filter(l => store.getLogSearchText(l).includes(q));
                        if (parkingFlags.withLocation) out = out.filter(l => !!l.location);
                        if (parkingFlags.withNotes) out = out.filter(l => !!l.notes);
                        return out;
                    }
                );
                const stats = utils.calculateStats(filteredLogs, 'parking');
                const limit = ui.getPageLimit('parking');
                const visibleLogs = filteredLogs.slice(0, limit);
                
                return `
                     <div class="px-6 pt-safe min-h-screen">
                        <div class="flex justify-between items-center mb-6">
                             <h1 class="text-3xl font-black theme-text-heading">${utils.t('parking')}</h1>
                        </div>
                        <div class="mb-4">${this.renderFilterHeader('parking', filter)}</div>

                        ${ui.renderSearchPanel({
                            searchValue: store.pageFilters.parkingSearch,
                            onSearchInput: "ui.onSearchInput('parking','parkingSearch',this.value)",
                            onClearSearch: "ui.clearSearch('parking','parkingSearch')",
                            placeholder: "Search notes/location...",
                            fromValue: store.pageFilters.parkingFrom,
                            toValue: store.pageFilters.parkingTo,
                            onFromChange: "store.pageFilters.parkingFrom=this.value;ui.resetPageLimit('parking');ui.render()",
                            onToChange: "store.pageFilters.parkingTo=this.value;ui.resetPageLimit('parking');ui.render()",
                            onClearRange: "store.pageFilters.parkingFrom='';store.pageFilters.parkingTo='';ui.resetPageLimit('parking');ui.render()",
                            chips: [
                                { label: "Has Location", active: !!parkingFlags.withLocation, onClick: "store.pageFilters.parkingFlags={...store.pageFilters.parkingFlags, withLocation: !store.pageFilters.parkingFlags.withLocation};ui.resetPageLimit('parking');ui.render()" },
                                { label: "Has Notes", active: !!parkingFlags.withNotes, onClick: "store.pageFilters.parkingFlags={...store.pageFilters.parkingFlags, withNotes: !store.pageFilters.parkingFlags.withNotes};ui.resetPageLimit('parking');ui.render()" }
                            ]
                        })}
                        
                        <div class="theme-bg-card p-4 rounded-2xl card-shadow mb-6">
                             <div class="text-xs theme-text-sub uppercase tracking-wider">${utils.t('parking_fee')}</div>
                             <div class="text-3xl font-black theme-text-heading">${utils.formatCurrency(stats.totalCost)}</div>
                        </div>
                        
                        <div class="space-y-3 pb-24">
                            ${visibleLogs.length ? visibleLogs.map(l => this.renderLogCard(l)).join('') : `<div class="text-center theme-text-sub py-12">${utils.t('no_records_yet')}</div>`}
                            ${filteredLogs.length > visibleLogs.length ? ui.renderLoadMore('parking', visibleLogs.length, filteredLogs.length) : ''}
                        </div>
                        <button onclick="ui.openAddParking()" class="fixed bottom-[calc(130px+var(--safe-bottom))] right-6 w-14 h-14 rounded-full bg-blue-600 text-white shadow-xl flex items-center justify-center active:scale-90 transition-transform z-50">
                            <span class="material-icons">add</span>
                        </button>
                     </div>
                `;
            },
            
            renderAnalytics(vehicle) {
                const logs = store.getVehicleLogs();
                const filter = store.pageFilters.analytics;
                const q = (store.pageFilters.analyticsSearch || '').toLowerCase();
                const from = store.pageFilters.analyticsFrom || '';
                const to = store.pageFilters.analyticsTo || '';
                const filteredLogs = store._getCachedFiltered(
                    `analytics|${store.data.settings.language || 'en'}|${filter.mode}:${filter.value}|${from}|${to}|${q}`,
                    () => {
                        let out = utils.filterLogs(logs, filter);
                        out = utils.filterByDateRange(out, from, to);
                        if (q) out = out.filter(l => store.getLogSearchText(l).includes(q));
                        return out;
                    }
                );
                
                const fuelCost = filteredLogs.filter(l => l.type === 'fuel').reduce((s,l) => s + (Number.isFinite(parseFloat(l.cost)) ? parseFloat(l.cost) : 0), 0);
                const maintenanceCost = filteredLogs.filter(l => !['fuel','parking','fine','license','insurance','registration'].includes(l.type)).reduce((s,l) => s + (Number.isFinite(parseFloat(l.cost)) ? parseFloat(l.cost) : 0), 0);
                const parkingCost = filteredLogs.filter(l => l.type === 'parking').reduce((s,l) => s + (Number.isFinite(parseFloat(l.cost)) ? parseFloat(l.cost) : 0), 0);
                const fineCost = filteredLogs.filter(l => l.type === 'fine').reduce((s,l) => s + (Number.isFinite(parseFloat(l.cost)) ? parseFloat(l.cost) : 0), 0);
                const docsCost = filteredLogs.filter(l => ['license', 'insurance', 'registration'].includes(l.type)).reduce((sum, l) => sum + (Number.isFinite(parseFloat(l.cost)) ? parseFloat(l.cost) : 0), 0);
                const total = fuelCost + maintenanceCost + parkingCost + fineCost + docsCost;
                
                let pieHtml = '';
                if (total > 0) {
                     const r = 50, cx = 60, cy = 60;
                     let startA = 0;
                     const slices = [
                         { val: fuelCost, col: '#0d9488', label: utils.t('fuel'), value: utils.formatCurrency(fuelCost) },
                         { val: maintenanceCost, col: '#a855f7', label: utils.t('maintenance'), value: utils.formatCurrency(maintenanceCost) },
                         { val: parkingCost, col: '#3b82f6', label: utils.t('parking'), value: utils.formatCurrency(parkingCost) },
                         { val: fineCost, col: '#ef4444', label: utils.t('traffic_fine'), value: utils.formatCurrency(fineCost) },
                         { val: docsCost, col: '#f59e0b', label: utils.t('fixed_costs'), value: utils.formatCurrency(docsCost) }
                     ];
                     pieHtml = slices.map((s, idx) => {
                         if (s.val <= 0) return '';
                         const angle = (s.val / total) * 360;
                         const large = angle > 180 ? 1 : 0;
                         const endA = startA + angle;
                         const x1 = cx + r * Math.cos(Math.PI*startA/180);
                         const y1 = cy + r * Math.sin(Math.PI*startA/180);
                         const x2 = cx + r * Math.cos(Math.PI*endA/180);
                         const y2 = cy + r * Math.sin(Math.PI*endA/180);
                         const path = total === s.val ? `M${cx-r},${cy} a${r},${r} 0 1,0 ${r*2},0 a${r},${r} 0 1,0 -${r*2},0` : `M${cx},${cy} L${x1},${y1} A${r},${r} 0 ${large},1 ${x2},${y2} Z`;
                         startA += angle;
                         return `<path d="${path}" fill="${s.col}" data-pie-label="${s.label}" data-pie-value="${s.value}" />`;
                     }).join('');
                     pieHtml = `<svg viewBox="0 0 120 120" class="w-32 h-32 mx-auto drop-shadow-lg">${pieHtml}</svg>`;
                }
                
                return `
                    <div class="px-6 pt-safe min-h-screen">
                        <div class="flex justify-between items-center mb-6">
                             <h1 class="text-3xl font-black theme-text-heading">${utils.t('analytics')}</h1>
                        </div>
                        <div class="mb-4">${this.renderFilterHeader('analytics', filter)}</div>

                        ${ui.renderSearchPanel({
                            searchValue: store.pageFilters.analyticsSearch,
                            onSearchInput: "ui.onSearchInput('analytics','analyticsSearch',this.value)",
                            onClearSearch: "ui.clearSearch('analytics','analyticsSearch')",
                            placeholder: utils.t('search_placeholder'),
                            fromValue: store.pageFilters.analyticsFrom,
                            toValue: store.pageFilters.analyticsTo,
                            onFromChange: "store.pageFilters.analyticsFrom=this.value;ui.render()",
                            onToChange: "store.pageFilters.analyticsTo=this.value;ui.render()",
                            onClearRange: "store.pageFilters.analyticsFrom='';store.pageFilters.analyticsTo='';ui.render()"
                        })}

                        <div class="grid grid-cols-2 gap-4 mb-6">
                            <div class="theme-bg-card p-4 rounded-2xl card-shadow">
                                <div class="text-xs theme-text-sub uppercase mb-2">Total Spend</div>
                                <div class="text-2xl font-black theme-text-heading">${utils.formatCurrency(total)}</div>
                            </div>
                            <div class="theme-bg-card p-4 rounded-2xl card-shadow">
                                <div class="text-xs theme-text-sub uppercase mb-2">${utils.t('fixed_costs')}</div>
                                <div class="text-2xl font-black text-purple-600">${utils.formatCurrency(docsCost)}</div>
                            </div>
                        </div>
                        
                        <div class="theme-bg-card p-4 rounded-2xl card-shadow mb-6">
                            <div class="text-sm font-black theme-text-heading uppercase tracking-wider mb-4">${utils.t('monthly_spend')} (6 Months)</div>
                            <div class="h-56">
                                ${utils.generateMonthlyBarChart(logs)}
                            </div>
                            <div class="flex flex-wrap justify-center gap-3 mt-3 text-[11px] font-semibold theme-text-heading">
                                <div class="flex items-center gap-1" data-series="fuel"><div class="w-2.5 h-2.5 rounded-full bg-teal-500"></div>${utils.t('fuel')}</div>
                                <div class="flex items-center gap-1" data-series="maintenance"><div class="w-2.5 h-2.5 rounded-full bg-purple-400"></div>${utils.t('maintenance')}</div>
                                <div class="flex items-center gap-1" data-series="parking"><div class="w-2.5 h-2.5 rounded-full bg-blue-400"></div>${utils.t('parking')}</div>
                                <div class="flex items-center gap-1" data-series="fine"><div class="w-2.5 h-2.5 rounded-full bg-red-400"></div>${utils.t('traffic_fine')}</div>
                                <div class="flex items-center gap-1" data-series="fixed"><div class="w-2.5 h-2.5 rounded-full bg-amber-400"></div>${utils.t('fixed_costs')}</div>
                            </div>
                        </div>

                            <div class="flex items-center gap-6 mb-8 theme-bg-card p-6 rounded-2xl card-shadow">
                            <div class="flex-1">
                                <div id="pie-breakdown" class="space-y-3">
                                    <div class="flex justify-between text-xs" data-pie-item="${utils.t('fuel')}" data-pie-value="${utils.formatCurrency(fuelCost)}"><span class="flex items-center gap-2"><div class="w-2 h-2 rounded-full bg-teal-600"></div>${utils.t('fuel')}</span> <span class="font-bold">${utils.formatCurrency(fuelCost)}</span></div>
                                    <div class="flex justify-between text-xs" data-pie-item="${utils.t('maintenance')}" data-pie-value="${utils.formatCurrency(maintenanceCost)}"><span class="flex items-center gap-2"><div class="w-2 h-2 rounded-full bg-purple-500"></div>${utils.t('maintenance')}</span> <span class="font-bold">${utils.formatCurrency(maintenanceCost)}</span></div>
                                    <div class="flex justify-between text-xs" data-pie-item="${utils.t('parking')}" data-pie-value="${utils.formatCurrency(parkingCost)}"><span class="flex items-center gap-2"><div class="w-2 h-2 rounded-full bg-blue-500"></div>${utils.t('parking')}</span> <span class="font-bold">${utils.formatCurrency(parkingCost)}</span></div>
                                    <div class="flex justify-between text-xs" data-pie-item="${utils.t('traffic_fine')}" data-pie-value="${utils.formatCurrency(fineCost)}"><span class="flex items-center gap-2"><div class="w-2 h-2 rounded-full bg-red-500"></div>${utils.t('traffic_fine')}</span> <span class="font-bold">${utils.formatCurrency(fineCost)}</span></div>
                                    <div class="flex justify-between text-xs" data-pie-item="${utils.t('fixed_costs')}" data-pie-value="${utils.formatCurrency(docsCost)}"><span class="flex items-center gap-2"><div class="w-2 h-2 rounded-full bg-amber-500"></div>${utils.t('fixed_costs')}</span> <span class="font-bold">${utils.formatCurrency(docsCost)}</span></div>
                                </div>
                            </div>
                            <div>${pieHtml}</div>
                        </div>
                        
                        <div class="theme-bg-card p-6 rounded-2xl card-shadow mb-24">
                            <div class="text-xs font-bold theme-text-sub uppercase mb-4">Fuel Efficiency Trend</div>
                            <div class="h-32">
                                ${utils.generateTrendChart(logs)}
                            </div>
                        </div>
                    </div>
                `;
            },
            
            renderSettings(vehicle) {
                const settings = store.data.settings;
                return `
                    <div class="px-6 pt-safe min-h-screen pb-24">
                        <h1 class="text-3xl font-black theme-text-heading mb-6">${utils.t('settings')}</h1>

                        <div class="bg-white dark:bg-slate-800 rounded-2xl p-4 card-shadow mb-6">
                            <div class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3">${utils.t('select_vehicle')}</div>
                            <button onclick="ui.openVehicleSelector()" class="w-full p-4 rounded-2xl ${vehicle ? utils.getCarColorClass(vehicle.color || 'teal') : 'bg-slate-50 dark:bg-slate-700'} text-left ${vehicle ? 'text-white' : 'theme-text-heading'}">
                                ${vehicle ? `
                                    <div class="text-[10px] font-bold tracking-wider uppercase text-white/80 mb-1">${vehicle.year} ${vehicle.make}</div>
                                    <div class="text-2xl font-black flex items-center gap-2">
                                        ${vehicle.model}
                                        <span class="material-icons text-xl text-white/80">expand_more</span>
                                    </div>
                                ` : `
                                    <div class="text-sm font-bold theme-text-heading flex items-center gap-2">
                                        ${utils.t('select_vehicle')}
                                        <span class="material-icons text-base text-slate-400">expand_more</span>
                                    </div>
                                `}
                            </button>
                        </div>
                        
                        <div class="bg-white dark:bg-slate-800 rounded-2xl p-4 card-shadow mb-6">
                            <div class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-4">Vehicle Management</div>
                            ${store.data.vehicles.map(v => `
                                <div class="flex items-center justify-between py-3 border-b theme-border last:border-0">
                                    <div class="flex items-center gap-3">
                                        <div class="w-10 h-10 rounded-full flex items-center justify-center text-white ${utils.getCarColorClass(v.color)}">
                                            <span class="material-icons text-lg">${utils.getCarIcon(v.type)}</span>
                                        </div>
                                        <div>
                                            <div class="font-bold theme-text-heading">${v.make} ${v.model}</div>
                                            <div class="text-xs theme-text-sub">${v.year} • ${v.currentOdometer} ${utils.getDistUnit()}</div>
                                        </div>
                                    </div>
                                    <button onclick="ui.openAddVehicle('${v.id}')" class="text-teal-500"><span class="material-icons">edit</span></button>
                                </div>
                            `).join('')}
                            <button onclick="ui.openAddVehicle()" class="w-full mt-4 py-2 border border-dashed border-teal-500 text-teal-600 rounded-xl text-sm font-bold hover:bg-teal-50 dark:hover:bg-teal-900/20 transition">+ ${utils.t('add_vehicle')}</button>
                            <button onclick="ui.addDemoCar()" class="w-full mt-2 py-2 border border-dashed theme-border theme-text-heading rounded-xl text-sm font-bold hover:bg-slate-50 dark:hover:bg-slate-700 transition">${utils.t('add_demo_car')}</button>
                        </div>
                        
                        <div class="bg-white dark:bg-slate-800 rounded-2xl p-4 card-shadow mb-4 border-2 border-teal-200 dark:border-teal-900/50">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-2">
                                    <span class="material-icons text-teal-600">notifications_active</span>
                                    <div class="text-sm font-black theme-text-heading uppercase tracking-wider">${utils.t('reminder_center')}</div>
                                </div>
                                <button onclick="router.navigate('reminders')" class="inline-flex items-center gap-2 text-xs font-bold text-teal-700 bg-teal-100 dark:bg-teal-900/30 px-3 py-2 rounded-xl border border-teal-200 dark:border-teal-800">${utils.t('view_all')} <span class="material-icons text-[16px]">arrow_forward</span></button>
                            </div>
                        </div>

                        <div class="bg-white dark:bg-slate-800 rounded-2xl p-5 card-shadow mb-6 border-2 border-teal-200 dark:border-teal-900/50 relative overflow-hidden">
                             <div class="absolute -top-10 -right-10 w-32 h-32 bg-teal-200/40 dark:bg-teal-900/30 rounded-full blur-2xl"></div>
                             <div class="relative">
                                 <div class="flex items-center justify-between mb-2">
                                     <div class="flex items-center gap-2">
                                         <span class="material-icons text-teal-600">notifications_active</span>
                                         <div class="text-sm font-black theme-text-heading uppercase tracking-wider">${utils.t('reminder_settings')}</div>
                                     </div>
                                 </div>
                                 <div class="text-xs theme-text-sub mb-3">${utils.t('reminder_settings_desc')}</div>
                             </div>
                             ${['license','insurance','registration'].map(type => {
                                 const conf = settings.reminders?.[type] || { enabled: true, days: 30 };
                                 return `
                                    <div class="flex items-center justify-between py-3 border-b theme-border last:border-0">
                                        <div class="text-sm font-bold theme-text-heading">${utils.t(type)}</div>
                                        <div class="flex items-center gap-2">
                                            <select onchange="store.data.settings.reminders['${type}'] = { ...store.data.settings.reminders['${type}'], days: this.value }; store.saveData();" class="text-xs p-1 rounded bg-slate-100 dark:bg-slate-700">
                                                <option value="30" ${conf.days==30?'selected':''}>${utils.t('rem_1m')}</option>
                                                <option value="7" ${conf.days==7?'selected':''}>${utils.t('rem_1w')}</option>
                                            </select>
                                            <div onclick="const s=store.data.settings.reminders['${type}']||{days:30}; s.enabled=!s.enabled; store.data.settings.reminders['${type}']=s; store.saveData(); ui.render()" class="w-10 h-6 rounded-full relative cursor-pointer transition-colors ${conf.enabled ? 'bg-teal-500' : 'bg-slate-300'}">
                                                <div class="w-4 h-4 bg-white rounded-full absolute top-1 transition-all ${conf.enabled ? 'left-5' : 'left-1'}"></div>
                                            </div>
                                        </div>
                                    </div>
                                 `;
                             }).join('')}
                        </div>
                        
                        <!-- Maintenance + Tire Interval -->
                        <div class="bg-white dark:bg-slate-800 rounded-2xl p-4 card-shadow mb-6">
                            <div class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3">${utils.t('interval_settings')}</div>
                            <div class="grid gap-4 sm:grid-cols-2">
                                <div class="space-y-3">
                                    <div class="text-xs font-bold theme-text-heading uppercase tracking-wider">${utils.t('service_interval')}</div>
                                    <div>
                                        <label class="text-xs theme-text-sub block mb-1">${utils.t('service_interval_dist')}</label>
                                        <select onchange="const v=store.getActiveVehicle(); if(!v) return; v.maintenanceDist=this.value; store.updateVehicle(v).then(()=>ui.render());" class="w-full p-2.5 rounded-xl bg-slate-50 dark:bg-slate-700 theme-text-heading text-sm">
                                            <option value="none" ${(vehicle?.maintenanceDist ?? settings.maintenanceDist)==='none'?'selected':''}>${utils.t('int_none')}</option>
                                            <option value="5000" ${(vehicle?.maintenanceDist ?? settings.maintenanceDist)==='5000'?'selected':''}>${utils.t('int_5k')}</option>
                                            <option value="10000" ${(vehicle?.maintenanceDist ?? settings.maintenanceDist)==='10000'?'selected':''}>${utils.t('int_10k')}</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="text-xs theme-text-sub block mb-1">${utils.t('service_interval_time')}</label>
                                        <select onchange="const v=store.getActiveVehicle(); if(!v) return; v.maintenanceTime=this.value; store.updateVehicle(v).then(()=>ui.render());" class="w-full p-2.5 rounded-xl bg-slate-50 dark:bg-slate-700 theme-text-heading text-sm">
                                            <option value="none" ${(vehicle?.maintenanceTime ?? settings.maintenanceTime)==='none'?'selected':''}>${utils.t('int_none')}</option>
                                            <option value="6" ${(vehicle?.maintenanceTime ?? settings.maintenanceTime)==='6'?'selected':''}>${utils.t('int_6m')}</option>
                                            <option value="12" ${(vehicle?.maintenanceTime ?? settings.maintenanceTime)==='12'?'selected':''}>${utils.t('int_1yr')}</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="space-y-3">
                                    <div class="text-xs font-bold theme-text-heading uppercase tracking-wider">${utils.t('tire_replace')}</div>
                                    <div>
                                        <label class="text-xs theme-text-sub block mb-1">${utils.t('tire_interval_dist')} (${utils.getDistUnit()})</label>
                                        <input type="number" min="0" step="100" value="${vehicle?.tireReplaceDist ?? settings.tireReplaceDist ?? 40000}" onchange="const v=store.getActiveVehicle(); if(!v) return; v.tireReplaceDist = parseInt(this.value)||0; store.updateVehicle(v).then(()=>ui.render());" class="w-full p-2.5 rounded-xl bg-slate-50 dark:bg-slate-700 theme-text-heading text-sm">
                                    </div>
                                    <div>
                                        <label class="text-xs theme-text-sub block mb-1">${utils.t('tire_interval_time')}</label>
                                        <select onchange="const v=store.getActiveVehicle(); if(!v) return; v.tireReplaceYears = parseInt(this.value)||0; store.updateVehicle(v).then(()=>ui.render());" class="w-full p-2.5 rounded-xl bg-slate-50 dark:bg-slate-700 theme-text-heading text-sm">
                                            ${[0,2,3,4,5,6].map(y => `<option value="${y}" ${parseInt(vehicle?.tireReplaceYears ?? settings.tireReplaceYears)==y?'selected':''}>${y===0 ? utils.t('int_none') : y}</option>`).join('')}
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white dark:bg-slate-800 rounded-2xl p-4 card-shadow mb-6">
                            <div class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-4">App Settings</div>
                            <div class="space-y-4">
                                <div>
                                    <label class="text-xs theme-text-sub block mb-1">${utils.t('units')}</label>
                                    <div class="flex bg-slate-100 dark:bg-slate-700 rounded-lg p-1">
                                        <button onclick="store.data.settings.units='metric';store.saveData();ui.render()" class="flex-1 py-1 text-xs rounded-md ${settings.units==='metric'?'bg-white dark:bg-slate-600 shadow':''}">${utils.t('metric')}</button>
                                        <button onclick="store.data.settings.units='imperial';store.saveData();ui.render()" class="flex-1 py-1 text-xs rounded-md ${settings.units==='imperial'?'bg-white dark:bg-slate-600 shadow':''}">${utils.t('imperial')}</button>
                                    </div>
                                </div>
                                <div>
                                    <label class="text-xs theme-text-sub block mb-1">${utils.t('pressure_unit')}</label>
                                    <select onchange="store.data.settings.pressureUnit=this.value;store.saveData();ui.render()" class="w-full p-2 rounded-lg text-sm">
                                        ${['psi','kPa','bar'].map(u => `<option value="${u}" ${(settings.pressureUnit||utils.getPressureUnit())===u?'selected':''}>${utils.t('unit_'+u.toLowerCase())}</option>`).join('')}
                                    </select>
                                </div>
                                <div>
                                    <label class="text-xs theme-text-sub block mb-1">${utils.t('currency')}</label>
                                    <select onchange="store.data.settings.currency=this.value;store.saveData();ui.render()" class="w-full p-2 rounded-lg text-sm">
                                        ${['$','€','£','¥','HK$','A$','NT$'].map(c => `<option value="${c}" ${settings.currency===c?'selected':''}>${c}</option>`).join('')}
                                    </select>
                                </div>
                                <div>
                                    <label class="text-xs theme-text-sub block mb-1">${utils.t('language')}</label>
                                    <select onchange="store.data.settings.language=this.value;store.saveData();ui.render()" class="w-full p-2 rounded-lg text-sm">
                                        <option value="en" ${settings.language==='en'?'selected':''}>English</option>
                                        <option value="zh" ${settings.language==='zh'?'selected':''}>繁體中文</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-3 mb-8">
                            <button onclick="ui.exportData()" class="bg-blue-50 text-blue-600 p-4 rounded-xl text-sm font-bold flex flex-col items-center gap-2"><span class="material-icons">download</span> ${utils.t('export_json')}</button>
                            <button onclick="document.getElementById('importFile').click()" class="bg-purple-50 text-purple-600 p-4 rounded-xl text-sm font-bold flex flex-col items-center gap-2"><span class="material-icons">upload</span> ${utils.t('import_json')}</button>
                            <input type="file" id="importFile" class="hidden" accept=".json" onchange="ui.importData(this)">
                            <button onclick="ui.exportCSV()" class="col-span-2 bg-green-50 text-green-600 p-4 rounded-xl text-sm font-bold flex items-center justify-center gap-2"><span class="material-icons">table_view</span> ${utils.t('export_csv')}</button>
                        </div>

                        <div class="bg-white dark:bg-slate-800 rounded-2xl p-4 card-shadow mb-6 border theme-border">
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">${utils.t('install_guide')}</div>
                                    <div class="text-sm theme-text-sub">${utils.t('install_guide_hint')}</div>
                                </div>
                                <button onclick="ui.openInstallGuide()" class="inline-flex items-center gap-2 text-xs font-bold text-teal-700 bg-teal-100 dark:bg-teal-900/30 px-3 py-2 rounded-xl border border-teal-200 dark:border-teal-800">
                                    ${utils.t('view_details')}
                                    <span class="material-icons text-[16px]">arrow_forward</span>
                                </button>
                            </div>
                        </div>
                        
                        <div class="text-center flex justify-center">
                            <button onclick="ui.openAboutModal()" class="text-teal-600 text-sm font-bold inline-flex items-center justify-center gap-2 opacity-80 hover:opacity-100">
                                <span class="material-icons">info</span> ${utils.t('about')}
                            </button>
                        </div>

                        <div class="mt-4 flex flex-col items-center">
                            <div class="inline-flex items-start gap-2 px-3 py-2 rounded-xl bg-red-50 text-red-700 border border-red-200">
                                <span class="material-icons text-base mt-0.5">warning</span>
                                <span class="font-bold">${utils.t('backup_warning')}</span>
                            </div>
                            <div class="text-[10px] theme-text-sub mt-2 text-center">v4.0 IndexedDB • Built for iOS</div>
                        </div>
                    </div>
                `;
            },
            
            renderLogCard(log) {
                const vehicle = store.data.vehicles.find(v => v.id === log.vehicleId);
                const date = utils.formatDate(log.date);
                let icon = 'edit_note';
                let colorClass = 'bg-slate-100 text-slate-600';
                let title = utils.t(log.type);
                
                if (log.type === 'fuel') { 
                    icon = 'local_gas_station'; 
                    colorClass = 'bg-teal-50 text-teal-600'; 
                } else if (log.type === 'parking') {
                    icon = 'local_parking';
                    colorClass = 'bg-blue-50 text-blue-600';
                } else if (log.type === 'fine') {
                    icon = 'local_police';
                    colorClass = 'bg-red-50 text-red-600';
                    if (log.notes) title = utils.t(log.notes.split(',')[0]); // Use first tag as title
                } else if (log.type === 'tire_replace') {
                    icon = 'tire_repair';
                    colorClass = 'bg-slate-50 text-slate-700';
                    const posLabel = log.tirePosition ? utils.t('tire_' + log.tirePosition) : '';
                    const brand = log.tireBrand ? ` • ${log.tireBrand}` : '';
                    title = `${utils.t('tire_replace')}${posLabel ? ' • ' + posLabel : ''}${brand}`;
                } else if (log.type === 'tire_rotation') {
                    icon = 'sync_alt';
                    colorClass = 'bg-slate-50 text-slate-700';
                    const swaps = Array.isArray(log.tireSwaps) && log.tireSwaps.length
                        ? log.tireSwaps
                        : (log.tireSwapA && log.tireSwapB ? [{ a: log.tireSwapA, b: log.tireSwapB }] : []);
                    const swapText = swaps
                        .map(s => {
                            const a = s?.a ? utils.t('tire_' + s.a) : '';
                            const b = s?.b ? utils.t('tire_' + s.b) : '';
                            return a && b ? `${a} ↔ ${b}` : '';
                        })
                        .filter(Boolean)
                        .join(', ');
                    title = `${utils.t('tire_rotation')}${swapText ? ` • ${swapText}` : ''}`;
                } else if (['license', 'insurance', 'registration'].includes(log.type)) {
                    icon = 'assignment';
                    colorClass = 'bg-purple-50 text-purple-600';
                } else if (log.type === 'periodic_maintenance') {
                    icon = 'update';
                    colorClass = 'bg-amber-50 text-amber-600';
                } else if (log.type === 'car_wash') {
                     icon = 'local_car_wash';
                     colorClass = 'bg-cyan-50 text-cyan-600';
                } else if (log.type === 'car_accessories') {
                     icon = 'shopping_bag';
                     colorClass = 'bg-pink-50 text-pink-600';
                }

                // Fuel Stats Logic
                let fuelStatsHtml = '';
                if (log.type === 'fuel') {
                    const allFuel = store.getVehicleLogs('fuel');
                    const idx = allFuel.findIndex(l => l.id === log.id);
                    let effVal = '--', costKm = '--';
                    const v = store.getActiveVehicle();
                    const isImperial = store.data.settings.units === 'imperial';
                    const isEV = v && v.fuelUnit === 'kWh';
                    const distUnit = utils.getDistUnit();
                    const fuelUnit = v && v.fuelUnit ? v.fuelUnit : (isImperial ? 'Gal' : 'L');
                    
                    // Logic to span over Partial logs
                    if (!log.isPartial) {
                         let foundPrevFull = false;
                         let prevLog = null;
                         let accumulatedLiters = 0;
                         let accumulatedCost = 0;
                         
                         // Look backwards from the current log
                         for (let i = idx + 1; i < allFuel.length; i++) {
                             const p = allFuel[i];
                             if (p.isPartial) {
                                 accumulatedLiters += parseFloat(p.liters);
                                 accumulatedCost += parseFloat(p.cost);
                             } else {
                                 foundPrevFull = true;
                                 prevLog = p;
                                 break;
                             }
                         }
                         
                         if (foundPrevFull && prevLog) {
                             // Current log liters + accumulated partials
                             // Distance is from Prev Full to Current Full
                             const dist = log.odometer - prevLog.odometer;
                             const totalFuel = parseFloat(log.liters) + accumulatedLiters;
                             const totalCost = parseFloat(log.cost) + accumulatedCost;
                             
                             if (dist > 0) {
                                 if (totalFuel > 0) {
                                     const eff = utils.calcEfficiencyValue(totalFuel, dist, fuelUnit, distUnit);
                                     if (eff !== null) effVal = eff.toFixed(1);
                                 }
                                 costKm = (totalCost / dist).toFixed(2);
                             }
                         }
                    }
                    
                    fuelStatsHtml = `
                        <div class="mt-3 pt-3 border-t theme-border flex justify-between text-xs">
                            <div>
                                <div class="theme-text-sub mb-0.5 uppercase tracking-wider text-[10px]">${utils.getEfficiencyLabel()}</div>
                                <div class="font-bold text-teal-600 text-sm">${effVal}</div>
                            </div>
                             <div class="text-right">
                                <div class="theme-text-sub mb-0.5 uppercase tracking-wider text-[10px]">${utils.getCostPerDistLabel()}</div>
                                <div class="font-bold text-teal-600 text-sm">${utils.formatCurrency(costKm)}</div>
                            </div>
                        </div>
                    `;
                }
                
                let locHtml = '';
                if (log.location) {
                    locHtml = `<a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(log.location)}" target="_blank" class="text-xs text-sky-500 hover:underline flex items-center gap-1 mt-1" onclick="event.stopPropagation()"><span class="material-icons text-[10px]">place</span>${log.location}</a>`;
                }

                let extraInfoHtml = '';
                if (log.type === 'fuel') {
                    const unit = vehicle ? (vehicle.fuelUnit || 'L') : 'L';
                    const ppu = (parseFloat(log.cost) / parseFloat(log.liters)).toFixed(2);
                    extraInfoHtml = `<div class="text-xs theme-text-sub mt-0.5"><span class="font-semibold theme-text-main">${log.liters} ${unit}</span> <span class="opacity-75">@ ${store.data.settings.currency}${ppu}/${unit}</span></div>`;
                } else if (log.type === 'tire_replace') {
                    const parts = [];
                    if (log.tireTread) parts.push(`${utils.t('tire_tread')}: ${log.tireTread}`);
                    const p = utils.formatPressureFromLog(log);
                    if (p) parts.push(`${utils.t('tire_pressure')}: ${p}`);
                    if (log.tireAlignment) parts.push(utils.t('tire_alignment'));
                    if (log.tireBalancing) parts.push(utils.t('tire_balancing'));
                    if (parts.length) extraInfoHtml = `<div class="text-xs theme-text-sub mt-0.5">${parts.join(' • ')}</div>`;
                }

                return `
                    <div class="theme-bg-card p-4 rounded-2xl card-shadow relative group">
                        <div class="flex justify-between items-start">
                            <div class="flex gap-3">
                                <div class="w-10 h-10 rounded-xl flex items-center justify-center ${colorClass}">
                                    <span class="material-icons">${icon}</span>
                                </div>
                                <div>
                                    <div class="font-bold text-sm theme-text-heading">${date}</div>
                                    <div class="text-xs theme-text-heading font-semibold mt-0.5">${title} ${log.isPartial ? `<span class="text-amber-500 text-[10px] border border-amber-500 px-1 rounded ml-1">${utils.t('partial')}</span>` : ''}</div>
                                    <div class="text-xs theme-text-sub mt-0.5">${log.odometer} ${utils.getDistUnit()}</div>
                                    ${extraInfoHtml}
                                    ${locHtml}
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="font-bold theme-text-heading">${utils.formatCurrency(log.cost)}</div>
                                <button type="button" data-action="edit-log" data-log-id="${log.id}" onclick="event.stopPropagation(); ui.openLogEditorById('${log.id}')" class="text-slate-300 hover:text-sky-500 mt-2"><span class="material-icons text-lg">edit</span></button>
                            </div>
                        </div>
                        ${fuelStatsHtml}
                        ${log.notes && log.type !== 'fine' ? `<div class="mt-2 text-xs theme-text-sub bg-slate-50 dark:bg-slate-800 p-2 rounded-lg italic">${log.notes}</div>` : ''}
                    </div>
                `;
            },
            
            renderBottomNav(active) {
                const nav = [
                    { id: 'dashboard', icon: 'dashboard', label: utils.t('dashboard') },
                    { id: 'fuel', icon: 'local_gas_station', label: utils.t('fuel') },
                    { id: 'parking', icon: 'local_parking', label: utils.t('parking') },
                    { id: 'maintenance', icon: 'build', label: utils.t('maintenance_plus') },
                    { id: 'analytics', icon: 'pie_chart', label: utils.t('analytics') },
                    { id: 'settings', icon: 'settings', label: utils.t('settings') }
                ];
                const activeIndex = Math.max(0, nav.findIndex(n => n.id === active));
                return `
                    <div class="liquid-nav nav-safe z-40" style="--active-index:${activeIndex}; --nav-count:${nav.length};">
                        <div class="liquid-nav-bg"></div>
                        <div class="liquid-nav-gloss"></div>
                        <div class="liquid-nav-inner flex justify-around items-center pt-2">
                            <div class="liquid-nav-highlight"></div>
                            ${nav.map(n => `
                                <button onclick="router.navigate('${n.id}')" class="liquid-nav-item flex flex-col items-center p-2 w-full transition-colors ${active === n.id ? 'text-teal-700 is-active' : 'text-slate-500'}">
                                    <span class="material-icons ${active === n.id ? 'text-2xl' : 'text-xl'}">${n.icon}</span>
                                    <span class="text-[10px] font-semibold mt-1">${n.label}</span>
                                </button>
                            `).join('')}
                        </div>
                    </div>
                `;
            },

            // --- MODALS ---
            openModal(html) {
                const overlay = document.getElementById('modal-overlay');
                const content = document.getElementById('modal-content');
                content.innerHTML = html;
                overlay.classList.remove('hidden');
                setTimeout(() => {
                    overlay.classList.remove('opacity-0');
                    content.classList.remove('translate-y-full');
                }, 10);
            },
            closeModal() {
                const overlay = document.getElementById('modal-overlay');
                const content = document.getElementById('modal-content');
                overlay.classList.add('opacity-0');
                content.classList.add('translate-y-full');
                setTimeout(() => overlay.classList.add('hidden'), 300);
            },

            openAddVehicle(id = null) {
                const v = id ? store.data.vehicles.find(v => v.id === id) : {
                    make: '',
                    model: '',
                    year: new Date().getFullYear(),
                    currentOdometer: '',
                    color: 'teal',
                    type: 'sedan',
                    fuelUnit: 'L',
                    driveType: 'fwd',
                    maintenanceDist: store.data.settings.maintenanceDist,
                    maintenanceTime: store.data.settings.maintenanceTime,
                    tireReplaceDist: store.data.settings.tireReplaceDist,
                    tireReplaceYears: store.data.settings.tireReplaceYears
                };
                const colors = ['teal','blue','red','black','white','yellow','purple','green','orange','brown','grey','pink','cyan'];
                
                this.openModal(`
                    <h2 class="text-xl font-bold mb-4 theme-text-heading">${id ? utils.t('edit_vehicle') : utils.t('add_vehicle')}</h2>
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-3">
                            <div><label class="text-xs theme-text-sub block mb-1">Make</label><input id="v_make" type="text" value="${v.make}" class="w-full p-3 rounded-xl" placeholder="Honda"></div>
                            <div><label class="text-xs theme-text-sub block mb-1">Model</label><input id="v_model" type="text" value="${v.model}" class="w-full p-3 rounded-xl" placeholder="Civic"></div>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                             <div><label class="text-xs theme-text-sub block mb-1">Year</label><input id="v_year" type="number" value="${v.year}" class="w-full p-3 rounded-xl"></div>
                             <div><label class="text-xs theme-text-sub block mb-1">${utils.t('odometer')}</label><input id="v_odo" type="number" value="${v.currentOdometer}" class="w-full p-3 rounded-xl"></div>
                        </div>
                        
                        <div>
                             <label class="text-xs theme-text-sub block mb-1">${utils.t('color')}</label>
                             <div class="grid grid-cols-7 gap-2">
                                 ${colors.map(c => `
                                     <label class="cursor-pointer relative flex items-center justify-center">
                                         <input type="radio" name="v_color" value="${c}" class="sr-only color-radio" ${v.color===c ? 'checked' : ''}>
                                         <div class="w-8 h-8 rounded-full ${utils.getCarColorClass(c)} transition-transform hover:scale-110"></div>
                                     </label>
                                 `).join('')}
                             </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-3">
                             <div>
                                <label class="text-xs theme-text-sub block mb-1">${utils.t('type')}</label>
                                <select id="v_type" class="w-full p-3 rounded-xl text-sm">
                                    ${['sedan','hatch','suv','offroad_4x4','ute','bike','truck','sports','van','bus'].map(t => `<option value="${t}" ${v.type===t?'selected':''}>${utils.t('type_'+t)}</option>`).join('')}
                                </select>
                             </div>
                             <div>
                                <label class="text-xs theme-text-sub block mb-1">Fuel/Energy</label>
                                <select id="v_unit" class="w-full p-3 rounded-xl text-sm">
                                    <option value="L" ${v.fuelUnit==='L'?'selected':''}>Liters (Gas)</option>
                                    <option value="Gal" ${v.fuelUnit==='Gal'?'selected':''}>Gallons (Gas)</option>
                                    <option value="kWh" ${v.fuelUnit==='kWh'?'selected':''}>kWh (EV)</option>
                                </select>
                             </div>
                        </div>

                        <div>
                            <label class="text-xs theme-text-sub block mb-1">${utils.t('drive_type')}</label>
                            <select id="v_drive" class="w-full p-3 rounded-xl text-sm">
                                <option value="fwd" ${(v.driveType||'fwd')==='fwd'?'selected':''}>${utils.t('drive_fwd')}</option>
                                <option value="rwd" ${(v.driveType||'fwd')==='rwd'?'selected':''}>${utils.t('drive_rwd')}</option>
                                <option value="awd" ${(v.driveType||'fwd')==='awd'?'selected':''}>${utils.t('drive_awd')}</option>
                            </select>
                        </div>

                        <div class="bg-slate-50 dark:bg-slate-800/40 p-3 rounded-xl border theme-border">
                            <div class="text-xs font-bold theme-text-heading uppercase tracking-wider mb-2">${utils.t('interval_settings')}</div>
                            <div class="grid gap-3 sm:grid-cols-2">
                                <div>
                                    <div class="text-[10px] font-bold theme-text-sub uppercase tracking-wider mb-1">${utils.t('service_interval')}</div>
                                    <label class="text-xs theme-text-sub block mb-1">${utils.t('service_interval_dist')}</label>
                                    <select id="v_maint_dist" class="w-full p-2.5 rounded-xl bg-slate-50 dark:bg-slate-700 theme-text-heading text-sm">
                                        <option value="none" ${(v.maintenanceDist ?? store.data.settings.maintenanceDist)==='none'?'selected':''}>${utils.t('int_none')}</option>
                                        <option value="5000" ${(v.maintenanceDist ?? store.data.settings.maintenanceDist)==='5000'?'selected':''}>${utils.t('int_5k')}</option>
                                        <option value="10000" ${(v.maintenanceDist ?? store.data.settings.maintenanceDist)==='10000'?'selected':''}>${utils.t('int_10k')}</option>
                                    </select>
                                    <label class="text-xs theme-text-sub block mb-1 mt-2">${utils.t('service_interval_time')}</label>
                                    <select id="v_maint_time" class="w-full p-2.5 rounded-xl bg-slate-50 dark:bg-slate-700 theme-text-heading text-sm">
                                        <option value="none" ${(v.maintenanceTime ?? store.data.settings.maintenanceTime)==='none'?'selected':''}>${utils.t('int_none')}</option>
                                        <option value="6" ${(v.maintenanceTime ?? store.data.settings.maintenanceTime)==='6'?'selected':''}>${utils.t('int_6m')}</option>
                                        <option value="12" ${(v.maintenanceTime ?? store.data.settings.maintenanceTime)==='12'?'selected':''}>${utils.t('int_1yr')}</option>
                                    </select>
                                </div>
                                <div>
                                    <div class="text-[10px] font-bold theme-text-sub uppercase tracking-wider mb-1">${utils.t('tire_replace')}</div>
                                    <label class="text-xs theme-text-sub block mb-1">${utils.t('tire_interval_dist')} (${utils.getDistUnit()})</label>
                                    <input id="v_tire_dist" type="number" min="0" step="100" value="${v.tireReplaceDist ?? store.data.settings.tireReplaceDist ?? 40000}" class="w-full p-2.5 rounded-xl bg-slate-50 dark:bg-slate-700 theme-text-heading text-sm">
                                    <label class="text-xs theme-text-sub block mb-1 mt-2">${utils.t('tire_interval_time')}</label>
                                    <select id="v_tire_years" class="w-full p-2.5 rounded-xl bg-slate-50 dark:bg-slate-700 theme-text-heading text-sm">
                                        ${[0,2,3,4,5,6].map(y => `<option value="${y}" ${parseInt(v.tireReplaceYears ?? store.data.settings.tireReplaceYears)==y?'selected':''}>${y===0 ? utils.t('int_none') : y}</option>`).join('')}
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="flex gap-3 mt-6">
                            ${id ? `<button onclick="ui.deleteVehicle('${id}')" class="flex-1 bg-red-50 text-red-600 py-3 rounded-xl font-bold">${utils.t('delete')}</button>` : ''}
                            <button onclick="ui.saveVehicle('${id || ''}')" class="flex-1 grad-teal text-white py-3 rounded-xl font-bold shadow-lg">${utils.t('save')}</button>
                        </div>
                        ${id ? `<button onclick="ui.clearVehicleData('${id}')" class="w-full mt-2 text-xs text-red-400 py-2 border border-red-100 rounded-xl hover:bg-red-50">${utils.t('clear_history')}</button>` : ''}
                    </div>
                `);
            },
            
            async saveVehicle(id) {
                const make = document.getElementById('v_make').value;
                const model = document.getElementById('v_model').value;
                if (!make || !model) return alert('Make and Model are required');
                const existing = id ? store.data.vehicles.find(v => v.id === id) : null;
                
                const vehicle = {
                    id: id || utils.newId(),
                    make, model,
                    year: document.getElementById('v_year').value,
                    currentOdometer: parseInt(document.getElementById('v_odo').value) || 0,
                    color: document.querySelector('input[name="v_color"]:checked').value,
                    type: document.getElementById('v_type').value,
                    fuelUnit: document.getElementById('v_unit').value,
                    driveType: document.getElementById('v_drive').value,
                    maintenanceDist: document.getElementById('v_maint_dist').value,
                    maintenanceTime: document.getElementById('v_maint_time').value,
                    tireReplaceDist: parseInt(document.getElementById('v_tire_dist').value) || 0,
                    tireReplaceYears: parseInt(document.getElementById('v_tire_years').value) || 0
                };
                
                if (id) await store.updateVehicle(vehicle);
                else await store.addVehicle(vehicle);
                
                this.closeModal();
                this.render();
            },
            
            deleteVehicle(id) {
                setTimeout(() => {
                    if (confirm(utils.t('confirm_delete'))) {
                        store.deleteVehicle(id).then(() => {
                            this.closeModal();
                            this.render();
                        });
                    }
                }, 50);
            },
            
            clearVehicleData(id) {
                setTimeout(() => {
                    if (confirm(utils.t('confirm_clear'))) {
                        setTimeout(() => {
                            if (confirm(utils.t('confirm_clear_2'))) {
                                store.clearVehicleLogs(id).then(() => {
                                    this.closeModal();
                                    this.render();
                                });
                            }
                        }, 200);
                    }
                }, 50);
            },

            async addDemoCar() {
                const existing = store.data.vehicles.find(v => v.make === 'DEMO' && v.model === 'Car');
                if (existing) {
                    store.data.settings.activeVehicleId = existing.id;
                    await store.saveData();
                    this.render();
                    return;
                }

                const now = new Date();
                const isoDaysAgo = (daysAgo) => {
                    const d = new Date(now);
                    d.setDate(d.getDate() - daysAgo);
                    return d.toISOString().slice(0, 10);
                };
                const isoDaysFromNow = (daysFromNow) => {
                    const d = new Date(now);
                    d.setDate(d.getDate() + daysFromNow);
                    return d.toISOString().slice(0, 10);
                };

                const vehicleId = utils.newId();
                const demoVehicle = {
                    id: vehicleId,
                    make: 'DEMO',
                    model: 'Car',
                    year: now.getFullYear(),
                    currentOdometer: 24222,
                    color: 'teal',
                    type: 'sedan',
                    fuelUnit: (store.data.settings.units === 'imperial') ? 'Gal' : 'L',
                    driveType: 'fwd',
                    maintenanceDist: store.data.settings.maintenanceDist,
                    maintenanceTime: store.data.settings.maintenanceTime,
                    tireReplaceDist: store.data.settings.tireReplaceDist,
                    tireReplaceYears: store.data.settings.tireReplaceYears
                };

                await store.addVehicle(demoVehicle);
                store.data.settings.activeVehicleId = vehicleId;

                if (!Number.isFinite(parseInt(store.data.settings.maintenanceDist))) store.data.settings.maintenanceDist = '5000';
                if (!Number.isFinite(parseInt(store.data.settings.maintenanceTime))) store.data.settings.maintenanceTime = '6';
                if (!store.data.settings.tireReplaceDist) store.data.settings.tireReplaceDist = 40000;
                if (!store.data.settings.tireReplaceYears) store.data.settings.tireReplaceYears = 4;
                store.data.settings.lastBackupDate = isoDaysAgo(45);
                demoVehicle.maintenanceDist = store.data.settings.maintenanceDist;
                demoVehicle.maintenanceTime = store.data.settings.maintenanceTime;
                demoVehicle.tireReplaceDist = store.data.settings.tireReplaceDist;
                demoVehicle.tireReplaceYears = store.data.settings.tireReplaceYears;
                await store.saveData();

                const add = async (log) => store.addLog({ id: utils.newId(), vehicleId, ...log });

                const demoFuelNotes = store.data.settings.language === 'zh' ? '示範：加油記錄' : 'Demo: fuel log';
                await add({ type: 'fuel', date: isoDaysAgo(150), odometer: 18000, liters: '42.0', cost: '560', location: 'Shell', notes: demoFuelNotes, isPartial: false });
                await add({ type: 'fuel', date: isoDaysAgo(132), odometer: 18620, liters: '10.0', cost: '135', location: 'Shell', notes: store.data.settings.language === 'zh' ? '示範：Partial' : 'Demo: partial', isPartial: true });
                await add({ type: 'fuel', date: isoDaysAgo(120), odometer: 19010, liters: '39.5', cost: '520', location: 'Esso', notes: demoFuelNotes, isPartial: false });
                await add({ type: 'fuel', date: isoDaysAgo(90), odometer: 20180, liters: '41.2', cost: '545', location: 'Caltex', notes: demoFuelNotes, isPartial: false });
                await add({ type: 'fuel', date: isoDaysAgo(60), odometer: 21480, liters: '40.1', cost: '532', location: 'Caltex', notes: demoFuelNotes, isPartial: false });
                await add({ type: 'fuel', date: isoDaysAgo(20), odometer: 23390, liters: '38.6', cost: '512', location: 'Shell', notes: demoFuelNotes, isPartial: false });

                await add({ type: 'parking', date: isoDaysAgo(18), cost: '48', location: 'Central', notes: store.data.settings.language === 'zh' ? '示範：停車場' : 'Demo: parking' });
                await add({ type: 'parking', date: isoDaysAgo(7), cost: '36', location: 'Mall', notes: store.data.settings.language === 'zh' ? '示範：短泊' : 'Demo: short stay' });
                await add({ type: 'parking', date: isoDaysAgo(45), cost: '62', location: 'Airport', notes: store.data.settings.language === 'zh' ? '示範：機場停車' : 'Demo: airport parking' });
                await add({ type: 'parking', date: isoDaysAgo(80), cost: '30', location: 'Street', notes: store.data.settings.language === 'zh' ? '示範：路邊停車' : 'Demo: street parking' });

                await add({ type: 'service', date: isoDaysAgo(75), odometer: 20600, cost: '880', location: 'Garage', notes: store.data.settings.language === 'zh' ? '示範：更換機油' : 'Demo: oil change' });
                await add({ type: 'service', date: isoDaysAgo(110), odometer: 19880, cost: '650', location: 'Service Center', notes: store.data.settings.language === 'zh' ? '示範：更換煞車皮' : 'Demo: brake pads' });
                await add({ type: 'repair', date: isoDaysAgo(35), odometer: 22400, cost: '320', location: 'Garage', notes: store.data.settings.language === 'zh' ? '示範：更換雨刷' : 'Demo: wiper blades' });
                await add({ type: 'repair', date: isoDaysAgo(15), odometer: 24100, cost: '420', location: 'Garage', notes: store.data.settings.language === 'zh' ? '示範：更換電池' : 'Demo: battery' });
                await add({ type: 'car_wash', date: isoDaysAgo(12), odometer: 23500, cost: '80', location: 'Car Wash', notes: store.data.settings.language === 'zh' ? '示範：洗車' : 'Demo: car wash' });
                await add({ type: 'car_wash', date: isoDaysAgo(42), odometer: 21980, cost: '60', location: 'Car Wash', notes: store.data.settings.language === 'zh' ? '示範：快速洗車' : 'Demo: quick wash' });
                await add({ type: 'car_accessories', date: isoDaysAgo(5), odometer: 24050, cost: '199', location: '', notes: store.data.settings.language === 'zh' ? '示範：配件' : 'Demo: accessories' });
                await add({ type: 'car_accessories', date: isoDaysAgo(32), odometer: 22980, cost: '120', location: 'Auto Shop', notes: store.data.settings.language === 'zh' ? '示範：車內配件' : 'Demo: interior accessories' });
                await add({ type: 'periodic_maintenance', date: isoDaysAgo(160), odometer: 17500, cost: '0', location: '', notes: store.data.settings.language === 'zh' ? '示範：定期保養提醒' : 'Demo: periodic maintenance' });

                await add({ type: 'fine', date: isoDaysAgo(28), odometer: 23000, cost: '450', location: '', notes: 'speeding, demo' });
                await add({ type: 'fine', date: isoDaysAgo(95), odometer: 21050, cost: '320', location: '', notes: 'no_parking, demo' });

                await add({ type: 'license', date: isoDaysAgo(10), odometer: 23800, cost: '600', expiryDate: isoDaysFromNow(14), location: '', notes: '' });
                await add({ type: 'insurance', date: isoDaysAgo(9), odometer: 23810, cost: '1200', expiryDate: isoDaysFromNow(25), location: '', notes: '' });
                await add({ type: 'registration', date: isoDaysAgo(8), odometer: 23820, cost: '300', expiryDate: isoDaysFromNow(7), location: '', notes: '' });

                const mkTireReplace = async (pos, daysAgo, odo, brand, treadMm, pressureKpa, remainingDist, remainingMonths) => {
                    const remDist = Number.isFinite(parseFloat(remainingDist)) ? parseFloat(remainingDist) : null;
                    const remMonths = Number.isFinite(parseFloat(remainingMonths)) ? parseFloat(remainingMonths) : null;
                    await add({
                        type: 'tire_replace',
                        date: isoDaysAgo(daysAgo),
                        odometer: odo,
                        cost: pos === 'front_left' ? '900' : '',
                        location: '',
                        notes: store.data.settings.language === 'zh' ? '示範：更換輪胎' : 'Demo: tire replace',
                        tirePosition: pos,
                        tireBrand: brand,
                        tireTread: String(treadMm),
                        tirePressureKpa: String(pressureKpa),
                        tireRemainingDist: remDist === null ? null : Math.max(0, remDist),
                        tireRemainingDays: remMonths === null ? null : Math.max(0, Math.round(remMonths * 30)),
                        tireAlignment: pos === 'front_left',
                        tireBalancing: true,
                        tireId: utils.newId()
                    });
                };

                await mkTireReplace('front_left', 180, 21000, 'Michelin', 7.0, 240, 18000, 24);
                await mkTireReplace('front_right', 140, 20800, 'Michelin', 6.5, 240, 12000, 18);
                await mkTireReplace('rear_left', 120, 20500, 'Michelin', 6.8, 240, 14000, 20);
                await mkTireReplace('rear_right', 120, 20500, 'Michelin', 6.8, 240, 14000, 20);

                await add({
                    type: 'tire_rotation',
                    date: isoDaysAgo(55),
                    odometer: 21600,
                    cost: '',
                    location: '',
                    notes: store.data.settings.language === 'zh' ? '示範：輪胎換位（前後互換）' : 'Demo: tire rotation (front ↔ rear)',
                    tireSwaps: [{ a: 'front_left', b: 'rear_left' }, { a: 'front_right', b: 'rear_right' }],
                    tireSwapA: 'front_left',
                    tireSwapB: 'rear_left'
                });

                await store.updateVehicle(demoVehicle);
                this.render();
            },

            openAddFuel(id = null) {
                const log = id ? store.data.logs.find(l => String(l.id) === String(id)) : { date: new Date().toISOString().slice(0, 10), odometer: store.getActiveVehicle()?.currentOdometer || '', liters: '', cost: '', location: '', notes: '', isPartial: false };
                const fuelUnit = utils.getFuelUnit();
                const volLabel = fuelUnit === 'kWh' ? utils.t('kwh') : (fuelUnit === 'Gal' ? utils.t('gallons') : utils.t('liters'));
                
                this.openModal(`
                    <h2 class="text-xl font-bold mb-4 theme-text-heading flex items-center gap-2"><span class="material-icons text-teal-600">local_gas_station</span> ${utils.t('add_fuel')}</h2>
                    <div class="space-y-4">
                        <div><label class="text-xs theme-text-sub block mb-1">${utils.t('date')}</label><input id="l_date" type="date" value="${log.date}" class="w-full p-3 rounded-xl"></div>
                        
                         <div>
                            <div class="flex justify-between items-center mb-1">
                                <label class="text-xs theme-text-sub">${utils.t('odometer')}</label>
                                <button onclick="this.innerText = this.innerText==='TRIP' ? 'ODO' : 'TRIP'; document.getElementById('l_odo').placeholder = this.innerText==='TRIP' ? 'Trip Dist (e.g. 400)' : 'Total Odo';" class="text-[10px] bg-slate-200 px-2 py-0.5 rounded font-bold">ODO</button>
                            </div>
                            <input id="l_odo" type="number" value="${log.odometer}" class="w-full p-3 rounded-xl" onblur="if(this.placeholder.includes('Trip')){ this.value = ${store.getActiveVehicle()?.currentOdometer || 0} + parseInt(this.value||0); }">
                        </div>

                        <div class="grid grid-cols-2 gap-3">
                            <div><label class="text-xs theme-text-sub block mb-1">${volLabel}</label><input id="l_liters" type="number" step="0.01" value="${log.liters}" class="w-full p-3 rounded-xl" oninput="ui.calcFuel('vol')"></div>
                            <div><label class="text-xs theme-text-sub block mb-1">${utils.t('price_unit')}</label><input id="l_price" type="number" step="0.01" class="w-full p-3 rounded-xl bg-slate-50" oninput="ui.calcFuel('price')"></div>
                        </div>
                        <div><label class="text-xs theme-text-sub block mb-1">${utils.t('cost')}</label><input id="l_cost" type="number" step="0.01" value="${log.cost}" class="w-full p-3 rounded-xl" oninput="ui.calcFuel('cost')"></div>
                        
                        <div class="flex items-center gap-2 bg-amber-50 p-3 rounded-xl">
                            <input type="checkbox" id="l_partial" class="w-5 h-5 text-teal-600 rounded" ${log.isPartial?'checked':''}>
                            <label for="l_partial" class="text-sm font-medium text-amber-800">${utils.t('partial_tank')}</label>
                        </div>

                        <div class="relative">
                             <label class="text-xs theme-text-sub block mb-1">${utils.t('location')}</label>
                             <input id="l_loc" type="text" value="${log.location || ''}" class="w-full p-3 rounded-xl pr-10">
                             <button onclick="utils.detectLocation(l => document.getElementById('l_loc').value=l)" class="absolute right-3 top-8 text-teal-500"><span class="material-icons">my_location</span></button>
                        </div>

                        <div class="flex gap-3 mt-4">
                            ${id ? `<button onclick="ui.deleteLog('${id}')" class="flex-1 bg-red-50 text-red-600 py-3 rounded-xl font-bold">${utils.t('delete')}</button>` : ''}
                            <button onclick="ui.submitFuel('${id || ''}')" class="flex-1 grad-teal text-white py-3 rounded-xl font-bold shadow-lg">${utils.t('save')}</button>
                        </div>
                    </div>
                `);
                // Init calc
                setTimeout(() => ui.calcFuel('init'), 100);
            },

            calcFuel(trigger) {
                const litersEl = document.getElementById('l_liters');
                const costEl = document.getElementById('l_cost');
                const priceEl = document.getElementById('l_price');

                const vol = parseFloat(litersEl.value) || 0;
                const cost = parseFloat(costEl.value) || 0;
                const price = parseFloat(priceEl.value) || 0;

                const compute = (targetKey) => {
                    if (targetKey === 'liters') {
                        if (price > 0 && cost > 0) litersEl.value = (cost / price).toFixed(2);
                    } else if (targetKey === 'cost') {
                        if (vol > 0 && price > 0) costEl.value = (vol * price).toFixed(2);
                    } else if (targetKey === 'price') {
                        if (vol > 0 && cost > 0) priceEl.value = (cost / vol).toFixed(3);
                    }
                };

                // Initialize derived field without affecting "last 2 inputs" behavior.
                if (trigger === 'init') {
                    if (!price && vol > 0 && cost > 0) compute('price');
                    else if (!cost && vol > 0 && price > 0) compute('cost');
                    else if (!vol && cost > 0 && price > 0) compute('liters');
                    return;
                }

                // Input logic: last 2 edited fields determine the 3rd.
                if (!this._fuelCalcLast) this._fuelCalcLast = [];
                const key = trigger === 'vol' ? 'liters' : trigger; // 'cost' | 'price' | 'liters'
                this._fuelCalcLast = this._fuelCalcLast.filter(k => k !== key);
                this._fuelCalcLast.push(key);
                if (this._fuelCalcLast.length > 2) this._fuelCalcLast = this._fuelCalcLast.slice(-2);
                if (this._fuelCalcLast.length < 2) return;

                const keys = new Set(this._fuelCalcLast);
                const targetKey = ['liters', 'cost', 'price'].find(k => !keys.has(k));
                if (!targetKey) return;

                compute(targetKey);
            },

            async submitFuel(id) {
                const odo = parseInt(document.getElementById('l_odo').value);
                if (!odo) return alert('Odometer is required');
                
                const log = {
                    id: id || utils.newId(),
                    vehicleId: store.data.settings.activeVehicleId,
                    type: 'fuel',
                    date: document.getElementById('l_date').value,
                    odometer: odo,
                    liters: document.getElementById('l_liters').value,
                    cost: document.getElementById('l_cost').value,
                    location: document.getElementById('l_loc').value,
                    isPartial: document.getElementById('l_partial').checked,
                    notes: ''
                };
                
                if (id) await store.updateLog(log);
                else await store.addLog(log);
                this.closeModal();
                this.render();
            },

            openQuickTireSetup(pos = null, applyAll = false) {
                const distUnit = utils.getDistUnit();
                const defaultPos = pos || 'front_left';
                this.openModal(`
                    <h2 class="text-xl font-bold mb-2 theme-text-heading">${utils.t('quick_tire_setup')}</h2>
                    <div class="text-xs theme-text-sub mb-4">${utils.t('quick_tire_setup_desc')}</div>
                    <div class="space-y-4">
                        <div class="bg-slate-50 dark:bg-slate-800/40 p-3 rounded-xl border theme-border">
                            <label class="flex items-center gap-2 text-xs theme-text-heading bg-white/70 dark:bg-slate-800/60 p-2 rounded-xl border theme-border">
                                <input id="qs_apply_all" type="checkbox" class="w-4 h-4" ${applyAll ? 'checked' : ''} onchange="ui.toggleQuickTireSetupAll(this.checked)">
                                <span>${utils.t('apply_to_all_tires')}</span>
                            </label>
                            <div id="qs_apply_mode" class="flex gap-2 mt-2 ${applyAll ? '' : 'hidden'}">
                                <button onclick="ui.setQuickTireSetupMode('unset')" id="qs_apply_unset_btn" class="flex-1 py-2 rounded-xl text-[10px] font-bold border ${applyAll ? 'bg-teal-50 text-teal-700 border-teal-200 dark:bg-teal-900/20' : 'bg-slate-50 dark:bg-slate-800 theme-border theme-text-sub'}">${utils.t('apply_unset_only')}</button>
                                <button onclick="ui.setQuickTireSetupMode('all')" id="qs_apply_all_btn" class="flex-1 py-2 rounded-xl text-[10px] font-bold border bg-slate-50 dark:bg-slate-800 theme-border theme-text-sub">${utils.t('apply_overwrite_all')}</button>
                                <input type="hidden" id="qs_apply_mode_value" value="unset">
                            </div>
                        </div>
                        <div id="qs_pos_wrap" class="bg-slate-50 dark:bg-slate-800/40 p-3 rounded-xl border theme-border ${applyAll ? 'hidden' : ''}">
                            <div class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-2">1/3</div>
                            <label class="text-xs theme-text-sub block mb-1">${utils.t('tire_pos')}</label>
                            <select id="qs_tire_pos" class="w-full p-3 rounded-xl text-sm">
                                ${['front_left','front_right','rear_left','rear_right'].map(p => `<option value="${p}" ${defaultPos===p?'selected':''}>${utils.t('tire_'+p)}</option>`).join('')}
                            </select>
                        </div>
                        <div class="bg-slate-50 dark:bg-slate-800/40 p-3 rounded-xl border theme-border">
                            <div class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-2">2/3</div>
                            <label class="text-xs theme-text-sub block mb-1">${utils.t('remaining_distance')}</label>
                            <input id="qs_remaining_dist" type="number" min="0" step="1" class="w-full p-3 rounded-xl text-sm" placeholder="${distUnit}">
                            <div class="text-[10px] theme-text-sub mt-1">${distUnit}</div>
                            <label class="text-xs theme-text-sub block mb-1 mt-3">${utils.t('remaining_months')}</label>
                            <input id="qs_remaining_months" type="number" min="0" step="1" class="w-full p-3 rounded-xl text-sm" placeholder="e.g. 12">
                        </div>
                        <div class="bg-slate-50 dark:bg-slate-800/40 p-3 rounded-xl border theme-border">
                            <div class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-2">3/3</div>
                            <label class="text-xs theme-text-sub block mb-1">${utils.t('tire_tread')}</label>
                            <input id="qs_tire_tread" type="number" min="0" step="0.1" class="w-full p-3 rounded-xl text-sm" placeholder="e.g. 6.5">
                        </div>
                        <div class="flex gap-3 mt-2">
                            <button onclick="ui.closeModal()" class="flex-1 bg-slate-100 dark:bg-slate-800 theme-text-heading py-3 rounded-xl font-bold border theme-border">${utils.t('cancel')}</button>
                            <button onclick="ui.submitQuickTireSetup()" class="flex-1 grad-teal text-white py-3 rounded-xl font-bold shadow-lg">${utils.t('save')}</button>
                        </div>
                    </div>
                `);
            },

            async submitQuickTireSetup() {
                const applyAll = !!document.getElementById('qs_apply_all')?.checked;
                const applyMode = document.getElementById('qs_apply_mode_value')?.value || 'unset';
                const pos = document.getElementById('qs_tire_pos').value;
                const remainingDistRaw = document.getElementById('qs_remaining_dist').value;
                const remainingMonthsRaw = document.getElementById('qs_remaining_months').value;
                const treadRaw = document.getElementById('qs_tire_tread').value;
                const remainingDist = Number.isFinite(parseFloat(remainingDistRaw)) ? parseFloat(remainingDistRaw) : null;
                const remainingMonths = Number.isFinite(parseFloat(remainingMonthsRaw)) ? parseFloat(remainingMonthsRaw) : null;
                const tread = Number.isFinite(parseFloat(treadRaw)) ? parseFloat(treadRaw) : null;

                if (remainingDist === null && remainingMonths === null) {
                    return alert(utils.t('quick_tire_setup_error'));
                }

                const vehicle = store.getActiveVehicle();
                if (!vehicle) return;
                const currentOdo = parseFloat(vehicle.currentOdometer) || 0;
                const now = new Date();

                const positions = (() => {
                    if (!applyAll) return [pos];
                    if (applyMode === 'all') return utils.getTirePositions();
                    const statuses = utils.getTireReplacementStatus(vehicle);
                    const unset = statuses.filter(s => s.isNotSet).map(s => s.pos);
                    return unset.length ? unset : utils.getTirePositions();
                })();

                for (const p of positions) {
                    const log = {
                        id: utils.newId(),
                        vehicleId: vehicle.id,
                        type: 'tire_replace',
                        date: now.toISOString().slice(0, 10),
                        odometer: currentOdo,
                        cost: '',
                        location: '',
                        notes: '',
                        tirePosition: p,
                        tireBrand: '',
                        tireTread: tread === null ? '' : tread,
                        tireRemainingDist: remainingDist === null ? null : Math.max(0, remainingDist),
                        tireRemainingDays: remainingMonths === null ? null : Math.max(0, Math.round(remainingMonths * 30))
                    };
                    await store.addLog(log);
                }
                this.closeModal();
                this.render();
            },

            toggleQuickTireSetupAll(isAll) {
                const wrap = document.getElementById('qs_pos_wrap');
                if (wrap) wrap.classList.toggle('hidden', isAll);
                const mode = document.getElementById('qs_apply_mode');
                if (mode) mode.classList.toggle('hidden', !isAll);
                if (isAll) this.setQuickTireSetupMode('unset');
            },

            setQuickTireSetupMode(mode) {
                const unsetBtn = document.getElementById('qs_apply_unset_btn');
                const allBtn = document.getElementById('qs_apply_all_btn');
                const value = document.getElementById('qs_apply_mode_value');
                if (value) value.value = mode;
                if (unsetBtn && allBtn) {
                    const base = 'flex-1 py-2 rounded-xl text-[10px] font-bold border ';
                    const active = 'bg-teal-50 text-teal-700 border-teal-200 dark:bg-teal-900/20';
                    const inactive = 'bg-slate-50 dark:bg-slate-800 theme-border theme-text-sub';
                    unsetBtn.className = base + (mode === 'unset' ? active : inactive);
                    allBtn.className = base + (mode === 'all' ? active : inactive);
                }
            },

            openAddService(id = null, defaultType = 'service') {
                const existing = id ? store.data.logs.find(l => String(l.id) === String(id)) : null;
                const log = existing ? { ...existing } : { date: new Date().toISOString().slice(0, 10), odometer: store.getActiveVehicle()?.currentOdometer || '', type: defaultType, cost: '', location: '', notes: '', expiryDate: '', tirePosition: 'front_left', tireBrand: '', tireTread: '', tirePressureKpa: '', tireAlignment: false, tireBalancing: false, tireSwaps: [{ a: 'front_left', b: 'rear_left' }, { a: 'front_right', b: 'rear_right' }] };
                if (log.type === 'tire_replace') {
                    const unit = utils.getPressureUnit();
                    const kpa = (log.tirePressureKpa !== undefined && log.tirePressureKpa !== null && log.tirePressureKpa !== '')
                        ? utils.pressureToKpa(log.tirePressureKpa, 'kPa')
                        : (log.tirePressure ? utils.pressureToKpa(log.tirePressure, 'psi') : null);
                    const shown = kpa === null ? null : utils.pressureFromKpa(kpa, unit);
                    const shownNumber = Number.isFinite(shown) ? shown : null;
                    log._tirePressureDisplay = shownNumber === null ? '' : (unit === 'psi' ? shownNumber.toFixed(0) : shownNumber.toFixed(1));
                }
                
                if (log.type === 'tire_rotation') {
                    const swaps = Array.isArray(log.tireSwaps) && log.tireSwaps.length
                        ? log.tireSwaps
                        : (log.tireSwapA && log.tireSwapB ? [{ a: log.tireSwapA, b: log.tireSwapB }] : [{ a: 'front_left', b: 'rear_left' }, { a: 'front_right', b: 'rear_right' }]);
                    log.tireSwaps = swaps;
                    log.tireSwapA1 = swaps[0]?.a || 'front_left';
                    log.tireSwapB1 = swaps[0]?.b || 'rear_left';
                    log.tireSwapA2 = swaps[1]?.a || 'front_right';
                    log.tireSwapB2 = swaps[1]?.b || 'rear_right';
                    log.tireRotPattern = swaps.length >= 2 ? 'front_rear' : 'single';
                }
                const quickTags = ['oil_change','tire_change','alignment','air_filter','cabin_filter','spark_plugs','brake_fluid','transmission_fluid','coolant','wiper_blades','battery','brake','inspection'];
                
                this.openModal(`
                    <h2 class="text-xl font-bold mb-4 theme-text-heading">${utils.t('add_service')}</h2>
                    <div class="space-y-4">
                        <select id="l_type" class="w-full p-3 rounded-xl font-bold bg-slate-100" onchange="ui.handleTypeChange(this.value)">
                            <option value="service" ${log.type==='service'?'selected':''}>${utils.t('service')}</option>
                            <option value="repair" ${log.type==='repair'?'selected':''}>${utils.t('repair')}</option>
                            <option value="tire_replace" ${log.type==='tire_replace'?'selected':''}>${utils.t('tire_replace')}</option>
                            <option value="tire_rotation" ${log.type==='tire_rotation'?'selected':''}>${utils.t('tire_rotation')}</option>
                            <option value="periodic_maintenance" ${log.type==='periodic_maintenance'?'selected':''}>${utils.t('periodic_maintenance')}</option>
                            <option value="car_wash" ${log.type==='car_wash'?'selected':''}>${utils.t('car_wash')}</option>
                            <option value="car_accessories" ${log.type==='car_accessories'?'selected':''}>${utils.t('car_accessories')}</option>
                            <option value="fine" ${log.type==='fine'?'selected':''}>${utils.t('traffic_fine')}</option>
                            <hr>
                            <option value="license" ${log.type==='license'?'selected':''}>${utils.t('license')}</option>
                            <option value="insurance" ${log.type==='insurance'?'selected':''}>${utils.t('insurance')}</option>
                            <option value="registration" ${log.type==='registration'?'selected':''}>${utils.t('registration')}</option>
                        </select>
                        
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 service-odo-grid">
                            <div><label class="text-xs theme-text-sub block mb-1">${utils.t('date')}</label><input id="l_date" type="date" value="${log.date}" class="w-full p-3 rounded-xl"></div>
                            <div><label class="text-xs theme-text-sub block mb-1">${utils.t('odometer')}</label><input id="l_odo" type="number" value="${log.odometer}" class="w-full p-3 rounded-xl"></div>
                        </div>
                        <div><label class="text-xs theme-text-sub block mb-1">${utils.t('cost')}</label><input id="l_cost" type="number" step="0.01" value="${log.cost}" class="w-full p-3 rounded-xl"></div>
                        
                        <!-- Dynamic Fields -->
                        <div id="expiry_field" class="${['license','insurance','registration'].includes(log.type) ? '' : 'hidden'}">
                             <label class="text-xs theme-text-sub block mb-1">New Expiry Date</label>
                             <input id="l_expiry" type="date" value="${log.expiryDate || ''}" class="w-full p-3 rounded-xl border-purple-300">
                        </div>
                        
                        <div id="loc_note_fields" class="${['license','insurance','registration'].includes(log.type) ? 'hidden' : ''}">
                            <div id="tire_replace_fields" class="${log.type === 'tire_replace' ? '' : 'hidden'} bg-slate-50 dark:bg-slate-800/40 p-3 rounded-xl border theme-border mb-3">
                                <div class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">${utils.t('tire_positions')}</div>
                                <div class="grid grid-cols-2 gap-3">
                                    <div>
                                        <label class="text-xs theme-text-sub block mb-1">${utils.t('tire_pos')}</label>
                                        <select id="l_tire_pos" class="w-full p-3 rounded-xl text-sm">
                                            ${['front_left','front_right','rear_left','rear_right'].map(p => `<option value="${p}" ${log.tirePosition===p?'selected':''}>${utils.t('tire_'+p)}</option>`).join('')}
                                        </select>
                                    </div>
                                    <div>
                                        <label class="text-xs theme-text-sub block mb-1">${utils.t('tire_brand')}</label>
                                        <input id="l_tire_brand" type="text" value="${log.tireBrand || ''}" class="w-full p-3 rounded-xl text-sm" placeholder="e.g. Michelin Primacy 4">
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-3 mt-3">
                                    <div>
                                        <label class="text-xs theme-text-sub block mb-1">${utils.t('tire_tread')}</label>
                                        <input id="l_tire_tread" type="number" step="0.1" value="${log.tireTread || ''}" class="w-full p-3 rounded-xl text-sm" placeholder="e.g. 6.5">
                                    </div>
                                    <div>
                                        <label class="text-xs theme-text-sub block mb-1">${utils.t('tire_pressure')}</label>
                                        <input id="l_tire_pressure" type="number" step="0.5" value="${log._tirePressureDisplay || ''}" class="w-full p-3 rounded-xl text-sm" placeholder="${utils.getPressureUnit()==='psi'?'e.g. 32':(utils.getPressureUnit()==='bar'?'e.g. 2.3':'e.g. 220')}">
                                        <div class="text-[10px] theme-text-sub mt-1">${utils.getPressureUnit()}</div>
                                    </div>
                                </div>
                                <div class="flex gap-3 mt-3">
                                    <label class="flex items-center gap-2 text-xs theme-text-heading bg-white/70 dark:bg-slate-800/60 p-2 rounded-xl border theme-border flex-1">
                                        <input id="l_tire_alignment" type="checkbox" class="w-4 h-4" ${log.tireAlignment ? 'checked' : ''}>
                                        <span>${utils.t('tire_alignment')}</span>
                                    </label>
                                    <label class="flex items-center gap-2 text-xs theme-text-heading bg-white/70 dark:bg-slate-800/60 p-2 rounded-xl border theme-border flex-1">
                                        <input id="l_tire_balancing" type="checkbox" class="w-4 h-4" ${log.tireBalancing ? 'checked' : ''}>
                                        <span>${utils.t('tire_balancing')}</span>
                                    </label>
                                </div>
                            </div>
                            <div id="tire_rotation_fields" class="${log.type === 'tire_rotation' ? '' : 'hidden'} bg-slate-50 dark:bg-slate-800/40 p-3 rounded-xl border theme-border mb-3">
                                <div class="flex items-center justify-between mb-2">
                                    <div class="text-xs font-bold text-slate-400 uppercase tracking-wider">${utils.t('tire_swap')}</div>
                                    <select id="l_tire_rot_pattern" onchange="ui.applyTireRotationPattern(this.value)" class="text-xs p-1 rounded bg-white/70 dark:bg-slate-700 border theme-border">
                                        <option value="front_rear" ${log.tireRotPattern==='front_rear'?'selected':''}>Front ↔ Rear</option>
                                        <option value="cross" ${log.tireRotPattern==='cross'?'selected':''}>Cross</option>
                                        <option value="front_swap" ${log.tireRotPattern==='front_swap'?'selected':''}>Front L ↔ Front R</option>
                                        <option value="rear_swap" ${log.tireRotPattern==='rear_swap'?'selected':''}>Rear L ↔ Rear R</option>
                                        <option value="single" ${log.tireRotPattern==='single'?'selected':''}>Single Swap</option>
                                    </select>
                                </div>
                                <div class="text-[10px] text-slate-400 mb-2">${utils.t('tire_recommended')}: ${utils.t('drive_' + (store.getActiveVehicle()?.driveType || 'fwd'))}</div>

                                <div class="grid grid-cols-2 gap-3">
                                    <div>
                                        <label class="text-xs theme-text-sub block mb-1">${utils.t('tire_swap_a')}</label>
                                        <select id="l_tire_swap_a1" class="w-full p-3 rounded-xl text-sm">
                                            ${['front_left','front_right','rear_left','rear_right'].map(p => `<option value="${p}" ${(log.tireSwapA1||'front_left')===p?'selected':''}>${utils.t('tire_'+p)}</option>`).join('')}
                                        </select>
                                    </div>
                                    <div>
                                        <label class="text-xs theme-text-sub block mb-1">${utils.t('tire_swap_b')}</label>
                                        <select id="l_tire_swap_b1" class="w-full p-3 rounded-xl text-sm">
                                            ${['front_left','front_right','rear_left','rear_right'].map(p => `<option value="${p}" ${(log.tireSwapB1||'rear_left')===p?'selected':''}>${utils.t('tire_'+p)}</option>`).join('')}
                                        </select>
                                    </div>
                                </div>

                                <div id="tire_rotation_pair2" class="${log.tireRotPattern==='single' ? 'hidden' : ''} grid grid-cols-2 gap-3 mt-2">
                                    <div>
                                        <label class="text-xs theme-text-sub block mb-1">${utils.t('tire_swap_a')}</label>
                                        <select id="l_tire_swap_a2" class="w-full p-3 rounded-xl text-sm">
                                            ${['front_left','front_right','rear_left','rear_right'].map(p => `<option value="${p}" ${(log.tireSwapA2||'front_right')===p?'selected':''}>${utils.t('tire_'+p)}</option>`).join('')}
                                        </select>
                                    </div>
                                    <div>
                                        <label class="text-xs theme-text-sub block mb-1">${utils.t('tire_swap_b')}</label>
                                        <select id="l_tire_swap_b2" class="w-full p-3 rounded-xl text-sm">
                                            ${['front_left','front_right','rear_left','rear_right'].map(p => `<option value="${p}" ${(log.tireSwapB2||'rear_right')===p?'selected':''}>${utils.t('tire_'+p)}</option>`).join('')}
                                        </select>
                                    </div>
                                </div>

                                <div class="grid grid-cols-3 gap-2 mt-3">
                                    <button onclick="ui.applyRecommendedTireRotation('fwd')" class="py-2 rounded-xl text-[10px] font-bold bg-slate-100 dark:bg-slate-800 theme-text-heading">FWD</button>
                                    <button onclick="ui.applyRecommendedTireRotation('rwd')" class="py-2 rounded-xl text-[10px] font-bold bg-slate-100 dark:bg-slate-800 theme-text-heading">RWD</button>
                                    <button onclick="ui.applyRecommendedTireRotation('awd')" class="py-2 rounded-xl text-[10px] font-bold bg-slate-100 dark:bg-slate-800 theme-text-heading">AWD</button>
                                </div>
                            </div>
                             <div class="relative mb-3">
                                 <label class="text-xs theme-text-sub block mb-1">${utils.t('location')}</label>
                                 <input id="l_loc" type="text" value="${log.location || ''}" class="w-full p-3 rounded-xl pr-10">
                                 <button onclick="utils.detectLocation(l => document.getElementById('l_loc').value=l)" class="absolute right-3 top-8 text-teal-500"><span class="material-icons">my_location</span></button>
                            </div>
                            
                            <div id="quick_tags" class="flex flex-wrap gap-2 mb-2">
                                ${quickTags.map(t => `<button onclick="document.getElementById('l_notes').value += (document.getElementById('l_notes').value ? ', ' : '') + '${utils.t(t)}'" class="text-[10px] bg-slate-100 px-2 py-1 rounded-full border hover:bg-teal-50 hover:text-teal-600 transition">+ ${utils.t(t)}</button>`).join('')}
                            </div>
                            <div id="fine_tags" class="hidden flex flex-wrap gap-2 mb-2">
                                ${['parking_ticket','no_parking','speeding','red_light','illegal_turn','bus_lane','seatbelt','phone_use','toll'].map(t => `<button onclick="document.getElementById('l_notes').value = '${utils.t(t)}'" class="text-[10px] bg-red-50 text-red-600 px-2 py-1 rounded-full border border-red-100 hover:bg-red-100 transition">${utils.t(t)}</button>`).join('')}
                            </div>
                            
                            <div>
                                <label class="text-xs theme-text-sub block mb-1">${utils.t('notes')}</label>
                                <textarea id="l_notes" class="w-full p-3 rounded-xl h-20">${log.notes || ''}</textarea>
                            </div>
                        </div>

                        <div class="flex gap-3 mt-4">
                            ${id ? `<button onclick="ui.deleteLog('${id}')" class="flex-1 bg-red-50 text-red-600 py-3 rounded-xl font-bold">${utils.t('delete')}</button>` : ''}
                            <button onclick="ui.submitService('${id || ''}')" class="flex-1 grad-teal text-white py-3 rounded-xl font-bold shadow-lg">${utils.t('save')}</button>
                        </div>
                    </div>
                `);
                // Init state
                this.handleTypeChange(log.type);
            },
            
            handleTypeChange(type) {
                const isDoc = ['license','insurance','registration'].includes(type);
                const isFine = type === 'fine';
                const isTireReplace = type === 'tire_replace';
                const isTireRotation = type === 'tire_rotation';
                document.getElementById('expiry_field').classList.toggle('hidden', !isDoc);
                document.getElementById('loc_note_fields').classList.toggle('hidden', isDoc);
                if (!isDoc) {
                    document.getElementById('quick_tags').classList.toggle('hidden', isFine);
                    document.getElementById('fine_tags').classList.toggle('hidden', !isFine);
                    const tireReplaceFields = document.getElementById('tire_replace_fields');
                    if (tireReplaceFields) tireReplaceFields.classList.toggle('hidden', !isTireReplace);
                    const tireRotationFields = document.getElementById('tire_rotation_fields');
                    if (tireRotationFields) tireRotationFields.classList.toggle('hidden', !isTireRotation);
                }
            },

            applyTireRotationPattern(pattern) {
                const pair2 = document.getElementById('tire_rotation_pair2');
                const set = (id, value) => {
                    const el = document.getElementById(id);
                    if (el) el.value = value;
                };
                if (pattern === 'front_rear') {
                    if (pair2) pair2.classList.remove('hidden');
                    set('l_tire_swap_a1', 'front_left'); set('l_tire_swap_b1', 'rear_left');
                    set('l_tire_swap_a2', 'front_right'); set('l_tire_swap_b2', 'rear_right');
                } else if (pattern === 'cross') {
                    if (pair2) pair2.classList.remove('hidden');
                    set('l_tire_swap_a1', 'front_left'); set('l_tire_swap_b1', 'rear_right');
                    set('l_tire_swap_a2', 'front_right'); set('l_tire_swap_b2', 'rear_left');
                } else if (pattern === 'front_swap') {
                    if (pair2) pair2.classList.add('hidden');
                    set('l_tire_swap_a1', 'front_left'); set('l_tire_swap_b1', 'front_right');
                } else if (pattern === 'rear_swap') {
                    if (pair2) pair2.classList.add('hidden');
                    set('l_tire_swap_a1', 'rear_left'); set('l_tire_swap_b1', 'rear_right');
                } else { // 'single'
                    if (pair2) pair2.classList.add('hidden');
                }
            },

            applyRecommendedTireRotation(driveType) {
                const drive = (driveType || (store.getActiveVehicle()?.driveType) || 'fwd').toLowerCase();
                // Common default recommendations:
                // - FWD: cross rear -> front, front -> rear same-side
                // - RWD: cross front -> rear, rear -> front same-side
                // - AWD: front <-> rear same-side (safe/simple for mixed tires)
                if (drive === 'rwd') {
                    document.getElementById('l_tire_rot_pattern').value = 'cross';
                    this.applyTireRotationPattern('cross');
                    // swap direction for RWD (front -> rear cross)
                    const pair2 = document.getElementById('tire_rotation_pair2');
                    if (pair2) pair2.classList.remove('hidden');
                    document.getElementById('l_tire_swap_a1').value = 'front_left';
                    document.getElementById('l_tire_swap_b1').value = 'rear_right';
                    document.getElementById('l_tire_swap_a2').value = 'front_right';
                    document.getElementById('l_tire_swap_b2').value = 'rear_left';
                    return;
                }
                if (drive === 'awd') {
                    document.getElementById('l_tire_rot_pattern').value = 'front_rear';
                    this.applyTireRotationPattern('front_rear');
                    return;
                }
                // fwd default
                document.getElementById('l_tire_rot_pattern').value = 'cross';
                this.applyTireRotationPattern('cross');
                // swap direction for FWD (rear -> front cross)
                const pair2 = document.getElementById('tire_rotation_pair2');
                if (pair2) pair2.classList.remove('hidden');
                document.getElementById('l_tire_swap_a1').value = 'rear_left';
                document.getElementById('l_tire_swap_b1').value = 'front_right';
                document.getElementById('l_tire_swap_a2').value = 'rear_right';
                document.getElementById('l_tire_swap_b2').value = 'front_left';
            },

            openLogEditorById(id) {
                const log = store.data.logs.find(l => String(l.id) === String(id));
                if (!log) return;
                if (log.type === 'fuel') return this.openAddFuel(log.id);
                if (log.type === 'parking') return this.openAddParking(log.id);
                return this.openAddService(log.id);
            },

            async submitService(id) {
                const type = document.getElementById('l_type').value;
                const isDoc = ['license','insurance','registration'].includes(type);
                const isTireReplace = type === 'tire_replace';
                const isTireRotation = type === 'tire_rotation';
                const existing = id ? store.data.logs.find(l => String(l.id) === String(id)) : null;

                let tireSwaps;
                let tireSwapA;
                let tireSwapB;
                if (isTireRotation) {
                    const get = (elId) => document.getElementById(elId)?.value;
                    const swaps = [];
                    const addSwap = (a, b) => {
                        if (!a || !b || a === b) return;
                        swaps.push({ a, b });
                    };
                    addSwap(get('l_tire_swap_a1'), get('l_tire_swap_b1'));
                    const pair2 = document.getElementById('tire_rotation_pair2');
                    if (pair2 && !pair2.classList.contains('hidden')) {
                        addSwap(get('l_tire_swap_a2'), get('l_tire_swap_b2'));
                    }
                    if (!swaps.length) return alert('Please select tire swap positions.');
                    const used = new Set();
                    for (const s of swaps) {
                        if (used.has(s.a) || used.has(s.b)) return alert('Each tire position can only appear once per rotation.');
                        used.add(s.a); used.add(s.b);
                    }
                    tireSwaps = swaps;
                    tireSwapA = swaps[0].a;
                    tireSwapB = swaps[0].b;
                }
                
                const log = {
                    id: id || utils.newId(),
                    vehicleId: store.data.settings.activeVehicleId,
                    type,
                    date: document.getElementById('l_date').value,
                    odometer: parseInt(document.getElementById('l_odo').value) || 0,
                    cost: document.getElementById('l_cost').value,
                    location: isDoc ? '' : document.getElementById('l_loc').value,
                    notes: isDoc ? '' : document.getElementById('l_notes').value,
                    expiryDate: isDoc ? document.getElementById('l_expiry').value : '',
                    tirePosition: isTireReplace ? document.getElementById('l_tire_pos')?.value : undefined,
                    tireBrand: isTireReplace ? document.getElementById('l_tire_brand')?.value : undefined,
                    tireTread: isTireReplace ? document.getElementById('l_tire_tread')?.value : undefined,
                    tirePressureKpa: isTireReplace ? (utils.pressureToKpa(document.getElementById('l_tire_pressure')?.value, utils.getPressureUnit())?.toFixed(1) || '') : undefined,
                    tireAlignment: isTireReplace ? !!document.getElementById('l_tire_alignment')?.checked : undefined,
                    tireBalancing: isTireReplace ? !!document.getElementById('l_tire_balancing')?.checked : undefined,
                    tireId: isTireReplace ? (existing?.tireId || utils.newId()) : undefined,
                    tireSwaps: isTireRotation ? tireSwaps : undefined,
                    tireSwapA: isTireRotation ? tireSwapA : undefined,
                    tireSwapB: isTireRotation ? tireSwapB : undefined
                };
                
                if (id) await store.updateLog(log);
                else await store.addLog(log);
                this.closeModal();
                this.render();
            },
            
            openAddParking(id = null) {
                const log = id ? store.data.logs.find(l => String(l.id) === String(id)) : { date: new Date().toISOString().slice(0, 10), cost: '', location: '', notes: '' };
                this.openModal(`
                    <h2 class="text-xl font-bold mb-4 theme-text-heading flex items-center gap-2"><span class="material-icons text-blue-600">local_parking</span> ${utils.t('add_parking')}</h2>
                    <div class="space-y-4">
                        <div><label class="text-xs theme-text-sub block mb-1">${utils.t('date')}</label><input id="p_date" type="date" value="${log.date}" class="w-full p-3 rounded-xl"></div>
                        <div><label class="text-xs theme-text-sub block mb-1">${utils.t('cost')}</label><input id="p_cost" type="number" step="0.01" value="${log.cost}" class="w-full p-3 rounded-xl"></div>
                        <div class="relative">
                             <label class="text-xs theme-text-sub block mb-1">${utils.t('location')}</label>
                             <input id="p_loc" type="text" value="${log.location || ''}" class="w-full p-3 rounded-xl pr-10">
                             <button onclick="utils.detectLocation(l => document.getElementById('p_loc').value=l)" class="absolute right-3 top-8 text-teal-500"><span class="material-icons">my_location</span></button>
                        </div>
                        <div><label class="text-xs theme-text-sub block mb-1">${utils.t('notes')}</label><textarea id="p_notes" class="w-full p-3 rounded-xl h-20">${log.notes || ''}</textarea></div>
                        <div class="flex gap-3 mt-4">
                            ${id ? `<button onclick="ui.deleteLog('${id}')" class="flex-1 bg-red-50 text-red-600 py-3 rounded-xl font-bold">${utils.t('delete')}</button>` : ''}
                            <button onclick="ui.submitParking('${id || ''}')" class="flex-1 bg-blue-600 text-white py-3 rounded-xl font-bold shadow-lg">${utils.t('save')}</button>
                        </div>
                    </div>
                `);
            },
            
            async submitParking(id) {
                const log = {
                    id: id || utils.newId(),
                    vehicleId: store.data.settings.activeVehicleId,
                    type: 'parking',
                    date: document.getElementById('p_date').value,
                    cost: document.getElementById('p_cost').value,
                    location: document.getElementById('p_loc').value,
                    notes: document.getElementById('p_notes').value
                };
                if (id) await store.updateLog(log);
                else await store.addLog(log);
                this.closeModal();
                this.render();
            },

            deleteLog(id) {
                setTimeout(() => {
                    if (confirm(utils.t('confirm_delete'))) {
                        store.deleteLog(id).then(() => {
                            this.closeModal();
                            this.render();
                        });
                    }
                }, 50);
            },
            
            // --- EXPORT / IMPORT / SELECTORS ---
            snoozeReminder(id, days) {
                const rc = store.data.settings.reminderCenter || { snoozedUntil: {}, done: {} };
                rc.snoozedUntil = rc.snoozedUntil || {};
                rc.done = rc.done || {};
                rc.snoozedUntil[id] = new Date(Date.now() + (days * 86400000)).toISOString();
                store.data.settings.reminderCenter = rc;
                store.saveData().then(() => this.render());
            },

            snoozeAllReminders(days) {
                const vehicle = store.getActiveVehicle();
                if (!vehicle) return;
                const { activeItems } = this.getReminderData(vehicle);
                if (!activeItems.length) return;
                const rc = store.data.settings.reminderCenter || { snoozedUntil: {}, done: {} };
                rc.snoozedUntil = rc.snoozedUntil || {};
                rc.done = rc.done || {};
                const until = new Date(Date.now() + (days * 86400000)).toISOString();
                activeItems.forEach(it => {
                    rc.snoozedUntil[it.id] = until;
                });
                store.data.settings.reminderCenter = rc;
                store.saveData().then(() => this.render());
            },

            markReminderDone(id) {
                const rc = store.data.settings.reminderCenter || { snoozedUntil: {}, done: {} };
                rc.snoozedUntil = rc.snoozedUntil || {};
                rc.done = rc.done || {};
                rc.done[id] = true;
                delete rc.snoozedUntil[id];
                store.data.settings.reminderCenter = rc;
                store.saveData().then(() => this.render());
            },

            clearDoneReminders() {
                const rc = store.data.settings.reminderCenter || { snoozedUntil: {}, done: {} };
                rc.snoozedUntil = rc.snoozedUntil || {};
                rc.done = {};
                store.data.settings.reminderCenter = rc;
                store.saveData().then(() => this.render());
            },

            restoreReminder(id) {
                const rc = store.data.settings.reminderCenter || { snoozedUntil: {}, done: {} };
                rc.snoozedUntil = rc.snoozedUntil || {};
                rc.done = rc.done || {};
                delete rc.done[id];
                store.data.settings.reminderCenter = rc;
                store.saveData().then(() => this.render());
            },

            unsnoozeReminder(id) {
                const rc = store.data.settings.reminderCenter || { snoozedUntil: {}, done: {} };
                rc.snoozedUntil = rc.snoozedUntil || {};
                delete rc.snoozedUntil[id];
                store.data.settings.reminderCenter = rc;
                store.saveData().then(() => this.render());
            },

            downloadBackup(filenamePrefix = 'fuelmate_backup') {
                const json = JSON.stringify(store.data);
                const blob = new Blob([json], {type: 'application/json'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                const ts = new Date().toISOString().replace(/[:]/g, '').slice(0, 15);
                a.download = `${filenamePrefix}_${ts}.json`;
                a.click();
                return a.download;
            },

            exportData() {
                const json = JSON.stringify(store.data);
                const blob = new Blob([json], {type: 'application/json'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `fuelmate_backup_${new Date().toISOString().slice(0,10)}.json`;
                a.click();
                
                // Update backup date
                store.data.settings.lastBackupDate = new Date().toISOString();
                store.saveData();
                this.render();
            },
            
            exportCSV() { utils.exportCSV(); },

            importData(input) {
                const file = input.files[0];
                if (!file) return;
                
                const fileName = file.name || 'backup.json';
                const fileSize = file.size || 0;

                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        const validation = utils.validateImportData(data);
                        if (!validation.ok) {
                            alert(utils.t('import_invalid'));
                            input.value = '';
                            return;
                        }

                        const currentSummary = utils.summarizeImportData(store.data);
                        const incomingSummary = validation.summary;
                        const topTypes = (counts) => Object.entries(counts)
                            .sort((a,b) => b[1]-a[1])
                            .slice(0, 6)
                            .map(([k,v]) => `${k}: ${v}`)
                            .join(', ');

                        const warningText = validation.warnings?.some(w => w.code === 'orphan_logs')
                            ? `<div class="text-xs text-amber-700 bg-amber-50 p-3 rounded-xl border border-amber-200">${utils.t('import_warn')} (${validation.warnings.find(w=>w.code==='orphan_logs').count} orphan logs)</div>`
                            : `<div class="text-xs text-amber-700 bg-amber-50 p-3 rounded-xl border border-amber-200">${utils.t('import_warn')}</div>`;

                        ui.openModal(`
                            <div class="space-y-4">
                                <div class="flex items-center justify-between">
                                    <h2 class="text-xl font-bold theme-text-heading">${utils.t('import_summary')}</h2>
                                    <button onclick="ui.closeModal()" class="text-slate-400"><span class="material-icons">close</span></button>
                                </div>

                                ${warningText}

                                <div class="theme-bg-card p-4 rounded-2xl border theme-border">
                                    <div class="text-xs theme-text-sub uppercase tracking-wider mb-2">${utils.t('import_file')}</div>
                                    <div class="font-bold theme-text-heading">${fileName}</div>
                                    <div class="text-xs theme-text-sub">${utils.formatFileSize(fileSize)}</div>
                                </div>

                                <div class="grid grid-cols-2 gap-3">
                                    <div class="theme-bg-card p-4 rounded-2xl border theme-border">
                                        <div class="text-xs theme-text-sub uppercase tracking-wider mb-2">${utils.t('import_current')}</div>
                                        <div class="text-sm font-bold theme-text-heading">${utils.t('import_counts')}: ${currentSummary.vehiclesCount} / ${currentSummary.logsCount}</div>
                                        <div class="text-xs theme-text-sub mt-1">${utils.t('import_types')}: ${topTypes(currentSummary.typeCounts) || '--'}</div>
                                    </div>
                                    <div class="theme-bg-card p-4 rounded-2xl border theme-border">
                                        <div class="text-xs theme-text-sub uppercase tracking-wider mb-2">${utils.t('import_incoming')}</div>
                                        <div class="text-sm font-bold theme-text-heading">${utils.t('import_counts')}: ${incomingSummary.vehiclesCount} / ${incomingSummary.logsCount}</div>
                                        <div class="text-xs theme-text-sub mt-1">${utils.t('import_types')}: ${topTypes(incomingSummary.typeCounts) || '--'}</div>
                                    </div>
                                </div>

                                <div class="theme-bg-card p-4 rounded-2xl border theme-border">
                                    <div class="text-xs theme-text-sub uppercase tracking-wider mb-2">${utils.t('import_settings')}</div>
                                    <div class="text-xs theme-text-sub">
                                        units: ${incomingSummary.settings.units || '--'} • currency: ${incomingSummary.settings.currency || '--'} • language: ${incomingSummary.settings.language || '--'}
                                    </div>
                                </div>

                                <div class="flex gap-3">
                                    <button onclick="ui.closeModal()" class="flex-1 bg-slate-100 dark:bg-slate-800 theme-text-heading py-3 rounded-xl font-bold">${utils.t('cancel')}</button>
                                    <button id="confirm_import_btn" class="flex-1 grad-teal text-white py-3 rounded-xl font-bold shadow-lg">${utils.t('import_overwrite')}</button>
                                </div>
                            </div>
                        `);

                        document.getElementById('confirm_import_btn').onclick = async () => {
                            try {
                                const backupName = ui.downloadBackup('fuelmate_autobackup');
                                store.data.settings.lastBackupDate = new Date().toISOString();
                                await store.saveData();

                                await store.importData(data, { overwrite: true });
                                alert(`${utils.t('import_autobackup')} ${backupName}\n${utils.t('success_import')}`);
                                location.reload();
                            } catch (err) {
                                console.error(err);
                                alert(utils.t('err_file'));
                            }
                        };
                    } catch (err) {
                        console.error(err);
                        alert(utils.t('err_file'));
                    } finally {
                        input.value = '';
                    }
                };
                reader.readAsText(file);
            },
            
            openVehicleSelector() {
                 this.openModal(`
                    <h2 class="text-xl font-bold mb-4 theme-text-heading">${utils.t('select_vehicle')}</h2>
                    <div class="space-y-2">
                        ${store.data.vehicles.map(v => `
                            <button onclick="store.data.settings.activeVehicleId='${v.id}'; store.saveData(); ui.closeModal(); ui.render();" class="w-full p-4 rounded-xl flex items-center gap-3 ${store.data.settings.activeVehicleId === v.id ? 'bg-teal-50 border-teal-500 border' : 'bg-slate-50 border theme-border'}">
                                <div class="w-10 h-10 rounded-full flex items-center justify-center text-white ${utils.getCarColorClass(v.color)}">
                                    <span class="material-icons">${utils.getCarIcon(v.type)}</span>
                                </div>
                                <div class="text-left">
                                    <div class="font-bold theme-text-heading">${v.make} ${v.model}</div>
                                    <div class="text-xs theme-text-sub">${v.year} • ${utils.t('type_' + (v.type || 'sedan'))}</div>
                                </div>
                                ${store.data.settings.activeVehicleId === v.id ? '<span class="material-icons ml-auto text-teal-600">check_circle</span>' : ''}
                            </button>
                        `).join('')}
                    </div>
                 `);
            },
            
            openCalendarSelector() {
                this.openModal(`
                    <h2 class="text-xl font-bold mb-4 theme-text-heading">${utils.t('select_export')}</h2>
                    <div class="space-y-3">
                        <button onclick="ui.openCalendarConfig('license')" class="w-full p-4 rounded-xl bg-purple-50 text-purple-700 font-bold flex items-center justify-between">
                            <span class="flex items-center gap-2"><span class="material-icons">badge</span> ${utils.t('license')}</span>
                            <span class="material-icons">chevron_right</span>
                        </button>
                        <button onclick="ui.openCalendarConfig('insurance')" class="w-full p-4 rounded-xl bg-purple-50 text-purple-700 font-bold flex items-center justify-between">
                            <span class="flex items-center gap-2"><span class="material-icons">security</span> ${utils.t('insurance')}</span>
                            <span class="material-icons">chevron_right</span>
                        </button>
                        <button onclick="ui.openCalendarConfig('registration')" class="w-full p-4 rounded-xl bg-purple-50 text-purple-700 font-bold flex items-center justify-between">
                            <span class="flex items-center gap-2"><span class="material-icons">directions_car</span> ${utils.t('registration')}</span>
                            <span class="material-icons">chevron_right</span>
                        </button>
                    </div>
                `);
            },
            
            openCalendarConfig(type) {
                this.openModal(`
                    <h2 class="text-xl font-bold mb-2 theme-text-heading">${utils.t('export_calendar')}</h2>
                    <p class="text-sm theme-text-sub mb-4">${utils.t(type)}</p>
                    <label class="text-xs font-bold uppercase tracking-wider mb-2 block theme-text-sub">${utils.t('reminder_time')}</label>
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="utils.exportCalendar('${type}', null); ui.closeModal()" class="p-3 rounded-xl border theme-border font-medium text-sm hover:bg-slate-50">${utils.t('rem_none')}</button>
                        <button onclick="utils.exportCalendar('${type}', 0); ui.closeModal()" class="p-3 rounded-xl border theme-border font-medium text-sm hover:bg-slate-50">${utils.t('rem_day')}</button>
                        <button onclick="utils.exportCalendar('${type}', 7); ui.closeModal()" class="p-3 rounded-xl border theme-border font-medium text-sm hover:bg-slate-50">${utils.t('rem_1w')}</button>
                        <button onclick="utils.exportCalendar('${type}', 30); ui.closeModal()" class="p-3 rounded-xl border theme-border font-medium text-sm hover:bg-slate-50">${utils.t('rem_1m')}</button>
                    </div>
                `);
            },

            openReminderCalendarSelector({ title, dateIso, type } = {}) {
                const titleEnc = encodeURIComponent(title || '');
                const dateEnc = encodeURIComponent(dateIso || '');
                const typeEnc = encodeURIComponent(type || '');
                this.openModal(`
                    <h2 class="text-xl font-bold mb-2 theme-text-heading">${utils.t('export_calendar')}</h2>
                    <p class="text-sm theme-text-sub mb-4">${type ? utils.t(type) : (title || '')}</p>
                    <label class="text-xs font-bold uppercase tracking-wider mb-2 block theme-text-sub">${utils.t('reminder_time')}</label>
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="ui.applyReminderCalendar('${typeEnc}','${dateEnc}','${titleEnc}', null)" class="p-3 rounded-xl border theme-border font-medium text-sm hover:bg-slate-50">${utils.t('rem_none')}</button>
                        <button onclick="ui.applyReminderCalendar('${typeEnc}','${dateEnc}','${titleEnc}', 0)" class="p-3 rounded-xl border theme-border font-medium text-sm hover:bg-slate-50">${utils.t('rem_day')}</button>
                        <button onclick="ui.applyReminderCalendar('${typeEnc}','${dateEnc}','${titleEnc}', 7)" class="p-3 rounded-xl border theme-border font-medium text-sm hover:bg-slate-50">${utils.t('rem_1w')}</button>
                        <button onclick="ui.applyReminderCalendar('${typeEnc}','${dateEnc}','${titleEnc}', 30)" class="p-3 rounded-xl border theme-border font-medium text-sm hover:bg-slate-50">${utils.t('rem_1m')}</button>
                    </div>
                `);
            },

            applyReminderCalendar(typeEnc, dateEnc, titleEnc, alarmDays) {
                const type = decodeURIComponent(typeEnc || '');
                const dateIso = decodeURIComponent(dateEnc || '');
                const title = decodeURIComponent(titleEnc || '');
                if (type) utils.exportCalendar(type, alarmDays);
                else utils.exportDateCalendar(title, dateIso, alarmDays);
                this.closeModal();
            },
            
            openAboutModal() {
                const lang = store.data.settings.language || 'en';
                const isZh = lang === 'zh';
                const title = isZh ? 'FuelMate（本地優先 PWA）' : 'FuelMate (Local-first PWA)';
                const subtitle = isZh ? 'v4.0（IndexedDB 版本）' : 'v4.0 (IndexedDB Edition)';
                const intro = isZh
                    ? 'FuelMate 將所有用車開支與提醒集中管理：加油、維修、停車、罰單、證件到期與輪胎保養。資料本地優先、可離線使用，並支援備份與匯入。'
                    : 'FuelMate brings all car costs and reminders into one place—fuel, maintenance, parking, fines, document expiry, and tire care. Local-first by default, works offline, with backup and import support.';
                const featuresTitle = isZh ? '主要功能' : 'Key Features';
                const specsTitle = isZh ? '重點設計' : 'Design Notes';
                const footer = isZh ? '提示：請定期備份；清除瀏覽器快取會刪除本機資料。' : 'Tip: back up regularly; clearing browser cache can remove local data.';
                const features = isZh
                    ? [
                        '多車管理：里程、車型與保養間隔分車儲存',
                        '加油記錄：單價/金額/升數互算；Full/Partial 油耗',
                        '維修/保養/停車/罰單：統一搜尋與日期篩選',
                        '輪胎管理：四輪獨立追蹤、更換/換位、胎壓/胎紋',
                        '提醒中心：輪胎/證件/定期保養整合，支援延後/完成/加入日曆',
                        'JSON/CSV 匯出；匯入前自動備份 + 匯入摘要'
                    ]
                    : [
                        'Multi-vehicle profiles with per-car intervals',
                        'Fuel logs with smart Price/Cost/Volume and Full/Partial efficiency',
                        'Maintenance/Parking/Fines with unified search & date filters',
                        'Tire management: per-tire tracking, replace/rotate, pressure & tread',
                        'Reminder Center with snooze/done and calendar export',
                        'JSON/CSV export plus safer import with auto-backup and summary'
                    ];
                const specs = isZh
                    ? [
                        '本地優先：IndexedDB 儲存（無需登入/伺服器）',
                        'PWA 可安裝到主畫面；離線仍可查看/新增'
                    ]
                    : [
                        'Local-first storage via IndexedDB (no login, no server required)',
                        'Installable PWA; works offline for viewing and adding logs'
                    ];
                

                 this.openModal(`
                    <div class="text-center p-4">
                        <div class="w-20 h-20 mx-auto rounded-3xl grad-teal flex items-center justify-center text-white shadow-xl mb-4">
                            <span class="material-icons text-5xl">local_gas_station</span>
                        </div>
                        <h2 class="text-2xl font-black theme-text-heading mb-1">${title}</h2>
                        <div class="text-sm theme-text-sub mb-3">${subtitle}</div>
                        <div class="text-sm theme-text-sub mb-6">${intro}</div>
                        
                        <div class="text-left space-y-4 text-sm theme-text-heading bg-slate-50 dark:bg-slate-800 p-4 rounded-xl">
                            <h3 class="font-bold border-b pb-2 mb-2">${featuresTitle}</h3>
                            <ul class="list-disc pl-5 space-y-1 opacity-80">
                                ${features.map(f => `<li>${f}</li>`).join('')}
                            </ul>
                            
                            <h3 class="font-bold border-b pb-2 mb-2 mt-4">${specsTitle}</h3>
                            <ul class="list-disc pl-5 space-y-1 opacity-80">
                                ${specs.map(s => `<li>${s}</li>`).join('')}
                            </ul>
                        </div>
                        <div class="mt-6 text-xs text-slate-400">${footer}</div>
                    </div>
                 `);
            },

            openInstallGuide() {
                const lang = store.data.settings.language || 'en';
                const isZh = lang === 'zh';
                const title = utils.t('install_guide');
                const intro = isZh
                    ? '將 FuelMate 加到主畫面，可像 App 一樣開啟，離線也能用。'
                    : 'Add FuelMate to your home screen for an app-like experience with offline access.';
                const stepsTitle = isZh ? '安裝步驟' : 'Steps';
                const steps = isZh
                    ? [
                        'iOS 用「分享」→「加入主畫面」安裝',
                        'Android 用「瀏覽器選單」→「安裝應用程式」'
                    ]
                    : [
                        'iOS: Share → Add to Home Screen',
                        'Android: Browser menu → Install App'
                    ];
                const note = isZh
                    ? '提示：建議用主畫面圖示開啟，以保留離線能力。'
                    : 'Tip: Launch from the home screen icon to keep offline support.';
                this.openModal(`
                    <div class="p-2">
                        <h2 class="text-xl font-bold mb-2 theme-text-heading">${title}</h2>
                        <p class="text-sm theme-text-sub mb-4">${intro}</p>
                        <div class="bg-slate-50 dark:bg-slate-800 p-4 rounded-xl">
                            <div class="text-xs font-bold uppercase tracking-wider theme-text-sub mb-2">${stepsTitle}</div>
                            <ul class="list-disc pl-5 space-y-2 text-sm theme-text-heading">
                                ${steps.map(s => `<li>${s}</li>`).join('')}
                            </ul>
                        </div>
                        <div class="mt-4 text-xs text-slate-400">${note}</div>
                    </div>
                `);
            }
        };

        const router = {
            currentPage: 'dashboard',
            navigate(page) {
                this.currentPage = page;
                ui.render();
            }
        };

        window.ui = ui;
        window.store = store;
        window.utils = utils;
        window.router = router;

        window.addEventListener('DOMContentLoaded', () => ui.init());
        document.addEventListener('click', (event) => {
            if (event.target.closest('a')) return;
            const target = event.target.closest('[data-action="edit-log"]');
            if (!target) return;
            event.preventDefault();
            const id = target.getAttribute('data-log-id');
            if (!id) return;
            ui.openLogEditorById(id);
        }, true);

        const setPieActive = (label) => {
            const list = document.getElementById('pie-breakdown');
            if (list) {
                const items = list.querySelectorAll('[data-pie-item]');
                items.forEach((el) => {
                    const isActive = el.getAttribute('data-pie-item') === label;
                    el.style.fontSize = isActive ? '13px' : '11px';
                    el.style.fontWeight = isActive ? '800' : '600';
                    el.style.opacity = isActive ? '1' : '0.6';
                });
            }
            const slices = document.querySelectorAll('path[data-pie-label]');
            slices.forEach((el) => {
                const isActive = el.getAttribute('data-pie-label') === label;
                el.style.opacity = isActive ? '1' : '0.35';
            });
        };

        const clearPieActive = () => {
            const list = document.getElementById('pie-breakdown');
            if (list) {
                const items = list.querySelectorAll('[data-pie-item]');
                items.forEach((el) => {
                    el.style.fontSize = '';
                    el.style.fontWeight = '';
                    el.style.opacity = '';
                });
            }
            const slices = document.querySelectorAll('path[data-pie-label]');
            slices.forEach((el) => {
                el.style.opacity = '';
            });
        };

        document.addEventListener('click', (event) => {
            const rect = event.target.closest('rect[data-label-id]');
            if (!rect) return;
            const svg = rect.closest('svg');
            if (!svg) return;
            const label = rect.getAttribute('data-label') || '';
            const value = rect.getAttribute('data-value') || '';
            const month = rect.getAttribute('data-month') || '';
            let tip = document.getElementById('chart-tooltip');
            if (!tip) {
                tip = document.createElement('div');
                tip.id = 'chart-tooltip';
                tip.style.position = 'fixed';
                tip.style.zIndex = '60';
                tip.style.background = 'var(--bg-card)';
                tip.style.color = 'var(--text-heading)';
                tip.style.border = '1px solid var(--border-color)';
                tip.style.boxShadow = '0 10px 25px rgba(15, 23, 42, 0.15)';
                tip.style.borderRadius = '12px';
                tip.style.padding = '8px 10px';
                tip.style.fontSize = '12px';
                tip.style.fontWeight = '700';
                tip.style.pointerEvents = 'none';
                tip.style.opacity = '0';
                tip.style.transition = 'opacity 150ms ease';
                document.body.appendChild(tip);
            }
            tip.innerHTML = `
                <div style="font-size:10px; font-weight:600; color: var(--text-sub);">${month}月</div>
                <div style="font-size:12px; font-weight:800;">${label}</div>
                <div style="font-size:13px; font-weight:800; margin-top:2px;">${value}</div>
            `;
            const rectBox = rect.getBoundingClientRect();
            const tipBox = tip.getBoundingClientRect();
            const top = Math.max(12, rectBox.top - tipBox.height - 8);
            const left = Math.min(
                window.innerWidth - tipBox.width - 12,
                Math.max(12, rectBox.left + rectBox.width / 2 - tipBox.width / 2)
            );
            tip.style.top = `${top}px`;
            tip.style.left = `${left}px`;
            requestAnimationFrame(() => {
                tip.style.opacity = '1';
            });
        });

        const setMonthlySeriesActive = (series) => {
            const bars = document.querySelectorAll('rect[data-series]');
            bars.forEach((el) => {
                const isActive = el.getAttribute('data-series') === series;
                el.style.opacity = isActive ? '1' : '0.35';
            });
        };

        const setMonthlyMonthActive = (monthIndex) => {
            const bars = document.querySelectorAll('rect[data-month-index]');
            bars.forEach((el) => {
                const isActive = el.getAttribute('data-month-index') === String(monthIndex);
                el.style.opacity = isActive ? '1' : '0.35';
            });
        };

        const clearMonthlyHighlight = () => {
            const bars = document.querySelectorAll('rect[data-series], rect[data-month-index]');
            bars.forEach((el) => {
                el.style.opacity = '';
            });
        };

        document.addEventListener('click', (event) => {
            const slice = event.target.closest('path[data-pie-label]');
            if (!slice) return;
            const label = slice.getAttribute('data-pie-label') || '';
            const value = slice.getAttribute('data-pie-value') || '';
            setPieActive(label);
            let tip = document.getElementById('chart-tooltip');
            if (!tip) {
                tip = document.createElement('div');
                tip.id = 'chart-tooltip';
                tip.style.position = 'fixed';
                tip.style.zIndex = '60';
                tip.style.background = 'var(--bg-card)';
                tip.style.color = 'var(--text-heading)';
                tip.style.border = '1px solid var(--border-color)';
                tip.style.boxShadow = '0 10px 25px rgba(15, 23, 42, 0.15)';
                tip.style.borderRadius = '12px';
                tip.style.padding = '8px 10px';
                tip.style.fontSize = '12px';
                tip.style.fontWeight = '700';
                tip.style.pointerEvents = 'none';
                tip.style.opacity = '0';
                tip.style.transition = 'opacity 150ms ease';
                document.body.appendChild(tip);
            }
            tip.innerHTML = `
                <div style="font-size:12px; font-weight:800;">${label}</div>
                <div style="font-size:13px; font-weight:800; margin-top:2px;">${value}</div>
            `;
            const tipBox = tip.getBoundingClientRect();
            const top = Math.max(12, event.clientY - tipBox.height - 12);
            const left = Math.min(
                window.innerWidth - tipBox.width - 12,
                Math.max(12, event.clientX - tipBox.width / 2)
            );
            tip.style.top = `${top}px`;
            tip.style.left = `${left}px`;
            requestAnimationFrame(() => {
                tip.style.opacity = '1';
            });
        });

        document.addEventListener('click', (event) => {
            const btn = event.target.closest('[data-action="reminder-calendar"]');
            if (!btn) return;
            const title = decodeURIComponent(btn.getAttribute('data-title') || '');
            const dateIso = btn.getAttribute('data-date') || '';
            const type = btn.getAttribute('data-type') || '';
            ui.openReminderCalendarSelector({ title, dateIso, type });
        });

        document.addEventListener('click', (event) => {
            const item = event.target.closest('[data-pie-item]');
            if (!item) return;
            const label = item.getAttribute('data-pie-item') || '';
            const value = item.getAttribute('data-pie-value') || '';
            setPieActive(label);
            const slice = document.querySelector(`path[data-pie-label="${label}"]`);
            const box = slice ? slice.getBoundingClientRect() : item.getBoundingClientRect();
            let tip = document.getElementById('chart-tooltip');
            if (!tip) {
                tip = document.createElement('div');
                tip.id = 'chart-tooltip';
                tip.style.position = 'fixed';
                tip.style.zIndex = '60';
                tip.style.background = 'var(--bg-card)';
                tip.style.color = 'var(--text-heading)';
                tip.style.border = '1px solid var(--border-color)';
                tip.style.boxShadow = '0 10px 25px rgba(15, 23, 42, 0.15)';
                tip.style.borderRadius = '12px';
                tip.style.padding = '8px 10px';
                tip.style.fontSize = '12px';
                tip.style.fontWeight = '700';
                tip.style.pointerEvents = 'none';
                tip.style.opacity = '0';
                tip.style.transition = 'opacity 150ms ease';
                document.body.appendChild(tip);
            }
            tip.innerHTML = `
                <div style="font-size:12px; font-weight:800;">${label}</div>
                <div style="font-size:13px; font-weight:800; margin-top:2px;">${value}</div>
            `;
            const tipBox = tip.getBoundingClientRect();
            const top = Math.max(12, box.top - tipBox.height - 12);
            const left = Math.min(
                window.innerWidth - tipBox.width - 12,
                Math.max(12, box.left + box.width / 2 - tipBox.width / 2)
            );
            tip.style.top = `${top}px`;
            tip.style.left = `${left}px`;
            requestAnimationFrame(() => {
                tip.style.opacity = '1';
            });
        });

        document.addEventListener('click', (event) => {
            if (event.target.closest('rect[data-label-id]')) return;
            if (event.target.closest('path[data-pie-label]')) return;
            if (event.target.closest('[data-pie-item]')) return;
            const tip = document.getElementById('chart-tooltip');
            if (!tip) return;
            tip.style.opacity = '0';
            setTimeout(() => {
                if (tip.parentNode) tip.parentNode.removeChild(tip);
            }, 160);
            clearPieActive();
            clearMonthlyHighlight();
        });

        document.addEventListener('click', (event) => {
            const legend = event.target.closest('[data-series]');
            if (!legend) return;
            const series = legend.getAttribute('data-series');
            if (!series) return;
            setMonthlySeriesActive(series);
        });

        document.addEventListener('click', (event) => {
            const bar = event.target.closest('rect[data-month-index]');
            if (!bar) return;
            const monthIndex = bar.getAttribute('data-month-index');
            if (!monthIndex) return;
            setMonthlyMonthActive(monthIndex);
        });

        document.addEventListener('mousemove', (event) => {
            const bar = event.target.closest('rect[data-month-index]');
            if (!bar) return;
            const monthIndex = bar.getAttribute('data-month-index');
            if (!monthIndex) return;
            setMonthlyMonthActive(monthIndex);
        });
        
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js').catch(err => console.error('Service Worker registration failed', err));
            });
        }
    </script>
</body>
</html>
